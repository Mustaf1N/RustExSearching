<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RustEx Searching</title>
<link rel="icon" href="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" type="image/svg+xml">
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Roboto+Condensed:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--rust-orange:#cd412b;--rust-red:#a83222;--rust-dark:#1a1a1a;--rust-darker:#0f0f0f;--rust-darkest:#0a0a0a;--rust-metal:#2a2a2a;--rust-metal-light:#3a3a3a;--rust-light:#e0e0e0}
body{font-family:'Roboto',sans-serif;background:var(--rust-darkest);color:var(--rust-light);min-height:100vh}
body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:url('https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=1920&q=80') center/cover fixed;opacity:0.06;z-index:-2;pointer-events:none}
body::after{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(10,10,10,0.97) 0%,rgba(15,15,15,0.95) 50%,rgba(10,10,10,0.97) 100%);z-index:-1;pointer-events:none}
.rust-font{font-family:'Russo One',sans-serif;text-transform:uppercase;letter-spacing:3px}
.rust-font-condensed{font-family:'Roboto Condensed',sans-serif;text-transform:uppercase;letter-spacing:2px}
.rust-btn{background:linear-gradient(180deg,#cd412b 0%,#8b2216 50%,#6d1a11 100%);border:none;padding:14px 28px;color:#fff;font-family:'Roboto Condensed',sans-serif;font-weight:700;text-transform:uppercase;letter-spacing:2px;cursor:pointer;transition:all 0.2s;position:relative;box-shadow:0 4px 0 #4a0f0a,0 6px 20px rgba(0,0,0,0.5),inset 0 1px 0 rgba(255,255,255,0.2);text-shadow:0 2px 4px rgba(0,0,0,0.5);border-radius:4px}
.rust-btn:hover{transform:translateY(-2px);box-shadow:0 6px 0 #4a0f0a,0 8px 25px rgba(205,65,43,0.4),inset 0 1px 0 rgba(255,255,255,0.2);background:linear-gradient(180deg,#e04a33 0%,#a82a1c 50%,#7d1f14 100%)}
.rust-btn:active{transform:translateY(2px);box-shadow:0 2px 0 #4a0f0a,0 3px 10px rgba(0,0,0,0.5)}
.rust-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.rust-btn-secondary{background:linear-gradient(180deg,#3a3a3a 0%,#2a2a2a 50%,#1a1a1a 100%);box-shadow:0 4px 0 #111,0 6px 20px rgba(0,0,0,0.5),inset 0 1px 0 rgba(255,255,255,0.1)}
.rust-btn-secondary:hover{background:linear-gradient(180deg,#4a4a4a 0%,#3a3a3a 50%,#2a2a2a 100%);box-shadow:0 6px 0 #111,0 8px 25px rgba(0,0,0,0.4)}
.rust-btn-sm{padding:8px 16px;font-size:12px}
.rust-input{background:linear-gradient(180deg,#1a1a1a 0%,#252525 100%);border:2px solid #3a3a3a;padding:14px 18px;color:#e0e0e0;width:100%;transition:all 0.2s;font-size:15px;box-shadow:inset 0 2px 8px rgba(0,0,0,0.5);border-radius:4px}
.rust-input:focus{outline:none;border-color:var(--rust-orange);box-shadow:inset 0 2px 8px rgba(0,0,0,0.5),0 0 15px rgba(205,65,43,0.3)}
.rust-input::placeholder{color:#666}
.rust-select{background:linear-gradient(180deg,#1a1a1a 0%,#252525 100%);border:2px solid #3a3a3a;padding:14px 18px;color:#e0e0e0;width:100%;font-size:15px;box-shadow:inset 0 2px 8px rgba(0,0,0,0.5);border-radius:4px;cursor:pointer}
.rust-select:focus{outline:none;border-color:var(--rust-orange)}
.rust-card{background:linear-gradient(180deg,#252525 0%,#1a1a1a 100%);border:2px solid #333;position:relative;box-shadow:0 10px 40px rgba(0,0,0,0.5);border-radius:8px;overflow:hidden}
.rust-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#8b2216,#cd412b,#8b2216);z-index:10}
.theme-orange::before{background:linear-gradient(90deg,#8b2216,#cd412b,#8b2216)}
.theme-red::before{background:linear-gradient(90deg,#7f1d1d,#dc2626,#7f1d1d)}
.theme-pink::before{background:linear-gradient(90deg,#831843,#ec4899,#831843)}
.theme-purple::before{background:linear-gradient(90deg,#581c87,#a855f7,#581c87)}
.theme-blue::before{background:linear-gradient(90deg,#1e3a8a,#3b82f6,#1e3a8a)}
.theme-cyan::before{background:linear-gradient(90deg,#155e75,#06b6d4,#155e75)}
.theme-green::before{background:linear-gradient(90deg,#14532d,#22c55e,#14532d)}
.theme-yellow::before{background:linear-gradient(90deg,#713f12,#eab308,#713f12)}
.theme-gold::before{background:linear-gradient(90deg,#78350f,#f59e0b,#78350f)}
.theme-gray::before{background:linear-gradient(90deg,#374151,#6b7280,#374151)}
.metal-header{background:linear-gradient(180deg,#1a1a1a 0%,#0f0f0f 100%);border-bottom:3px solid #333;box-shadow:0 4px 20px rgba(0,0,0,0.5);position:relative}
.metal-header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,transparent,var(--rust-orange),transparent)}
.nav-link{padding:16px 20px;cursor:pointer;transition:all 0.2s;border-bottom:3px solid transparent;text-transform:uppercase;letter-spacing:1px;font-size:12px;font-family:'Roboto Condensed',sans-serif;font-weight:700;color:#888;position:relative;display:flex;align-items:center;gap:8px}
.nav-link:hover{color:var(--rust-orange);background:rgba(205,65,43,0.1)}
.nav-link.active{color:var(--rust-orange);border-bottom-color:var(--rust-orange);background:rgba(205,65,43,0.15)}
.listing-card{transition:all 0.3s;cursor:pointer}
.listing-card:hover{transform:translateY(-5px);box-shadow:0 20px 50px rgba(0,0,0,0.6),0 0 30px rgba(205,65,43,0.15)}
.listing-card.frozen{opacity:0.6;filter:grayscale(0.5)}
.category-badge{font-size:10px;padding:5px 10px;text-transform:uppercase;letter-spacing:1px;font-weight:700;font-family:'Roboto Condensed',sans-serif;border-radius:4px}
.admin-badge{background:linear-gradient(135deg,#f59e0b,#d97706);color:#000;font-weight:700;padding:4px 12px;border-radius:4px;font-size:11px;text-transform:uppercase;letter-spacing:1px;box-shadow:0 0 20px rgba(245,158,11,0.5)}
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(5px)}
.modal.show{display:flex}
.chat-message{max-width:75%;padding:12px 16px;margin:8px 0;position:relative}
.chat-message.sent{background:linear-gradient(135deg,#cd412b,#a83222);margin-left:auto;border-radius:16px 16px 4px 16px}
.chat-message.received{background:linear-gradient(135deg,#3a3a3a,#2a2a2a);margin-right:auto;border-radius:16px 16px 16px 4px}
.avatar{width:50px;height:50px;border-radius:50%;object-fit:cover;border:3px solid var(--rust-orange);box-shadow:0 4px 15px rgba(0,0,0,0.4)}
.avatar-lg{width:120px;height:120px;border-width:4px}
.like-btn{display:flex;align-items:center;gap:6px;padding:8px 14px;border-radius:20px;cursor:pointer;transition:all 0.2s;font-size:13px;font-weight:700}
.like-btn.liked{background:rgba(239,68,68,0.2);color:#ef4444}
.like-btn:not(.liked){background:rgba(255,255,255,0.1);color:#888}
.like-btn:not(.liked):hover{background:rgba(239,68,68,0.1);color:#ef4444}
.social-btn{width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.3s;box-shadow:0 4px 15px rgba(0,0,0,0.3)}
.social-btn:hover{transform:scale(1.1)}
.tg-btn{background:linear-gradient(135deg,#0088cc,#006699)}
.vk-btn{background:linear-gradient(135deg,#4c75a3,#3d5f85)}
.toast{position:fixed;bottom:30px;right:30px;padding:18px 28px;border-radius:4px;z-index:2000;transform:translateX(150%);transition:transform 0.3s;font-family:'Roboto Condensed',sans-serif;font-weight:700;text-transform:uppercase;letter-spacing:1px;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
.toast.show{transform:translateX(0)}
.toast.success{background:linear-gradient(135deg,#22c55e,#16a34a)}
.toast.error{background:linear-gradient(135deg,#ef4444,#dc2626)}
.unread-badge{background:linear-gradient(135deg,#cd412b,#a83222);color:white;font-size:10px;min-width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700}
.notification-dot{width:8px;height:8px;background:#ef4444;border-radius:50%;position:absolute;top:12px;right:12px}
.glow-text{text-shadow:0 0 20px rgba(205,65,43,0.5)}
.section-title{position:relative;display:inline-block}
.section-title::after{content:'';position:absolute;bottom:-8px;left:0;width:60px;height:3px;background:linear-gradient(90deg,var(--rust-orange),transparent)}
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-track{background:#0a0a0a}
::-webkit-scrollbar-thumb{background:#333;border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:#444}
.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(10,10,10,0.98);z-index:3000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px}
.loading-spinner{width:50px;height:50px;border:4px solid #333;border-top-color:var(--rust-orange);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.animate-pulse{animation:pulse 2s infinite}
.file-upload{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;border:2px dashed #3a3a3a;border-radius:8px;padding:24px;cursor:pointer;transition:all 0.3s;background:linear-gradient(180deg,#1a1a1a 0%,#252525 100%)}
.file-upload:hover{border-color:var(--rust-orange)}
.file-upload input{position:absolute;inset:0;opacity:0;cursor:pointer}
.online-dot{width:10px;height:10px;background:#22c55e;border-radius:50%;border:2px solid #1a1a1a}
.dropdown{position:relative;display:inline-block}
.dropdown-menu{position:absolute;top:100%;right:0;background:#1a1a1a;border:1px solid #333;border-radius:8px;min-width:200px;z-index:100;display:none;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
.dropdown-menu.show{display:block}
.dropdown-item{padding:12px 16px;cursor:pointer;transition:background 0.2s;font-size:14px}
.dropdown-item:hover{background:#2a2a2a}
.back-btn{display:inline-flex;align-items:center;gap:8px;color:#888;cursor:pointer;transition:color 0.2s;margin-bottom:24px;font-size:14px}
.back-btn:hover{color:var(--rust-orange)}
.frozen-banner{background:linear-gradient(135deg,#1e40af,#1d4ed8);padding:16px;border-radius:8px;margin-bottom:16px}
</style>
</head>
<body>
<div id="loadingOverlay" class="loading-overlay">
<img src="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" alt="RustEx" class="h-16 animate-pulse">
<div class="loading-spinner"></div>
<div class="rust-font text-sm" style="color:var(--rust-orange)">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>
<div id="app" style="opacity:0;transition:opacity 0.5s">
<header class="sticky top-0 z-50 metal-header">
<div class="max-w-7xl mx-auto px-4">
<div class="flex items-center justify-between h-16">
<div class="flex items-center gap-3 cursor-pointer" onclick="showPage('listings')">
<img src="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" alt="RustEx" class="h-10">
<div class="hidden sm:block">
<span class="rust-font text-xl glow-text" style="color:var(--rust-orange)">RustEx</span>
<span class="rust-font text-xl text-white">Searching</span>
</div>
</div>
<nav class="flex items-center h-full" id="mainNav">
<div class="nav-link active" onclick="showPage('listings')" data-page="listings">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg>
<span class="hidden md:inline">–û–±—ä—è–≤–ª–µ–Ω–∏—è</span>
</div>
<div class="nav-link" onclick="showPage('messages')" data-page="messages" id="messagesNav" style="display:none">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z"/></svg>
<span class="hidden md:inline">–°–æ–æ–±—â–µ–Ω–∏—è</span>
<span class="unread-badge" id="unreadBadge" style="display:none">0</span>
</div>
<div class="nav-link relative" onclick="showPage('notifications')" data-page="notifications" id="notificationsNav" style="display:none">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/></svg>
<span class="hidden md:inline">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
<div class="notification-dot" id="notificationDot" style="display:none"></div>
</div>
<div class="nav-link" onclick="showPage('profile')" data-page="profile" id="profileNav" style="display:none">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 10a4 4 0 100-8 4 4 0 000 8zm-7 8a7 7 0 1114 0H3z"/></svg>
<span class="hidden md:inline">–ü—Ä–æ—Ñ–∏–ª—å</span>
</div>
</nav>
<div class="flex items-center gap-3">
<div id="authButtons">
<button class="rust-btn rust-btn-sm" onclick="showModal('loginModal')">–í–æ–π—Ç–∏</button>
</div>
<div id="userMenu" style="display:none" class="flex items-center gap-3 cursor-pointer" onclick="showPage('profile')">
<div class="relative">
<img id="headerAvatar" src="" class="w-10 h-10 rounded-full border-2 border-orange-600">
<div class="online-dot absolute bottom-0 right-0"></div>
</div>
</div>
</div>
</div>
</div>
</header>
<main class="max-w-7xl mx-auto px-4 py-8">
<div id="listingsPage">
<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
<div>
<h1 class="rust-font text-3xl mb-2 glow-text section-title" style="color:var(--rust-orange)">–û–±—ä—è–≤–ª–µ–Ω–∏—è</h1>
<p class="text-gray-400 mt-4">–ù–∞–π–¥–∏ —Ç–∏–º–º–µ–π—Ç–æ–≤ –¥–ª—è RustEx Remake</p>
</div>
<div class="flex gap-3">
<div class="dropdown">
<button class="rust-btn rust-btn-secondary rust-btn-sm" onclick="toggleDropdown('sortDropdown')">
<svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M3 3a1 1 0 000 2h11a1 1 0 100-2H3zM3 7a1 1 0 000 2h7a1 1 0 100-2H3zM3 11a1 1 0 100 2h4a1 1 0 100-2H3z"/></svg>
–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
</button>
<div class="dropdown-menu" id="sortDropdown">
<div class="dropdown-item" onclick="setSorting('new')">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</div>
<div class="dropdown-item" onclick="setSorting('old')">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</div>
<div class="dropdown-item" onclick="setSorting('likes_desc')">–ü–æ –ª–∞–π–∫–∞–º ‚Üì</div>
<div class="dropdown-item" onclick="setSorting('likes_asc')">–ü–æ –ª–∞–π–∫–∞–º ‚Üë</div>
</div>
</div>
<button class="rust-btn rust-btn-sm" onclick="createListing()" id="createListingBtn" style="display:none">
<svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"/></svg>
–°–æ–∑–¥–∞—Ç—å
</button>
</div>
</div>
<div class="flex flex-wrap gap-2 mb-6">
<button class="category-filter px-4 py-2 rounded text-sm bg-orange-600 text-white" data-category="all" onclick="filterCategory('all')">–í—Å–µ</button>
<button class="category-filter px-4 py-2 rounded text-sm bg-zinc-800 text-gray-300" data-category="team" onclick="filterCategory('team')">–í —Ç–∏–º–º—É</button>
<button class="category-filter px-4 py-2 rounded text-sm bg-zinc-800 text-gray-300" data-category="teammate" onclick="filterCategory('teammate')">–ù–∞–ø–∞—Ä–Ω–∏–∫–∞</button>
<button class="category-filter px-4 py-2 rounded text-sm bg-zinc-800 text-gray-300" data-category="clan_search" onclick="filterCategory('clan_search')">–ò—â—É –∫–ª–∞–Ω</button>
<button class="category-filter px-4 py-2 rounded text-sm bg-zinc-800 text-gray-300" data-category="clan_recruit" onclick="filterCategory('clan_recruit')">–ù–∞–±–æ—Ä –≤ –∫–ª–∞–Ω</button>
<button class="category-filter px-4 py-2 rounded text-sm bg-zinc-800 text-gray-300" data-category="farmer" onclick="filterCategory('farmer')">–§–∞—Ä–º–µ—Ä</button>
<button class="category-filter px-4 py-2 rounded text-sm bg-zinc-800 text-gray-300" data-category="pvp" onclick="filterCategory('pvp')">–ü–í–ü—à–µ—Ä</button>
</div>
<div id="listingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
<div id="listingsEmpty" class="text-center py-20" style="display:none">
<svg class="w-20 h-20 mx-auto mb-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"/></svg>
<h3 class="rust-font text-xl mb-2 text-gray-400">–û–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</h3>
<p class="text-gray-500">–ë—É–¥—å –ø–µ—Ä–≤—ã–º!</p>
</div>
<div id="listingsLoading" class="text-center py-20">
<div class="loading-spinner mx-auto mb-4"></div>
<p class="text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>
</div>
<div id="messagesPage" style="display:none">
<div class="back-btn" onclick="showPage('listings')">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/></svg>
–ù–∞ –≥–ª–∞–≤–Ω—É—é
</div>
<h1 class="rust-font text-3xl mb-6 glow-text section-title" style="color:var(--rust-orange)">–°–æ–æ–±—â–µ–Ω–∏—è</h1>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
<div class="rust-card p-4">
<h3 class="font-bold mb-4 text-gray-300 rust-font-condensed">–î–∏–∞–ª–æ–≥–∏</h3>
<div id="chatsList" class="space-y-2 max-h-96 overflow-y-auto"></div>
</div>
<div class="lg:col-span-2 rust-card flex flex-col" style="height:500px">
<div id="chatHeader" class="p-4 border-b border-zinc-700 flex items-center gap-3" style="display:none">
<img id="chatAvatar" src="" class="w-10 h-10 rounded-full border-2 border-zinc-600">
<div class="flex-1">
<div id="chatName" class="font-bold"></div>
<div id="chatNick" class="text-xs text-gray-400"></div>
</div>
</div>
<div id="chatMessages" class="flex-1 p-4 overflow-y-auto"></div>
<div id="chatInput" class="p-4 border-t border-zinc-700" style="display:none">
<div class="flex gap-2">
<input type="text" id="messageInput" class="rust-input flex-1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter')sendMessage()">
<button class="rust-btn px-4" onclick="sendMessage()">
<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/></svg>
</button>
</div>
</div>
<div id="chatEmpty" class="flex-1 flex items-center justify-center text-gray-500">
<div class="text-center">
<svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z"/></svg>
<p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥</p>
</div>
</div>
</div>
</div>
</div>
<div id="notificationsPage" style="display:none">
<div class="back-btn" onclick="showPage('listings')">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/></svg>
–ù–∞ –≥–ª–∞–≤–Ω—É—é
</div>
<div class="flex justify-between items-center mb-6">
<h1 class="rust-font text-3xl glow-text section-title" style="color:var(--rust-orange)">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h1>
<button class="rust-btn rust-btn-secondary rust-btn-sm" onclick="markAllNotificationsRead()">–ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ</button>
</div>
<div id="notificationsList" class="space-y-3"></div>
<div id="notificationsEmpty" class="text-center py-20 text-gray-500" style="display:none">
<svg class="w-16 h-16 mx-auto mb-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6z"/></svg>
<p>–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
</div>
</div>
<div id="profilePage" style="display:none">
<div class="back-btn" onclick="showPage('listings')">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/></svg>
–ù–∞ –≥–ª–∞–≤–Ω—É—é
</div>
<div class="rust-card p-6 mb-6">
<div class="flex flex-col md:flex-row gap-6 items-start">
<div class="relative">
<img id="profileAvatar" src="" class="avatar avatar-lg">
<label class="absolute bottom-1 right-1 w-8 h-8 bg-orange-600 rounded-full flex items-center justify-center cursor-pointer hover:bg-orange-500">
<svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z"/></svg>
<input type="file" accept="image/*" class="hidden" onchange="uploadAvatar(event)">
</label>
</div>
<div class="flex-1">
<div class="flex items-center gap-3 mb-2">
<h2 id="profileUsername" class="rust-font text-2xl glow-text" style="color:var(--rust-orange)"></h2>
<span id="adminBadge" class="admin-badge" style="display:none">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
</div>
<div class="flex flex-wrap items-center gap-4 text-sm text-gray-400 mb-4">
<span class="flex items-center gap-1">
<svg class="w-4 h-4 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/></svg>
<span id="profileNick">-</span>
</span>
<span class="flex items-center gap-1">
<svg class="w-4 h-4 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1z"/></svg>
–° –Ω–∞–º–∏ —Å <span id="profileJoined"></span>
</span>
</div>
<div class="flex gap-2 mb-4" id="profileSocials"></div>
<p id="profileDesc" class="text-gray-300 text-sm"></p>
</div>
<div class="flex flex-col gap-2">
<button class="rust-btn rust-btn-sm" onclick="showModal('editProfileModal')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
<button class="rust-btn rust-btn-secondary rust-btn-sm" onclick="logout()">–í—ã–π—Ç–∏</button>
</div>
</div>
</div>
<div id="adminPanel" style="display:none" class="rust-card p-6 mb-6">
<h3 class="rust-font text-xl mb-4" style="color:var(--rust-orange)">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label class="block text-sm mb-2 text-gray-400">–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
<div class="flex gap-2">
<input type="text" id="adminDeleteUser" class="rust-input" placeholder="–ù–∏–∫ –∏–ª–∏ email">
<button class="rust-btn rust-btn-sm" onclick="adminDeleteUser()">–£–¥–∞–ª–∏—Ç—å</button>
</div>
</div>
<div>
<label class="block text-sm mb-2 text-gray-400">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</label>
<div class="text-sm text-gray-400">
<div>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <span id="adminUsersCount">0</span></div>
<div>–û–±—ä—è–≤–ª–µ–Ω–∏–π: <span id="adminListingsCount">0</span></div>
</div>
</div>
</div>
</div>
<h3 class="rust-font text-xl mb-4 section-title" style="color:var(--rust-orange)">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h3>
<div id="myListingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
</div>
<div id="viewListingPage" style="display:none">
<div class="back-btn" onclick="showPage('listings')">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/></svg>
–ù–∞–∑–∞–¥
</div>
<div id="listingDetail" class="rust-card"></div>
</div>
<div id="viewProfilePage" style="display:none">
<div class="back-btn" onclick="showPage('listings')">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/></svg>
–ù–∞–∑–∞–¥
</div>
<div class="rust-card p-6 mb-6">
<div class="flex flex-col md:flex-row gap-6 items-start">
<img id="viewProfileAvatar" src="" class="avatar avatar-lg">
<div class="flex-1">
<div class="flex items-center gap-3 mb-2">
<h2 id="viewProfileUsername" class="rust-font text-2xl glow-text" style="color:var(--rust-orange)"></h2>
<span id="viewAdminBadge" class="admin-badge" style="display:none">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
</div>
<div class="flex items-center gap-4 text-sm text-gray-400 mb-4">
<span class="flex items-center gap-1">
<svg class="w-4 h-4 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/></svg>
<span id="viewProfileNick">-</span>
</span>
</div>
<div class="flex gap-2 mb-4" id="viewProfileSocials"></div>
<p id="viewProfileDesc" class="text-gray-300 text-sm"></p>
</div>
<button class="rust-btn" onclick="startChatWith(viewingUserId)" id="viewProfileChatBtn">–ù–∞–ø–∏—Å–∞—Ç—å</button>
</div>
</div>
<h3 class="rust-font text-xl mb-4 section-title" style="color:var(--rust-orange)">–û–±—ä—è–≤–ª–µ–Ω–∏—è</h3>
<div id="userListingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
</div>
</main>
</div>
<div id="loginModal" class="modal">
<div class="rust-card p-8 w-full max-w-md mx-4 relative">
<h2 class="rust-font text-xl text-center mb-6 glow-text" style="color:var(--rust-orange)">–í—Ö–æ–¥</h2>
<div id="loginError" class="bg-red-900/30 border border-red-600/50 rounded p-3 mb-4 text-red-400 text-sm" style="display:none"></div>
<form onsubmit="login(event)">
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-400">Email</label>
<input type="email" id="loginEmail" class="rust-input" required placeholder="example@mail.ru">
</div>
<div class="mb-6">
<label class="block text-sm mb-2 text-gray-400">–ü–∞—Ä–æ–ª—å</label>
<input type="password" id="loginPassword" class="rust-input" required placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å">
</div>
<button type="submit" class="rust-btn w-full mb-4" id="loginBtn">–í–æ–π—Ç–∏</button>
<p class="text-center text-gray-400 text-sm">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span class="text-orange-500 cursor-pointer hover:underline" onclick="switchModal('registerModal')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></p>
</form>
<button class="absolute top-4 right-4 text-gray-500 hover:text-white text-2xl" onclick="hideModal('loginModal')">&times;</button>
</div>
</div>
<div id="registerModal" class="modal">
<div class="rust-card p-8 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto relative">
<h2 class="rust-font text-xl text-center mb-6 glow-text" style="color:var(--rust-orange)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
<div id="registerError" class="bg-red-900/30 border border-red-600/50 rounded p-3 mb-4 text-red-400 text-sm" style="display:none"></div>
<form onsubmit="register(event)">
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-400">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
<input type="text" id="regUsername" class="rust-input" required minlength="3" maxlength="20" placeholder="–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è">
<p class="text-xs text-gray-500 mt-1">–ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ç–æ–º –Ω–µ–ª—å–∑—è</p>
</div>
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-400">Email</label>
<input type="email" id="regEmail" class="rust-input" required placeholder="example@mail.ru">
</div>
<div class="mb-6">
<label class="block text-sm mb-2 text-gray-400">–ü–∞—Ä–æ–ª—å</label>
<input type="password" id="regPassword" class="rust-input" required minlength="6" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤">
</div>
<button type="submit" class="rust-btn w-full mb-4" id="regBtn">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
<p class="text-center text-gray-400 text-sm">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <span class="text-orange-500 cursor-pointer hover:underline" onclick="switchModal('loginModal')">–í–æ–π—Ç–∏</span></p>
</form>
<button class="absolute top-4 right-4 text-gray-500 hover:text-white text-2xl" onclick="hideModal('registerModal')">&times;</button>
</div>
</div>
<div id="welcomeModal" class="modal">
<div class="rust-card p-8 w-full max-w-lg mx-4 relative">
<div class="text-center mb-6">
<img src="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" alt="RustEx" class="h-16 mx-auto mb-4">
<h2 class="rust-font text-2xl glow-text" style="color:var(--rust-orange)">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
</div>
<div class="space-y-3 mb-6 text-sm">
<div class="flex items-start gap-3 p-3 bg-zinc-800/50 rounded">
<span class="text-2xl">üéÆ</span>
<div><b class="text-white">RustEx Searching</b><br><span class="text-gray-400">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–∏–º–º–µ–π—Ç–æ–≤ –≤ RustEx Remake</span></div>
</div>
<div class="flex items-start gap-3 p-3 bg-zinc-800/50 rounded">
<span class="text-2xl">üìù</span>
<div><b class="text-white">–î–æ 3 –æ–±—ä—è–≤–ª–µ–Ω–∏–π</b><br><span class="text-gray-400">–ú–æ–∂–µ—à—å —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–æ 3 –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π</span></div>
</div>
<div class="flex items-start gap-3 p-3 bg-zinc-800/50 rounded">
<span class="text-2xl">üí¨</span>
<div><b class="text-white">–û–±—â–µ–Ω–∏–µ</b><br><span class="text-gray-400">–ü–∏—à–∏ –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º –ø—Ä—è–º–æ –Ω–∞ —Å–∞–π—Ç–µ</span></div>
</div>
</div>
<button class="rust-btn w-full" onclick="hideModal('welcomeModal');showPage('profile')">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
</div>
</div>
<div id="editProfileModal" class="modal">
<div class="rust-card p-8 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto relative">
<h2 class="rust-font text-xl text-center mb-6 glow-text" style="color:var(--rust-orange)">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h2>
<form onsubmit="updateProfile(event)">
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-400">–ù–∏–∫ –≤ RustEx Remake</label>
<input type="text" id="editGameNick" class="rust-input" placeholder="–í–∞—à –Ω–∏–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ">
</div>
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-400">Telegram</label>
<input type="text" id="editTelegram" class="rust-input" placeholder="@username –∏–ª–∏ —Å—Å—ã–ª–∫–∞">
</div>
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-400">VK</label>
<input type="text" id="editVk" class="rust-input" placeholder="@username –∏–ª–∏ —Å—Å—ã–ª–∫–∞">
</div>
<div class="mb-6">
<label class="block text-sm mb-2 text-gray-400">–û —Å–µ–±–µ</label>
<textarea id="editDescription" class="rust-input" rows="3" maxlength="500" placeholder="–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ..."></textarea>
</div>
<button type="submit" class="rust-btn w-full">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</form>
<button class="absolute top-4 right-4 text-gray-500 hover:text-white text-2xl" onclick="hideModal('editProfileModal')">&times;</button>
</div>
</div>
<div id="createListingModal" class="modal">
<div class="rust-card p-8 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto relative">
<h2 class="rust-font text-xl text-center mb-6 glow-text" style="color:var(--rust-orange)">–ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
<form onsubmit="submitListing(event)">
<div class="grid grid-cols-2 gap-4 mb-4">
<div>
<label class="block text-sm mb-2 text-gray-400">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
<select id="listingCategory" class="rust-select" required>
<option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
<option value="team">–ò—â—É –≤ —Ç–∏–º–º—É</option>
<option value="teammate">–ò—â—É –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞</option>
<option value="clan_search">–ò—â—É –∫–ª–∞–Ω</option>
<option value="clan_recruit">–ù–∞–±–æ—Ä –≤ –∫–ª–∞–Ω</option>
<option value="farmer">–§–∞—Ä–º–µ—Ä</option>
<option value="pvp">–ü–í–ü—à–µ—Ä</option>
</select>
</div>
<div>
<label class="block text-sm mb-2 text-gray-400">–¢–µ–º–∞</label>
<select id="listingTheme" class="rust-select">
<option value="orange">–û—Ä–∞–Ω–∂–µ–≤–∞—è</option>
<option value="red">–ö—Ä–∞—Å–Ω–∞—è</option>
<option value="pink">–†–æ–∑–æ–≤–∞—è</option>
<option value="purple">–§–∏–æ–ª–µ—Ç–æ–≤–∞—è</option>
<option value="blue">–°–∏–Ω—è—è</option>
<option value="cyan">–ê–∫–≤–∞–º–∞—Ä–∏–Ω</option>
<option value="green">–ó–µ–ª—ë–Ω–∞—è</option>
<option value="yellow">–ñ—ë–ª—Ç–∞—è</option>
<option value="gold">–ó–æ–ª–æ—Ç–∞—è</option>
<option value="gray">–°–µ—Ä–∞—è</option>
</select>
</div>
</div>
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-400">–ù–∞–∑–≤–∞–Ω–∏–µ (–¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤)</label>
<input type="text" id="listingTitle" class="rust-input" required maxlength="20" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
</div>
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-400">–û–ø–∏—Å–∞–Ω–∏–µ (–¥–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤)</label>
<textarea id="listingDesc" class="rust-input" rows="4" required maxlength="1000" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
</div>
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-400">–§–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
<div class="file-upload" id="listingImageUpload">
<svg class="w-10 h-10 text-gray-500 mb-2" fill="currentColor" viewBox="0 0 20 20"><path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/></svg>
<span class="text-gray-400 text-sm">–ù–∞–∂–º–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞</span>
<input type="file" accept="image/*" onchange="previewListingImage(event)">
</div>
<input type="hidden" id="listingImage">
</div>
<div class="grid grid-cols-2 gap-4 mb-4">
<div>
<label class="block text-sm mb-2 text-gray-400">Telegram</label>
<input type="text" id="listingTelegram" class="rust-input" placeholder="@username">
</div>
<div>
<label class="block text-sm mb-2 text-gray-400">VK</label>
<input type="text" id="listingVk" class="rust-input" placeholder="@id –∏–ª–∏ —Å—Å—ã–ª–∫–∞">
</div>
</div>
<div class="mb-6">
<label class="block text-sm mb-2 text-gray-400">–ù–∏–∫ –≤ RustEx Remake</label>
<input type="text" id="listingNick" class="rust-input" required placeholder="–í–∞—à –Ω–∏–∫">
</div>
<button type="submit" class="rust-btn w-full" id="submitListingBtn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
</form>
<button class="absolute top-4 right-4 text-gray-500 hover:text-white text-2xl" onclick="hideModal('createListingModal')">&times;</button>
</div>
</div>
<div id="editListingModal" class="modal">
<div class="rust-card p-8 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto relative">
<h2 class="rust-font text-xl text-center mb-6 glow-text" style="color:var(--rust-orange)">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
<form onsubmit="updateListing(event)">
<input type="hidden" id="editListingId">
<div class="grid grid-cols-2 gap-4 mb-4">
<div>
<label class="block text-sm mb-2 text-gray-400">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
<select id="editListingCategory" class="rust-select" required>
<option value="team">–ò—â—É –≤ —Ç–∏–º–º—É</option>
<option value="teammate">–ò—â—É –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞</option>
<option value="clan_search">–ò—â—É –∫–ª–∞–Ω</option>
<option value="clan_recruit">–ù–∞–±–æ—Ä –≤ –∫–ª–∞–Ω</option>
<option value="farmer">–§–∞—Ä–º–µ—Ä</option>
<option value="pvp">–ü–í–ü—à–µ—Ä</option>
</select>
</div>
<div>
<label class="block text-sm mb-2 text-gray-400">–¢–µ–º–∞</label>
<select id="editListingTheme" class="rust-select">
<option value="orange">–û—Ä–∞–Ω–∂–µ–≤–∞—è</option>
<option value="red">–ö—Ä–∞—Å–Ω–∞—è</option>
<option value="pink">–†–æ–∑–æ–≤–∞—è</option>
<option value="purple">–§–∏–æ–ª–µ—Ç–æ–≤–∞—è</option>
<option value="blue">–°–∏–Ω—è—è</option>
<option value="cyan">–ê–∫–≤–∞–º–∞—Ä–∏–Ω</option>
<option value="green">–ó–µ–ª—ë–Ω–∞—è</option>
<option value="yellow">–ñ—ë–ª—Ç–∞—è</option>
<option value="gold">–ó–æ–ª–æ—Ç–∞—è</option>
<option value="gray">–°–µ—Ä–∞—è</option>
</select>
</div>
</div>
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-400">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
<input type="text" id="editListingTitle" class="rust-input" required maxlength="20">
</div>
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-400">–û–ø–∏—Å–∞–Ω–∏–µ</label>
<textarea id="editListingDesc" class="rust-input" rows="4" required maxlength="1000"></textarea>
</div>
<div class="grid grid-cols-2 gap-4 mb-4">
<div>
<label class="block text-sm mb-2 text-gray-400">Telegram</label>
<input type="text" id="editListingTelegram" class="rust-input">
</div>
<div>
<label class="block text-sm mb-2 text-gray-400">VK</label>
<input type="text" id="editListingVk" class="rust-input">
</div>
</div>
<div class="mb-6">
<label class="block text-sm mb-2 text-gray-400">–ù–∏–∫ –≤ RustEx Remake</label>
<input type="text" id="editListingNick" class="rust-input" required>
</div>
<button type="submit" class="rust-btn w-full">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</form>
<button class="absolute top-4 right-4 text-gray-500 hover:text-white text-2xl" onclick="hideModal('editListingModal')">&times;</button>
</div>
</div>
<div id="adminListingModal" class="modal">
<div class="rust-card p-8 w-full max-w-md mx-4 relative">
<h2 class="rust-font text-xl text-center mb-6 glow-text" style="color:var(--rust-orange)">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ–º</h2>
<input type="hidden" id="adminListingId">
<div class="space-y-3">
<button class="rust-btn w-full" onclick="adminFreezeListing()">
<svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M5 8a1 1 0 011-1h1V6a1 1 0 012 0v1h2V6a1 1 0 112 0v1h1a1 1 0 110 2h-1v2h1a1 1 0 110 2h-1v1a1 1 0 11-2 0v-1H9v1a1 1 0 11-2 0v-1H6a1 1 0 110-2h1v-2H6a1 1 0 01-1-1z"/></svg>
–ó–∞–º–æ—Ä–æ–∑–∏—Ç—å
</button>
<button class="rust-btn w-full" onclick="adminUnfreezeListing()">–†–∞–∑–º–æ—Ä–æ–∑–∏—Ç—å</button>
<button class="rust-btn rust-btn-secondary w-full" onclick="adminEditListing()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
<button class="rust-btn w-full" style="background:linear-gradient(180deg,#dc2626,#991b1b,#7f1d1d)" onclick="adminDeleteListing()">–£–¥–∞–ª–∏—Ç—å</button>
</div>
<div class="mt-4">
<label class="block text-sm mb-2 text-gray-400">–ü—Ä–∏—á–∏–Ω–∞ –∑–∞–º–æ—Ä–æ–∑–∫–∏</label>
<input type="text" id="adminFreezeReason" class="rust-input" placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É">
</div>
<button class="absolute top-4 right-4 text-gray-500 hover:text-white text-2xl" onclick="hideModal('adminListingModal')">&times;</button>
</div>
</div>
<div id="toast" class="toast"></div>
<script>
const SUPABASE_URL='https://jerzhimcsxmgyxnwrojf.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplcnpoaW1jc3htZ3l4bndyb2pmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMzE0NDMsImV4cCI6MjA3OTkwNzQ0M30.zsZvnuqrtjahyeUr0nhXthbgKOwb3Yz_bsVC4rvfKPM';
const ADMIN_EMAIL='mustafych@gmail.com';
const DEFAULT_IMAGE='https://cdn.rust.facepunch.com/web/og-social-rust.jpg';
const BANNED_WORDS=['discord.gg','t.me/joinchat','bit.ly','—Ä–µ–∫–ª–∞–º–∞','–ø—Ä–æ–º–æ–∫–æ–¥','–±–µ—Å–ø–ª–∞—Ç–Ω–æ','—Ä–æ–∑—ã–≥—Ä—ã—à'];
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let currentUser=null;
let currentProfile=null;
let currentCategory='all';
let currentSorting='new';
let viewingUserId=null;
let currentChatUserId=null;
let currentListingId=null;
let userIP='';
const categoryLabels={team:'–í —Ç–∏–º–º—É',teammate:'–ù–∞–ø–∞—Ä–Ω–∏–∫',clan_search:'–ò—â—É –∫–ª–∞–Ω',clan_recruit:'–ù–∞–±–æ—Ä –≤ –∫–ª–∞–Ω',farmer:'–§–∞—Ä–º–µ—Ä',pvp:'–ü–í–ü—à–µ—Ä'};
const categoryColors={team:'bg-blue-600',teammate:'bg-green-600',clan_search:'bg-purple-600',clan_recruit:'bg-red-600',farmer:'bg-yellow-600',pvp:'bg-pink-600'};
async function getIP(){
try{
const r=await fetch('https://api.ipify.org?format=json');
const d=await r.json();
userIP=d.ip||'';
}catch(e){userIP='unknown'}
}
async function checkIPLimit(){
if(!userIP)return{canRegister:true,canLogin:true};
try{
const{data}=await supabase.from('rustex_ip_limits').select('*').eq('ip_address',userIP);
const count=data?data.length:0;
return{canRegister:count<3,canLogin:true,count};
}catch(e){return{canRegister:true,canLogin:true}}
}
async function registerIP(userId){
if(!userIP)return;
try{
await supabase.from('rustex_ip_limits').insert({ip_address:userIP,user_id:userId});
}catch(e){}
}
function containsBannedWords(text){
const lower=text.toLowerCase();
return BANNED_WORDS.some(w=>lower.includes(w));
}
function escapeHtml(str){
if(!str)return'';
return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function getAvatarUrl(profile,size=128){
if(profile&&profile.avatar_url&&profile.avatar_url.length>10)return profile.avatar_url;
const name=encodeURIComponent((profile?.username||'U').substring(0,2));
return`https://ui-avatars.com/api/?name=${name}&background=cd412b&color=fff&size=${size}&bold=true`;
}
function showToast(msg,type='success'){
const t=document.getElementById('toast');
t.textContent=msg;
t.className='toast '+type+' show';
setTimeout(()=>t.classList.remove('show'),4000);
}
function showModal(id){hideAllModals();document.getElementById(id).classList.add('show')}
function hideModal(id){document.getElementById(id).classList.remove('show')}
function hideAllModals(){document.querySelectorAll('.modal').forEach(m=>m.classList.remove('show'))}
function switchModal(id){hideAllModals();setTimeout(()=>showModal(id),100)}
function toggleDropdown(id){
const d=document.getElementById(id);
d.classList.toggle('show');
}
document.addEventListener('click',e=>{
if(!e.target.closest('.dropdown')){
document.querySelectorAll('.dropdown-menu').forEach(d=>d.classList.remove('show'));
}
});
async function init(){
await getIP();
try{
const hash=window.location.hash;
if(hash&&hash.includes('access_token')){
const params=new URLSearchParams(hash.substring(1));
const accessToken=params.get('access_token');
const refreshToken=params.get('refresh_token');
if(accessToken&&refreshToken){
const{data}=await supabase.auth.setSession({access_token:accessToken,refresh_token:refreshToken});
if(data.session){
window.history.replaceState(null,'',window.location.pathname);
currentUser=data.session.user;
await loadOrCreateProfile();
updateUIForAuth();
}
}
}
const{data:{session}}=await supabase.auth.getSession();
if(session&&session.user){
currentUser=session.user;
await loadOrCreateProfile();
}
updateUIForAuth();
await loadListings();
supabase.auth.onAuthStateChange(async(event,session)=>{
if(event==='SIGNED_IN'&&session){
currentUser=session.user;
await loadOrCreateProfile();
updateUIForAuth();
loadListings();
}else if(event==='SIGNED_OUT'){
currentUser=null;currentProfile=null;
updateUIForAuth();
loadListings();
}
});
}catch(e){console.log(e)}
finally{
document.getElementById('loadingOverlay').style.display='none';
document.getElementById('app').style.opacity='1';
}
}
async function loadOrCreateProfile(){
if(!currentUser)return null;
try{
const{data,error}=await supabase.from('rustex_profiles').select('*').eq('user_id',currentUser.id).maybeSingle();
if(data){
currentProfile=data;
if(data.is_new){
setTimeout(()=>showModal('welcomeModal'),500);
await supabase.from('rustex_profiles').update({is_new:false}).eq('user_id',currentUser.id);
}
return data;
}
const username=currentUser.user_metadata?.username||currentUser.email?.split('@')[0]||'User'+Date.now();
const isAdmin=currentUser.email===ADMIN_EMAIL;
const newProfile={user_id:currentUser.id,username,email:currentUser.email||'',game_nick:username,is_admin:isAdmin,is_new:true};
const{data:created}=await supabase.from('rustex_profiles').insert(newProfile).select().single();
if(created){currentProfile=created;setTimeout(()=>showModal('welcomeModal'),500);return created;}
currentProfile={...newProfile,created_at:new Date().toISOString()};
return currentProfile;
}catch(e){
currentProfile={username:currentUser.email?.split('@')[0]||'User',game_nick:'',created_at:new Date().toISOString()};
return currentProfile;
}
}
function updateUIForAuth(){
const authBtns=document.getElementById('authButtons');
const userMenu=document.getElementById('userMenu');
const createBtn=document.getElementById('createListingBtn');
const msgNav=document.getElementById('messagesNav');
const notifNav=document.getElementById('notificationsNav');
const profNav=document.getElementById('profileNav');
if(currentUser&&currentProfile){
authBtns.style.display='none';
userMenu.style.display='flex';
createBtn.style.display='inline-flex';
msgNav.style.display='flex';
notifNav.style.display='flex';
profNav.style.display='flex';
document.getElementById('headerAvatar').src=getAvatarUrl(currentProfile);
checkUnreadMessages();
checkUnreadNotifications();
}else{
authBtns.style.display='block';
userMenu.style.display='none';
createBtn.style.display='none';
msgNav.style.display='none';
notifNav.style.display='none';
profNav.style.display='none';
}
}
async function checkUsernameAvailable(username){
try{
const{data}=await supabase.from('rustex_profiles').select('id').eq('username',username).maybeSingle();
return!data;
}catch(e){return true}
}
async function register(e){
e.preventDefault();
const btn=document.getElementById('regBtn');
const errBox=document.getElementById('registerError');
btn.disabled=true;btn.textContent='–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';errBox.style.display='none';
const username=document.getElementById('regUsername').value.trim();
const email=document.getElementById('regEmail').value.trim();
const password=document.getElementById('regPassword').value;
if(username.length<3){errBox.textContent='–ò–º—è –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';errBox.style.display='block';btn.disabled=false;btn.textContent='–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';return;}
const ipCheck=await checkIPLimit();
if(!ipCheck.canRegister){errBox.textContent='–õ–∏–º–∏—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∏—Å—á–µ—Ä–ø–∞–Ω (–º–∞–∫—Å. 3)';errBox.style.display='block';btn.disabled=false;btn.textContent='–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';return;}
const available=await checkUsernameAvailable(username);
if(!available){errBox.textContent='–≠—Ç–æ –∏–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ';errBox.style.display='block';btn.disabled=false;btn.textContent='–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';return;}
try{
const{data,error}=await supabase.auth.signUp({email,password,options:{data:{username}}});
if(error)throw error;
if(data.user){
await registerIP(data.user.id);
if(data.session){
currentUser=data.user;
await loadOrCreateProfile();
updateUIForAuth();
hideModal('registerModal');
showToast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!','success');
loadListings();
}else{
const{data:loginData,error:loginErr}=await supabase.auth.signInWithPassword({email,password});
if(loginErr)throw loginErr;
currentUser=loginData.user;
await loadOrCreateProfile();
updateUIForAuth();
hideModal('registerModal');
showToast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!','success');
loadListings();
}
}
}catch(err){
let msg=err.message||'–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
if(msg.includes('already registered'))msg='Email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';
errBox.textContent=msg;errBox.style.display='block';
}finally{btn.disabled=false;btn.textContent='–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç'}
}
async function login(e){
e.preventDefault();
const btn=document.getElementById('loginBtn');
const errBox=document.getElementById('loginError');
btn.disabled=true;btn.textContent='–í—Ö–æ–¥...';errBox.style.display='none';
const email=document.getElementById('loginEmail').value.trim();
const password=document.getElementById('loginPassword').value;
try{
const{data,error}=await supabase.auth.signInWithPassword({email,password});
if(error)throw error;
if(data.user){
currentUser=data.user;
await loadOrCreateProfile();
updateUIForAuth();
hideModal('loginModal');
showToast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!','success');
loadListings();
}
}catch(err){
let msg=err.message||'–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
if(msg.includes('Invalid login'))msg='–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
errBox.textContent=msg;errBox.style.display='block';
}finally{btn.disabled=false;btn.textContent='–í–æ–π—Ç–∏'}
}
async function logout(){
await supabase.auth.signOut();
currentUser=null;currentProfile=null;
updateUIForAuth();
showPage('listings');
showToast('–í—ã –≤—ã—à–ª–∏','success');
}
function showPage(page){
document.querySelectorAll('.nav-link').forEach(l=>{
l.classList.remove('active');
if(l.dataset.page===page)l.classList.add('active');
});
['listingsPage','messagesPage','notificationsPage','profilePage','viewListingPage','viewProfilePage'].forEach(p=>{
const el=document.getElementById(p);
if(el)el.style.display='none';
});
if(page==='listings'){
document.getElementById('listingsPage').style.display='block';
loadListings();
}else if(page==='messages'){
if(!currentUser){showModal('loginModal');return}
document.getElementById('messagesPage').style.display='block';
loadChats();
}else if(page==='notifications'){
if(!currentUser){showModal('loginModal');return}
document.getElementById('notificationsPage').style.display='block';
loadNotifications();
}else if(page==='profile'){
if(!currentUser){showModal('loginModal');return}
document.getElementById('profilePage').style.display='block';
loadMyProfile();
}else if(page==='viewListing'){
document.getElementById('viewListingPage').style.display='block';
}else if(page==='viewProfile'){
document.getElementById('viewProfilePage').style.display='block';
}
window.scrollTo(0,0);
}
async function loadListings(){
const grid=document.getElementById('listingsGrid');
const empty=document.getElementById('listingsEmpty');
const loading=document.getElementById('listingsLoading');
loading.style.display='block';grid.innerHTML='';empty.style.display='none';
try{
let query=supabase.from('rustex_listings').select('*');
if(currentCategory!=='all')query=query.eq('category',currentCategory);
if(currentSorting==='new')query=query.order('created_at',{ascending:false});
else if(currentSorting==='old')query=query.order('created_at',{ascending:true});
else if(currentSorting==='likes_desc')query=query.order('likes_count',{ascending:false});
else if(currentSorting==='likes_asc')query=query.order('likes_count',{ascending:true});
const{data,error}=await query;
loading.style.display='none';
if(error||!data||data.length===0){empty.style.display='block';return}
const userIds=[...new Set(data.map(l=>l.user_id))];
let profileMap={};
try{
const{data:profiles}=await supabase.from('rustex_profiles').select('user_id,username,avatar_url,is_admin').in('user_id',userIds);
(profiles||[]).forEach(p=>profileMap[p.user_id]=p);
}catch(e){}
let userLikes=[];
if(currentUser){
try{
const{data:likes}=await supabase.from('rustex_likes').select('listing_id').eq('user_id',currentUser.id);
userLikes=(likes||[]).map(l=>l.listing_id);
}catch(e){}
}
grid.innerHTML=data.map(l=>{
const profile=profileMap[l.user_id]||{username:'–ò–≥—Ä–æ–∫',avatar_url:''};
const imgUrl=l.image_url||DEFAULT_IMAGE;
const isLiked=userLikes.includes(l.id);
const theme=l.theme||'orange';
return`
<div class="rust-card listing-card theme-${theme} ${l.is_frozen?'frozen':''}" onclick="viewListing('${l.id}')">
<div class="h-40 bg-cover bg-center relative" style="background-image:url('${imgUrl}')">
<div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
<div class="absolute bottom-3 left-3 right-3 flex justify-between items-end">
<span class="category-badge ${categoryColors[l.category]||'bg-gray-600'}">${categoryLabels[l.category]||l.category}</span>
${l.is_frozen?'<span class="category-badge bg-blue-600">–ó–∞–º–æ—Ä–æ–∂–µ–Ω–æ</span>':''}
</div>
</div>
<div class="p-4">
<h3 class="font-bold text-lg mb-2 truncate text-white">${escapeHtml(l.title||'')}</h3>
<p class="text-gray-400 text-sm mb-3 line-clamp-2">${escapeHtml((l.description||'').substring(0,80))}${(l.description||'').length>80?'...':''}</p>
<div class="flex items-center justify-between">
<div class="flex items-center gap-2">
<img src="${getAvatarUrl(profile,64)}" class="w-8 h-8 rounded-full border-2 border-zinc-600">
<span class="text-sm text-gray-300">${escapeHtml(profile.username||'–ò–≥—Ä–æ–∫')}</span>
${profile.is_admin?'<span class="admin-badge text-xs py-0.5 px-2">ADM</span>':''}
</div>
<div class="like-btn ${isLiked?'liked':''}" onclick="event.stopPropagation();toggleLike('${l.id}')">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/></svg>
${l.likes_count||0}
</div>
</div>
</div>
</div>`;
}).join('');
}catch(err){
console.log(err);
loading.style.display='none';
empty.style.display='block';
}
}
function filterCategory(cat){
currentCategory=cat;
document.querySelectorAll('.category-filter').forEach(b=>{
b.classList.remove('bg-orange-600','text-white');
b.classList.add('bg-zinc-800','text-gray-300');
if(b.dataset.category===cat){
b.classList.add('bg-orange-600','text-white');
b.classList.remove('bg-zinc-800','text-gray-300');
}
});
loadListings();
}
function setSorting(sort){
currentSorting=sort;
document.getElementById('sortDropdown').classList.remove('show');
loadListings();
}
async function toggleLike(listingId){
if(!currentUser){showModal('loginModal');return}
try{
const{data:listing}=await supabase.from('rustex_listings').select('user_id,likes_count').eq('id',listingId).single();
if(listing.user_id===currentUser.id){showToast('–ù–µ–ª—å–∑—è –ª–∞–π–∫–∞—Ç—å —Å–≤–æ—ë –æ–±—ä—è–≤–ª–µ–Ω–∏–µ','error');return}
const{data:existing}=await supabase.from('rustex_likes').select('id').eq('user_id',currentUser.id).eq('listing_id',listingId).maybeSingle();
if(existing){
await supabase.from('rustex_likes').delete().eq('id',existing.id);
await supabase.from('rustex_listings').update({likes_count:Math.max(0,(listing.likes_count||1)-1)}).eq('id',listingId);
}else{
await supabase.from('rustex_likes').insert({user_id:currentUser.id,listing_id:listingId});
await supabase.from('rustex_listings').update({likes_count:(listing.likes_count||0)+1}).eq('id',listingId);
await supabase.from('rustex_notifications').insert({
user_id:listing.user_id,
type:'like',
title:'–ù–æ–≤—ã–π –ª–∞–π–∫',
message:`${currentProfile?.username||'–ö—Ç–æ-—Ç–æ'} –æ—Ü–µ–Ω–∏–ª –≤–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ`,
link:listingId
});
}
loadListings();
}catch(e){console.log(e)}
}
async function viewListing(id){
if(!currentUser){showToast('–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞','error');showModal('loginModal');return}
currentListingId=id;
try{
const{data:l}=await supabase.from('rustex_listings').select('*').eq('id',id).single();
if(!l){showToast('–û–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ','error');return}
let profile={username:'–ò–≥—Ä–æ–∫',avatar_url:'',game_nick:'-',is_admin:false};
try{const{data:p}=await supabase.from('rustex_profiles').select('*').eq('user_id',l.user_id).maybeSingle();if(p)profile=p;}catch(e){}
const{data:existing}=await supabase.from('rustex_likes').select('id').eq('user_id',currentUser.id).eq('listing_id',id).maybeSingle();
const isLiked=!!existing;
const isOwner=currentUser.id===l.user_id;
const isAdmin=currentProfile?.is_admin;
showPage('viewListing');
const imgUrl=l.image_url||DEFAULT_IMAGE;
const theme=l.theme||'orange';
document.getElementById('listingDetail').innerHTML=`
${l.is_frozen?`<div class="frozen-banner"><b>–û–±—ä—è–≤–ª–µ–Ω–∏–µ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–æ</b><br><span class="text-sm opacity-80">${escapeHtml(l.frozen_reason||'–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª')}</span></div>`:''}
<div class="md:flex">
<div class="md:w-1/2 h-64 md:h-auto bg-cover bg-center relative" style="background-image:url('${imgUrl}');min-height:280px">
<div class="absolute inset-0 bg-gradient-to-r from-black/60 to-transparent"></div>
</div>
<div class="md:w-1/2 p-6">
<span class="category-badge ${categoryColors[l.category]||'bg-gray-600'} inline-block mb-3">${categoryLabels[l.category]||l.category}</span>
<h1 class="rust-font text-2xl mb-4 glow-text" style="color:var(--rust-orange)">${escapeHtml(l.title||'')}</h1>
<p class="text-gray-300 mb-6 whitespace-pre-wrap text-sm">${escapeHtml(l.description||'')}</p>
<div class="bg-zinc-800/50 rounded p-4 mb-6">
<div class="flex items-center gap-2 text-sm">
<svg class="w-4 h-4 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/></svg>
<span class="text-gray-400">–ù–∏–∫:</span>
<span class="text-white">${escapeHtml(l.game_nick||'-')}</span>
</div>
</div>
<div class="flex items-center gap-4 p-3 bg-zinc-800/30 rounded mb-6 cursor-pointer hover:bg-zinc-800/50" onclick="viewProfile('${l.user_id}')">
<img src="${getAvatarUrl(profile)}" class="w-12 h-12 rounded-full border-2 border-zinc-600">
<div class="flex-1">
<div class="font-bold text-white flex items-center gap-2">${escapeHtml(profile.username||'–ò–≥—Ä–æ–∫')}${profile.is_admin?'<span class="admin-badge text-xs py-0.5 px-2">ADM</span>':''}</div>
<div class="text-xs text-gray-400">${escapeHtml(profile.game_nick||'-')}</div>
</div>
</div>
<div class="flex flex-wrap gap-3 mb-4">
${renderSocialBtn(l.telegram,'tg')}
${renderSocialBtn(l.vk,'vk')}
<div class="like-btn ${isLiked?'liked':''}" onclick="toggleLike('${l.id}')">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/></svg>
${l.likes_count||0}
</div>
${!isOwner?`<button class="rust-btn flex-1" onclick="startChatWith('${l.user_id}')">–ù–∞–ø–∏—Å–∞—Ç—å</button>`:''}
</div>
${isOwner?`<div class="flex gap-2"><button class="rust-btn rust-btn-secondary flex-1" onclick="editMyListing('${l.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button><button class="rust-btn flex-1" style="background:linear-gradient(180deg,#dc2626,#991b1b,#7f1d1d)" onclick="deleteListing('${l.id}')">–£–¥–∞–ª–∏—Ç—å</button></div>`:''}
${isAdmin&&!isOwner?`<button class="rust-btn w-full mt-2" onclick="showAdminListingModal('${l.id}')">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>`:''}
</div>
</div>`;
}catch(err){console.log(err);showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏','error')}
}
function renderSocialBtn(value,type){
if(!value||value==='-')return'';
let url='';
if(type==='tg'){
if(value.startsWith('http'))url=value;
else if(value.startsWith('@'))url='https://t.me/'+value.slice(1);
else url='https://t.me/'+value;
return`<a href="${url}" target="_blank" class="social-btn tg-btn"><svg class="w-5 h-5" fill="white" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg></a>`;
}
if(type==='vk'){
if(value.startsWith('http'))url=value;
else if(value.startsWith('@'))url='https://vk.com/'+value.slice(1);
else url='https://vk.com/'+value;
return`<a href="${url}" target="_blank" class="social-btn vk-btn"><svg class="w-5 h-5" fill="white" viewBox="0 0 24 24"><path d="M15.684 0H8.316C1.592 0 0 1.592 0 8.316v7.368C0 22.408 1.592 24 8.316 24h7.368C22.408 24 24 22.408 24 15.684V8.316C24 1.592 22.408 0 15.684 0zm3.692 17.123h-1.744c-.66 0-.864-.525-2.05-1.727-1.033-1-1.49-1.135-1.744-1.135-.356 0-.458.102-.458.593v1.575c0 .424-.135.678-1.253.678-1.846 0-3.896-1.118-5.335-3.202C4.624 10.857 4 8.57 4 8.096c0-.254.102-.491.593-.491h1.744c.44 0 .61.203.78.678.863 2.49 2.303 4.675 2.896 4.675.22 0 .322-.102.322-.66V9.721c-.068-1.186-.695-1.287-.695-1.71 0-.203.17-.407.44-.407h2.743c.373 0 .508.203.508.643v3.473c0 .372.17.508.271.508.22 0 .407-.136.814-.542 1.27-1.422 2.18-3.61 2.18-3.61.119-.254.322-.491.763-.491h1.744c.525 0 .644.27.525.643-.22 1.017-2.354 4.031-2.354 4.031-.186.305-.254.44 0 .78.186.254.796.779 1.203 1.253.745.847 1.32 1.558 1.473 2.05.17.49-.085.744-.576.744z"/></svg></a>`;
}
return'';
}
async function viewProfile(userId){
viewingUserId=userId;
try{
let p={username:'–ò–≥—Ä–æ–∫',avatar_url:'',game_nick:'-',description:'',telegram:'-',vk:'-',is_admin:false};
try{const{data}=await supabase.from('rustex_profiles').select('*').eq('user_id',userId).maybeSingle();if(data)p=data;}catch(e){}
showPage('viewProfile');
document.getElementById('viewProfileAvatar').src=getAvatarUrl(p,256);
document.getElementById('viewProfileUsername').textContent=p.username||'–ò–≥—Ä–æ–∫';
document.getElementById('viewProfileNick').textContent=p.game_nick||'-';
document.getElementById('viewProfileDesc').textContent=p.description||'–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ.';
document.getElementById('viewAdminBadge').style.display=p.is_admin?'inline':'none';
document.getElementById('viewProfileChatBtn').style.display=(currentUser&&currentUser.id===userId)?'none':'inline-flex';
let socials='';
socials+=renderSocialBtn(p.telegram,'tg');
socials+=renderSocialBtn(p.vk,'vk');
document.getElementById('viewProfileSocials').innerHTML=socials;
let listings=[];
try{const{data}=await supabase.from('rustex_listings').select('*').eq('user_id',userId);if(data)listings=data;}catch(e){}
document.getElementById('userListingsGrid').innerHTML=listings.length?listings.map(l=>renderListingCard(l,p)).join(''):'<p class="text-gray-500 col-span-3 text-center py-10">–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p>';
}catch(err){console.log(err)}
}
function renderListingCard(l,profile){
const imgUrl=l.image_url||DEFAULT_IMAGE;
const theme=l.theme||'orange';
return`
<div class="rust-card listing-card theme-${theme}" onclick="viewListing('${l.id}')">
<div class="h-32 bg-cover bg-center relative" style="background-image:url('${imgUrl}')">
<div class="absolute inset-0 bg-gradient-to-t from-black to-transparent"></div>
</div>
<div class="p-4">
<span class="category-badge ${categoryColors[l.category]||'bg-gray-600'} text-xs">${categoryLabels[l.category]||l.category}</span>
<h3 class="font-bold mt-2 text-white">${escapeHtml(l.title||'')}</h3>
<div class="like-btn mt-2 inline-flex" onclick="event.stopPropagation();toggleLike('${l.id}')">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/></svg>
${l.likes_count||0}
</div>
</div>
</div>`;
}
async function loadMyProfile(){
if(!currentProfile)await loadOrCreateProfile();
if(!currentProfile)return;
document.getElementById('profileAvatar').src=getAvatarUrl(currentProfile,256);
document.getElementById('profileUsername').textContent=currentProfile.username||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
document.getElementById('profileNick').textContent=currentProfile.game_nick||'-';
document.getElementById('profileDesc').textContent=currentProfile.description||'–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è.';
document.getElementById('profileJoined').textContent=currentProfile.created_at?new Date(currentProfile.created_at).toLocaleDateString('ru'):'‚Äî';
document.getElementById('adminBadge').style.display=currentProfile.is_admin?'inline':'none';
document.getElementById('adminPanel').style.display=currentProfile.is_admin?'block':'none';
let socials='';
socials+=renderSocialBtn(currentProfile.telegram,'tg');
socials+=renderSocialBtn(currentProfile.vk,'vk');
document.getElementById('profileSocials').innerHTML=socials;
document.getElementById('editGameNick').value=currentProfile.game_nick||'';
document.getElementById('editTelegram').value=currentProfile.telegram||'';
document.getElementById('editVk').value=currentProfile.vk||'';
document.getElementById('editDescription').value=currentProfile.description||'';
if(currentProfile.is_admin){
try{
const{count:usersCount}=await supabase.from('rustex_profiles').select('*',{count:'exact',head:true});
const{count:listingsCount}=await supabase.from('rustex_listings').select('*',{count:'exact',head:true});
document.getElementById('adminUsersCount').textContent=usersCount||0;
document.getElementById('adminListingsCount').textContent=listingsCount||0;
}catch(e){}
}
let myListings=[];
try{const{data}=await supabase.from('rustex_listings').select('*').eq('user_id',currentUser.id);if(data)myListings=data;}catch(e){}
document.getElementById('myListingsGrid').innerHTML=myListings.length?myListings.map(l=>`
<div class="rust-card listing-card theme-${l.theme||'orange'}">
<div class="h-32 bg-cover bg-center relative" style="background-image:url('${l.image_url||DEFAULT_IMAGE}')">
<div class="absolute inset-0 bg-gradient-to-t from-black to-transparent"></div>
</div>
<div class="p-4">
<span class="category-badge ${categoryColors[l.category]||'bg-gray-600'} text-xs">${categoryLabels[l.category]||l.category}</span>
<h3 class="font-bold mt-2 text-white">${escapeHtml(l.title||'')}</h3>
<div class="flex justify-between items-center mt-3">
<div class="like-btn inline-flex text-sm"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/></svg>${l.likes_count||0}</div>
<div class="flex gap-2">
<button class="text-blue-400 hover:text-blue-300 text-xs" onclick="event.stopPropagation();editMyListing('${l.id}')">–ò–∑–º–µ–Ω–∏—Ç—å</button>
<button class="text-red-400 hover:text-red-300 text-xs" onclick="event.stopPropagation();deleteListing('${l.id}')">–£–¥–∞–ª–∏—Ç—å</button>
</div>
</div>
</div>
</div>
`).join(''):'<div class="col-span-3 text-center py-12"><p class="text-gray-500">–£ –≤–∞—Å –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p><button class="rust-btn mt-4" onclick="createListing()">–°–æ–∑–¥–∞—Ç—å</button></div>';
}
async function updateProfile(e){
e.preventDefault();
const updates={
game_nick:document.getElementById('editGameNick').value.trim()||'-',
telegram:document.getElementById('editTelegram').value.trim()||'-',
vk:document.getElementById('editVk').value.trim()||'-',
description:document.getElementById('editDescription').value.trim()||''
};
try{
const{error}=await supabase.from('rustex_profiles').update(updates).eq('user_id',currentUser.id);
if(error)throw error;
currentProfile={...currentProfile,...updates};
hideModal('editProfileModal');
loadMyProfile();
updateUIForAuth();
showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!','success');
}catch(err){showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è','error')}
}
async function uploadAvatar(e){
const file=e.target.files[0];
if(!file)return;
if(file.size>500000){showToast('–ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä 500KB','error');return}
const reader=new FileReader();
reader.onload=async(ev)=>{
try{
const avatarUrl=ev.target.result;
const{error}=await supabase.from('rustex_profiles').update({avatar_url:avatarUrl}).eq('user_id',currentUser.id);
if(error)throw error;
currentProfile.avatar_url=avatarUrl;
loadMyProfile();
updateUIForAuth();
showToast('–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω!','success');
}catch(err){showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏','error')}
};
reader.readAsDataURL(file);
}
function previewListingImage(e){
const file=e.target.files[0];
if(!file)return;
if(file.size>1000000){showToast('–ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä 1MB','error');return}
const reader=new FileReader();
reader.onload=(ev)=>{
document.getElementById('listingImage').value=ev.target.result;
const upload=document.getElementById('listingImageUpload');
upload.innerHTML=`<img src="${ev.target.result}" class="max-h-32 rounded"><span class="text-green-400 text-xs mt-2">–í—ã–±—Ä–∞–Ω–æ</span><input type="file" accept="image/*" onchange="previewListingImage(event)">`;
};
reader.readAsDataURL(file);
}
async function createListing(){
if(!currentUser){showModal('loginModal');return}
let myListings=[];
try{const{data}=await supabase.from('rustex_listings').select('id').eq('user_id',currentUser.id);if(data)myListings=data;}catch(e){}
if(myListings.length>=3){showToast('–ú–∞–∫—Å. 3 –æ–±—ä—è–≤–ª–µ–Ω–∏—è','error');return}
document.getElementById('listingNick').value=currentProfile?.game_nick||currentProfile?.username||'';
document.getElementById('listingTelegram').value=currentProfile?.telegram||'';
document.getElementById('listingVk').value=currentProfile?.vk||'';
document.getElementById('listingImage').value='';
document.getElementById('listingImageUpload').innerHTML=`<svg class="w-10 h-10 text-gray-500 mb-2" fill="currentColor" viewBox="0 0 20 20"><path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/></svg><span class="text-gray-400 text-sm">–ù–∞–∂–º–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞</span><input type="file" accept="image/*" onchange="previewListingImage(event)">`;
showModal('createListingModal');
}
async function submitListing(e){
e.preventDefault();
const btn=document.getElementById('submitListingBtn');
btn.disabled=true;btn.textContent='–ü—É–±–ª–∏–∫–∞—Ü–∏—è...';
const title=document.getElementById('listingTitle').value.trim();
const desc=document.getElementById('listingDesc').value.trim();
if(containsBannedWords(title)||containsBannedWords(desc)){
showToast('–û–±–Ω–∞—Ä—É–∂–µ–Ω –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç','error');
btn.disabled=false;btn.textContent='–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å';
return;
}
const listing={
user_id:currentUser.id,
category:document.getElementById('listingCategory').value,
theme:document.getElementById('listingTheme').value,
title,
description:desc,
image_url:document.getElementById('listingImage').value||'',
telegram:document.getElementById('listingTelegram').value.trim()||'-',
vk:document.getElementById('listingVk').value.trim()||'-',
game_nick:document.getElementById('listingNick').value.trim()
};
try{
const{error}=await supabase.from('rustex_listings').insert(listing);
if(error)throw error;
hideModal('createListingModal');
document.querySelector('#createListingModal form').reset();
loadListings();
showToast('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!','success');
}catch(err){showToast('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏','error')}
finally{btn.disabled=false;btn.textContent='–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å'}
}
async function editMyListing(id){
try{
const{data:l}=await supabase.from('rustex_listings').select('*').eq('id',id).single();
if(!l)return;
document.getElementById('editListingId').value=id;
document.getElementById('editListingCategory').value=l.category;
document.getElementById('editListingTheme').value=l.theme||'orange';
document.getElementById('editListingTitle').value=l.title;
document.getElementById('editListingDesc').value=l.description;
document.getElementById('editListingTelegram').value=l.telegram;
document.getElementById('editListingVk').value=l.vk;
document.getElementById('editListingNick').value=l.game_nick;
showModal('editListingModal');
}catch(e){showToast('–û—à–∏–±–∫–∞','error')}
}
async function updateListing(e){
e.preventDefault();
const id=document.getElementById('editListingId').value;
const title=document.getElementById('editListingTitle').value.trim();
const desc=document.getElementById('editListingDesc').value.trim();
if(containsBannedWords(title)||containsBannedWords(desc)){showToast('–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç','error');return}
const updates={
category:document.getElementById('editListingCategory').value,
theme:document.getElementById('editListingTheme').value,
title,
description:desc,
telegram:document.getElementById('editListingTelegram').value.trim()||'-',
vk:document.getElementById('editListingVk').value.trim()||'-',
game_nick:document.getElementById('editListingNick').value.trim()
};
try{
await supabase.from('rustex_listings').update(updates).eq('id',id);
hideModal('editListingModal');
showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!','success');
loadListings();
if(currentListingId===id)viewListing(id);
}catch(e){showToast('–û—à–∏–±–∫–∞','error')}
}
async function deleteListing(id){
if(!confirm('–£–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?'))return;
try{
await supabase.from('rustex_listings').delete().eq('id',id);
showToast('–£–¥–∞–ª–µ–Ω–æ','success');
showPage('profile');
loadMyProfile();
}catch(err){showToast('–û—à–∏–±–∫–∞','error')}
}
function showAdminListingModal(id){
document.getElementById('adminListingId').value=id;
showModal('adminListingModal');
}
async function adminFreezeListing(){
const id=document.getElementById('adminListingId').value;
const reason=document.getElementById('adminFreezeReason').value.trim()||'–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª';
try{
const{data:l}=await supabase.from('rustex_listings').select('user_id').eq('id',id).single();
await supabase.from('rustex_listings').update({is_frozen:true,frozen_reason:reason}).eq('id',id);
await supabase.from('rustex_notifications').insert({user_id:l.user_id,type:'freeze',title:'–û–±—ä—è–≤–ª–µ–Ω–∏–µ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–æ',message:reason,link:id});
hideModal('adminListingModal');
showToast('–ó–∞–º–æ—Ä–æ–∂–µ–Ω–æ','success');
viewListing(id);
}catch(e){showToast('–û—à–∏–±–∫–∞','error')}
}
async function adminUnfreezeListing(){
const id=document.getElementById('adminListingId').value;
try{
await supabase.from('rustex_listings').update({is_frozen:false,frozen_reason:''}).eq('id',id);
hideModal('adminListingModal');
showToast('–†–∞–∑–º–æ—Ä–æ–∂–µ–Ω–æ','success');
viewListing(id);
}catch(e){showToast('–û—à–∏–±–∫–∞','error')}
}
async function adminEditListing(){
const id=document.getElementById('adminListingId').value;
hideModal('adminListingModal');
editMyListing(id);
}
async function adminDeleteListing(){
const id=document.getElementById('adminListingId').value;
if(!confirm('–£–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?'))return;
try{
const{data:l}=await supabase.from('rustex_listings').select('user_id').eq('id',id).single();
await supabase.from('rustex_listings').delete().eq('id',id);
await supabase.from('rustex_notifications').insert({user_id:l.user_id,type:'delete',title:'–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ',message:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–¥–∞–ª–∏–ª –≤–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ'});
hideModal('adminListingModal');
showToast('–£–¥–∞–ª–µ–Ω–æ','success');
showPage('listings');
}catch(e){showToast('–û—à–∏–±–∫–∞','error')}
}
async function adminDeleteUser(){
const input=document.getElementById('adminDeleteUser').value.trim();
if(!input){showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏–ª–∏ email','error');return}
if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è '+input+'?'))return;
try{
const{data:p}=await supabase.from('rustex_profiles').select('user_id').or(`username.eq.${input},email.eq.${input}`).maybeSingle();
if(!p){showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω','error');return}
await supabase.from('rustex_listings').delete().eq('user_id',p.user_id);
await supabase.from('rustex_profiles').delete().eq('user_id',p.user_id);
showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω','success');
document.getElementById('adminDeleteUser').value='';
loadMyProfile();
}catch(e){showToast('–û—à–∏–±–∫–∞','error')}
}
async function loadChats(){
let userIds=new Set();
try{
const{data:sent}=await supabase.from('rustex_messages').select('receiver_id').eq('sender_id',currentUser.id);
const{data:received}=await supabase.from('rustex_messages').select('sender_id').eq('receiver_id',currentUser.id);
(sent||[]).forEach(m=>userIds.add(m.receiver_id));
(received||[]).forEach(m=>userIds.add(m.sender_id));
}catch(e){}
if(userIds.size===0){
document.getElementById('chatsList').innerHTML='<div class="text-center py-8 text-gray-500 text-sm">–ù–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤</div>';
return;
}
let profiles=[];
let unreadMap={};
try{
const{data}=await supabase.from('rustex_profiles').select('*').in('user_id',Array.from(userIds));
if(data)profiles=data;
const{data:unread}=await supabase.from('rustex_messages').select('sender_id').eq('receiver_id',currentUser.id).eq('is_read',false);
(unread||[]).forEach(m=>{unreadMap[m.sender_id]=(unreadMap[m.sender_id]||0)+1});
}catch(e){}
document.getElementById('chatsList').innerHTML=profiles.map(p=>`
<div class="flex items-center gap-3 p-3 rounded cursor-pointer transition-all ${currentChatUserId===p.user_id?'bg-orange-600/20':'hover:bg-zinc-800/50'}" onclick="openChat('${p.user_id}')">
<img src="${getAvatarUrl(p)}" class="w-10 h-10 rounded-full border-2 border-zinc-600">
<div class="flex-1 min-w-0">
<div class="font-bold text-sm truncate">${escapeHtml(p.username||'–ò–≥—Ä–æ–∫')}</div>
<div class="text-xs text-gray-400 truncate">${escapeHtml(p.game_nick||'-')}</div>
</div>
${unreadMap[p.user_id]?`<span class="unread-badge">${unreadMap[p.user_id]}</span>`:''}
</div>
`).join('');
}
async function openChat(userId){
currentChatUserId=userId;
loadChats();
let p={username:'–ò–≥—Ä–æ–∫',avatar_url:'',game_nick:'-'};
try{const{data}=await supabase.from('rustex_profiles').select('*').eq('user_id',userId).maybeSingle();if(data)p=data;}catch(e){}
document.getElementById('chatHeader').style.display='flex';
document.getElementById('chatInput').style.display='block';
document.getElementById('chatEmpty').style.display='none';
document.getElementById('chatAvatar').src=getAvatarUrl(p);
document.getElementById('chatName').textContent=p.username||'–ò–≥—Ä–æ–∫';
document.getElementById('chatNick').textContent=p.game_nick||'-';
try{await supabase.from('rustex_messages').update({is_read:true}).eq('sender_id',userId).eq('receiver_id',currentUser.id);}catch(e){}
loadMessages();
checkUnreadMessages();
}
async function loadMessages(){
if(!currentChatUserId)return;
let messages=[];
try{
const{data}=await supabase.from('rustex_messages').select('*').or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${currentChatUserId}),and(sender_id.eq.${currentChatUserId},receiver_id.eq.${currentUser.id})`).order('created_at');
if(data)messages=data;
}catch(e){}
const container=document.getElementById('chatMessages');
container.innerHTML=messages.map(m=>`
<div class="chat-message ${m.sender_id===currentUser.id?'sent':'received'}">
<div class="text-sm">${escapeHtml(m.content||'')}</div>
<div class="text-xs opacity-60 mt-1">${new Date(m.created_at).toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'})}</div>
</div>
`).join('');
container.scrollTop=container.scrollHeight;
}
async function sendMessage(){
const input=document.getElementById('messageInput');
const content=input.value.trim();
if(!content||!currentChatUserId)return;
if(containsBannedWords(content)){showToast('–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç','error');return}
try{
await supabase.from('rustex_messages').insert({sender_id:currentUser.id,receiver_id:currentChatUserId,content});
input.value='';
loadMessages();
}catch(err){showToast('–û—à–∏–±–∫–∞','error')}
}
async function startChatWith(userId){
if(!currentUser){showModal('loginModal');return}
if(userId===currentUser.id){showToast('–ù–µ–ª—å–∑—è –Ω–∞–ø–∏—Å–∞—Ç—å —Å–µ–±–µ','error');return}
showPage('messages');
setTimeout(()=>openChat(userId),100);
}
async function checkUnreadMessages(){
if(!currentUser)return;
try{
const{data}=await supabase.from('rustex_messages').select('id').eq('receiver_id',currentUser.id).eq('is_read',false);
const badge=document.getElementById('unreadBadge');
if(data&&data.length>0){badge.style.display='flex';badge.textContent=data.length;}
else{badge.style.display='none'}
}catch(e){}
}
async function loadNotifications(){
try{
const{data}=await supabase.from('rustex_notifications').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false}).limit(50);
if(!data||data.length===0){
document.getElementById('notificationsList').innerHTML='';
document.getElementById('notificationsEmpty').style.display='block';
return;
}
document.getElementById('notificationsEmpty').style.display='none';
document.getElementById('notificationsList').innerHTML=data.map(n=>`
<div class="rust-card p-4 flex items-start gap-4 ${n.is_read?'opacity-60':''}">
<div class="w-10 h-10 rounded-full flex items-center justify-center ${n.type==='like'?'bg-red-600/20 text-red-400':n.type==='freeze'?'bg-blue-600/20 text-blue-400':'bg-gray-600/20 text-gray-400'}">
${n.type==='like'?'<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/></svg>':n.type==='freeze'?'<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M5 8a1 1 0 011-1h1V6a1 1 0 012 0v1h2V6a1 1 0 112 0v1h1a1 1 0 110 2h-1v2h1a1 1 0 110 2h-1v1a1 1 0 11-2 0v-1H9v1a1 1 0 11-2 0v-1H6a1 1 0 110-2h1v-2H6a1 1 0 01-1-1z"/></svg>':'<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6z"/></svg>'}
</div>
<div class="flex-1">
<div class="font-bold text-sm">${escapeHtml(n.title)}</div>
<div class="text-gray-400 text-xs mt-1">${escapeHtml(n.message)}</div>
<div class="text-gray-500 text-xs mt-2">${new Date(n.created_at).toLocaleString('ru')}</div>
</div>
${n.link&&n.type==='like'?`<button class="rust-btn rust-btn-sm rust-btn-secondary" onclick="viewListing('${n.link}')">–û—Ç–∫—Ä—ã—Ç—å</button>`:''}
</div>
`).join('');
}catch(e){console.log(e)}
}
async function checkUnreadNotifications(){
if(!currentUser)return;
try{
const{data}=await supabase.from('rustex_notifications').select('id').eq('user_id',currentUser.id).eq('is_read',false);
const dot=document.getElementById('notificationDot');
if(data&&data.length>0){dot.style.display='block'}
else{dot.style.display='none'}
}catch(e){}
}
async function markAllNotificationsRead(){
try{
await supabase.from('rustex_notifications').update({is_read:true}).eq('user_id',currentUser.id);
loadNotifications();
checkUnreadNotifications();
showToast('–í—Å–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ','success');
}catch(e){}
}
document.querySelectorAll('.modal').forEach(m=>{
m.addEventListener('click',e=>{if(e.target===m)hideModal(m.id)});
});
setInterval(()=>{if(currentUser){checkUnreadMessages();checkUnreadNotifications()}},15000);
setInterval(()=>{if(currentChatUserId)loadMessages()},5000);
init();
</script>
</body>
</html>