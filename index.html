<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RustEx Searching</title>
<link rel="icon" href="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" type="image/svg+xml">
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--rust-orange:#cd412b;--rust-red:#8b0000;--rust-dark:#131313;--rust-panel:rgba(30,30,30,0.95);--rust-metal:#2d2d2d;--rust-text:#cecece;--rust-green:#568a39}
    body{font-family:'Roboto',sans-serif;background:var(--rust-dark);color:var(--rust-text);min-height:100vh;background-image:url('https://files.facepunch.com/paddy/20230801/header_bg.jpg');background-size:cover;background-attachment:fixed;background-position:center}
    body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(15,15,15,0.93);z-index:-1}
    .rust-font{font-family:'Russo One',sans-serif;text-transform:uppercase;letter-spacing:1px}
    .text-rust-orange{color:var(--rust-orange)}
    .rust-btn{background:#567236;border:1px solid #7da558;color:#fff;padding:10px 24px;font-family:'Russo One';text-transform:uppercase;font-size:14px;cursor:pointer;transition:0.1s;text-shadow:1px 1px 0 rgba(0,0,0,0.5);display:inline-flex;align-items:center;justify-content:center}
    .rust-btn:hover{background:#658540;transform:translateY(-1px)}
    .rust-btn:active{transform:translateY(1px)}
    .rust-btn.red{background:var(--rust-orange);border-color:#ff6b4a}
    .rust-btn.red:hover{background:#d64d36}
    .rust-btn:disabled{opacity:0.5;cursor:not-allowed;filter:grayscale(1)}
    .rust-input{background:rgba(0,0,0,0.3);border:1px solid #444;padding:12px;color:#ddd;width:100%;font-family:'Roboto';transition:0.2s}
    .rust-input:focus{background:rgba(0,0,0,0.5);border-color:var(--rust-orange);outline:none}
    .rust-input:disabled{opacity:0.6;cursor:not-allowed;border-color:#333}
    .rust-panel{background:var(--rust-panel);border:1px solid #3d3d3d;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
    .nav-item{padding:0 20px;height:100%;display:flex;align-items:center;cursor:pointer;font-family:'Russo One';color:#888;text-transform:uppercase;font-size:14px;transition:0.2s;border-bottom:2px solid transparent}
    .nav-item:hover{color:#ccc;background:rgba(255,255,255,0.05)}
    .nav-item.active{color:var(--rust-orange);border-bottom-color:var(--rust-orange);background:linear-gradient(180deg,transparent,rgba(205,65,43,0.1))}
    .listing-card{transition:transform 0.2s, box-shadow 0.2s; border:1px solid #333}
    .listing-card:hover{transform:translateY(-3px);border-color:var(--rust-orange);box-shadow:0 10px 20px rgba(0,0,0,0.4)}
    .category-badge{font-family:'Russo One';font-size:10px;padding:3px 8px;text-transform:uppercase;letter-spacing:0.5px}
    .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:1000;align-items:center;justify-content:center;opacity:0;transition:opacity 0.2s}
    .modal.show{display:flex;opacity:1}
    .chat-msg{padding:8px 12px;border-radius:4px;max-width:80%;margin-bottom:6px;font-size:14px;line-height:1.4}
    .chat-msg.me{background:var(--rust-orange);color:white;align-self:flex-end;margin-left:auto}
    .chat-msg.them{background:#333;color:#ddd;align-self:flex-start}
    ::-webkit-scrollbar{width:6px}
    ::-webkit-scrollbar-track{background:#111}
    ::-webkit-scrollbar-thumb{background:#444;border-radius:3px}
    ::-webkit-scrollbar-thumb:hover{background:var(--rust-orange)}
    .toast{position:fixed;bottom:20px;right:20px;padding:15px 25px;background:#333;border-left:4px solid var(--rust-orange);color:white;transform:translateX(200%);transition:0.3s;z-index:2000;font-weight:bold}
    .toast.show{transform:translateX(0)}
    .toast.error{border-color:#ff4444;background:#2a1111}
</style>
</head>
<body>
<div id="app" class="flex flex-col h-screen overflow-hidden">
    <header class="h-16 bg-[#1a1a1a] border-b border-[#333] shrink-0 z-50 relative">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="app.nav('listings')">
                <img src="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" class="h-8 opacity-90">
                <span class="rust-font text-2xl text-white tracking-widest">RUST<span class="text-rust-orange">EX</span></span>
            </div>
            <nav class="hidden md:flex h-full" id="mainNav">
                <div class="nav-item active" data-page="listings" onclick="app.nav('listings')">–û–ë–™–Ø–í–õ–ï–ù–ò–Ø</div>
                <div class="nav-item relative" data-page="messages" onclick="app.nav('messages')">
                    –°–û–û–ë–©–ï–ù–ò–Ø <span id="unreadCount" class="ml-2 bg-red-600 text-white text-[10px] px-1.5 rounded-full hidden">0</span>
                </div>
                <div class="nav-item" data-page="profile" onclick="app.nav('profile')">–ü–†–û–§–ò–õ–¨</div>
            </nav>
            <div class="flex items-center gap-4">
                <div id="authBtns">
                    <button class="rust-btn" onclick="modal.show('login')">–í–û–ô–¢–ò</button>
                </div>
                <div id="userMenu" class="hidden flex items-center gap-3 cursor-pointer hover:opacity-80" onclick="app.nav('profile')">
                    <div class="text-right hidden sm:block">
                        <div id="headerUser" class="font-bold text-sm leading-tight"></div>
                        <div id="headerNick" class="text-xs text-[#888] leading-tight"></div>
                    </div>
                    <img id="headerAvatar" src="" class="w-9 h-9 rounded bg-[#333] object-cover border border-[#444]">
                </div>
            </div>
        </div>
    </header>
    <main class="flex-1 overflow-y-auto bg-[#0e0e0e] relative">
        <div class="max-w-7xl mx-auto px-4 py-8 min-h-full">
            <div id="page-listings" class="page-section">
                <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4 border-b border-[#222] pb-6">
                    <div>
                        <h1 class="rust-font text-3xl text-white mb-2">–ü–û–ò–°–ö –¢–ò–ú–ú–ï–ô–¢–û–í</h1>
                        <p class="text-[#666]">–ù–∞—Ö–æ–¥–∏ –∫–ª–∞–Ω—ã, –¥—Ä—É–∑–µ–π –∏ —Ä–∞–±–æ—Ç—É –∑–∞ —Å–µ—Ä—É</p>
                    </div>
                    <button id="createBtn" class="rust-btn red hidden" onclick="app.createListing()">+ –°–û–ó–î–ê–¢–¨ –û–ë–™–Ø–í–õ–ï–ù–ò–ï</button>
                </div>
                <div class="flex flex-wrap gap-2 mb-8">
                    <button class="rust-btn text-xs" onclick="app.filter('all')">–í–°–ï</button>
                    <button class="rust-btn text-xs" style="background:#222" onclick="app.filter('team')">üéÆ –í –¢–ò–ú–ú–£</button>
                    <button class="rust-btn text-xs" style="background:#222" onclick="app.filter('teammate')">üë§ –ù–ê–ü–ê–†–ù–ò–ö</button>
                    <button class="rust-btn text-xs" style="background:#222" onclick="app.filter('clan')">üè∞ –ö–õ–ê–ù</button>
                    <button class="rust-btn text-xs" style="background:#222" onclick="app.filter('work')">‚õèÔ∏è –†–ê–ë–û–¢–ê</button>
                </div>
                <div id="listingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="listingsEmpty" class="hidden text-center py-20 opacity-50">
                    <div class="text-6xl mb-4">‚ò¢Ô∏è</div>
                    <div class="rust-font">–ó–î–ï–°–¨ –ü–£–°–¢–û... –ü–û–ö–ê –ß–¢–û</div>
                </div>
            </div>
            <div id="page-profile" class="page-section hidden">
                <div class="rust-panel p-6 md:p-8 rounded mb-8">
                    <div class="flex flex-col md:flex-row gap-8 items-start">
                        <div class="relative group">
                            <img id="profAvatar" src="" class="w-32 h-32 object-cover bg-[#222] border-2 border-[#444]">
                            <label class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer transition">
                                üì∑
                                <input type="file" class="hidden" accept="image/*" onchange="app.uploadAvatar(this)">
                            </label>
                        </div>
                        <div class="flex-1 w-full">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h1 id="profUsername" class="rust-font text-3xl text-white"></h1>
                                    <div class="flex items-center gap-2 text-[#888] mt-1">
                                        <span>STEAM/GAME NICK:</span>
                                        <span id="profGameNick" class="text-rust-orange font-bold"></span>
                                    </div>
                                </div>
                                <button class="rust-btn text-xs" onclick="modal.show('editProfile')">–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨</button>
                            </div>
                            <div class="mt-6 p-4 bg-[#151515] border border-[#222] rounded min-h-[80px]">
                                <p id="profDesc" class="whitespace-pre-wrap text-[#aaa]"></p>
                            </div>
                            <div class="flex gap-4 mt-4" id="profSocials"></div>
                        </div>
                    </div>
                </div>
                <h2 class="rust-font text-xl mb-4 text-[#666]">–ú–û–ò –û–ë–™–Ø–í–õ–ï–ù–ò–Ø</h2>
                <div id="myListings" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div class="mt-8 border-t border-[#222] pt-4 text-right">
                    <button onclick="app.logout()" class="text-red-800 hover:text-red-500 text-sm font-bold uppercase">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
                </div>
            </div>
            <div id="page-messages" class="page-section hidden h-[calc(100vh-140px)]">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full">
                    <div class="rust-panel flex flex-col rounded overflow-hidden h-full">
                        <div class="p-3 bg-[#222] border-b border-[#333] font-bold text-[#888] text-sm uppercase tracking-wider">–î–∏–∞–ª–æ–≥–∏</div>
                        <div id="chatList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
                    </div>
                    <div class="rust-panel md:col-span-2 flex flex-col rounded overflow-hidden h-full relative">
                        <div id="chatHeader" class="p-3 bg-[#222] border-b border-[#333] flex justify-between items-center hidden">
                            <div class="flex items-center gap-3">
                                <img id="chatHeaderAvatar" class="w-8 h-8 rounded bg-black">
                                <span id="chatHeaderName" class="font-bold text-white"></span>
                            </div>
                        </div>
                        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2 bg-[#111]">
                            <div class="text-center text-[#444] mt-20">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥ —Å–ª–µ–≤–∞</div>
                        </div>
                        <div id="chatInputArea" class="p-3 bg-[#222] border-t border-[#333] hidden">
                            <form onsubmit="app.sendMessage(event)" class="flex gap-2">
                                <input type="text" id="msgInput" class="rust-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
                                <button type="submit" class="rust-btn">‚û§</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div id="page-viewListing" class="page-section hidden">
                <button onclick="app.nav('listings')" class="mb-4 text-[#666] hover:text-white uppercase font-bold text-xs">‚Üê –ù–∞–∑–∞–¥</button>
                <div class="rust-panel rounded overflow-hidden max-w-4xl mx-auto">
                    <div id="viewListImg" class="h-64 w-full bg-cover bg-center relative">
                        <div class="absolute inset-0 bg-gradient-to-t from-[#1e1e1e] to-transparent"></div>
                        <div class="absolute bottom-0 left-0 p-6">
                             <span id="viewListCat" class="bg-rust-orange text-white px-2 py-1 text-xs font-bold uppercase mb-2 inline-block"></span>
                             <h1 id="viewListTitle" class="rust-font text-3xl text-white drop-shadow-md"></h1>
                        </div>
                    </div>
                    <div class="p-6 md:p-8 flex flex-col md:flex-row gap-8">
                        <div class="flex-1">
                            <div class="mb-6 p-4 bg-[#151515] border border-[#333] rounded">
                                <p id="viewListDesc" class="whitespace-pre-wrap text-[#ccc] leading-relaxed"></p>
                            </div>
                            <div class="flex gap-4 items-center text-sm text-[#666]">
                                <span>üìÖ <span id="viewListDate"></span></span>
                                <span>üëÅ <span id="viewListViews">0</span></span>
                            </div>
                        </div>
                        <div class="md:w-72 flex-shrink-0">
                            <div class="bg-[#252525] p-4 rounded border border-[#444]">
                                <div class="flex items-center gap-3 mb-4 pb-4 border-b border-[#444] cursor-pointer hover:opacity-80" onclick="app.viewProfile(currentViewListing.user_id)">
                                    <img id="viewListAvatar" class="w-12 h-12 rounded bg-black object-cover">
                                    <div>
                                        <div id="viewListUser" class="font-bold text-white"></div>
                                        <div id="viewListNick" class="text-xs text-rust-orange"></div>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    <div id="viewListSocials" class="flex flex-col gap-2"></div>
                                    <button id="writeMsgBtn" class="rust-btn w-full mt-2">–ù–ê–ü–ò–°–ê–¢–¨</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
<div id="loginModal" class="modal">
    <div class="rust-panel p-8 w-96 rounded relative">
        <button onclick="modal.close()" class="absolute top-2 right-4 text-2xl text-[#666] hover:text-white">√ó</button>
        <h2 class="rust-font text-2xl text-center mb-6 text-white">–í–•–û–î</h2>
        <form onsubmit="app.login(event)">
            <div class="mb-4">
                <label class="text-xs text-[#888] mb-1 block uppercase">Email</label>
                <input type="email" id="logEmail" class="rust-input" required>
            </div>
            <div class="mb-6">
                <label class="text-xs text-[#888] mb-1 block uppercase">–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="logPass" class="rust-input" required>
            </div>
            <button type="submit" class="rust-btn w-full py-3">–í–û–ô–¢–ò</button>
        </form>
        <div class="text-center mt-4 text-xs text-[#666]">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span onclick="modal.switch('register')" class="text-rust-orange cursor-pointer hover:underline">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></div>
    </div>
</div>
<div id="registerModal" class="modal">
    <div class="rust-panel p-8 w-96 rounded relative">
        <button onclick="modal.close()" class="absolute top-2 right-4 text-2xl text-[#666] hover:text-white">√ó</button>
        <h2 class="rust-font text-2xl text-center mb-6 text-white">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</h2>
        <form onsubmit="app.register(event)">
            <div class="mb-3">
                <label class="text-xs text-[#888] mb-1 block uppercase">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–õ–æ–≥–∏–Ω)</label>
                <input type="text" id="regName" class="rust-input" required minlength="3" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ª–æ–≥–∏–Ω">
                <div class="text-[10px] text-[#555] mt-1">–ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –≤—Ö–æ–¥–∞ –∏ –ø–æ–∏—Å–∫–∞</div>
            </div>
            <div class="mb-3">
                <label class="text-xs text-[#888] mb-1 block uppercase">Email</label>
                <input type="email" id="regEmail" class="rust-input" required>
            </div>
            <div class="mb-6">
                <label class="text-xs text-[#888] mb-1 block uppercase">–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="regPass" class="rust-input" required minlength="6">
            </div>
            <button type="submit" class="rust-btn w-full py-3">–°–û–ó–î–ê–¢–¨ –ê–ö–ö–ê–£–ù–¢</button>
        </form>
        <div class="text-center mt-4 text-xs text-[#666]">–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <span onclick="modal.switch('login')" class="text-rust-orange cursor-pointer hover:underline">–í–æ–π—Ç–∏</span></div>
    </div>
</div>
<div id="createListingModal" class="modal">
    <div class="rust-panel p-6 w-full max-w-lg rounded relative max-h-[90vh] overflow-y-auto">
        <button onclick="modal.close()" class="absolute top-2 right-4 text-2xl text-[#666] hover:text-white">√ó</button>
        <h2 class="rust-font text-xl mb-4 text-white">–ù–û–í–û–ï –û–ë–™–Ø–í–õ–ï–ù–ò–ï</h2>
        <form onsubmit="app.submitListing(event)">
            <div class="mb-4">
                <label class="text-xs text-[#888] uppercase block mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select id="clCat" class="rust-input bg-[#222]" required>
                    <option value="team">üéÆ –ò—â—É –ø–∞—Ç–∏ (Team)</option>
                    <option value="teammate">üë§ –ò—â—É –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞ (Duo/Trio)</option>
                    <option value="clan">üè∞ –ù–∞–±–æ—Ä –≤ –∫–ª–∞–Ω / –ò—â—É –∫–ª–∞–Ω</option>
                    <option value="work">‚õèÔ∏è –§–∞—Ä–º–µ—Ä / –≠–ª–µ–∫—Ç—Ä–∏–∫ / –†–∞–±–æ—á–∏–π</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="text-xs text-[#888] uppercase block mb-1">–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–º–∞–∫—Å 30)</label>
                <input type="text" id="clTitle" class="rust-input" maxlength="30" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò—â—É –¥—É–æ –Ω–∞ Rustafied">
            </div>
            <div class="mb-4">
                <label class="text-xs text-[#888] uppercase block mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="clDesc" class="rust-input h-24" required placeholder="–û–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –æ–ø—ã—Ç, —á–∞—Å—ã, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è..."></textarea>
            </div>
            <div class="mb-4">
                <label class="text-xs text-[#888] uppercase block mb-2">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="file" id="clFile" accept="image/*" class="rust-input text-sm">
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="text-xs text-[#888] uppercase block mb-1">–ù–∏–∫ –≤ –∏–≥—Ä–µ</label>
                    <input type="text" id="clNick" class="rust-input" required>
                </div>
                <div>
                    <label class="text-xs text-[#888] uppercase block mb-1">VK (—Å—Å—ã–ª–∫–∞ –∏–ª–∏ ID)</label>
                    <input type="text" id="clVk" class="rust-input" placeholder="@id –∏–ª–∏ —Å—Å—ã–ª–∫–∞">
                </div>
            </div>
            <button type="submit" class="rust-btn w-full py-3">–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</button>
        </form>
    </div>
</div>
<div id="editProfileModal" class="modal">
    <div class="rust-panel p-6 w-full max-w-md rounded relative">
        <button onclick="modal.close()" class="absolute top-2 right-4 text-2xl text-[#666] hover:text-white">√ó</button>
        <h2 class="rust-font text-xl mb-4 text-white">–ù–ê–°–¢–†–û–ô–ö–ò –ü–†–û–§–ò–õ–Ø</h2>
        <form onsubmit="app.saveProfile(event)">
            <div class="mb-3">
                <label class="text-xs text-[#888] uppercase block mb-1">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                <input type="text" id="edUsername" class="rust-input" disabled title="–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å">
            </div>
            <div class="mb-3">
                <label class="text-xs text-[#888] uppercase block mb-1">–ù–∏–∫ –≤ –∏–≥—Ä–µ / Steam</label>
                <input type="text" id="edGameNick" class="rust-input" placeholder="–í–∞—à –Ω–∏–∫">
            </div>
            <div class="mb-3">
                <label class="text-xs text-[#888] uppercase block mb-1">–û —Å–µ–±–µ</label>
                <textarea id="edDesc" class="rust-input h-24" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –ø–∞—Ä—É —Å–ª–æ–≤ –æ —Å–µ–±–µ"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div>
                    <label class="text-xs text-[#888] uppercase block mb-1">Telegram</label>
                    <input type="text" id="edTg" class="rust-input" placeholder="@username">
                </div>
                <div>
                    <label class="text-xs text-[#888] uppercase block mb-1">VK</label>
                    <input type="text" id="edVk" class="rust-input" placeholder="@id –∏–ª–∏ —Å—Å—ã–ª–∫–∞">
                </div>
            </div>
            <button type="submit" class="rust-btn w-full">–°–û–•–†–ê–ù–ò–¢–¨</button>
        </form>
    </div>
</div>
<div id="toast" class="toast">Message</div>
<script>
const SUPABASE_URL = 'https://jerzhimcsxmgyxnwrojf.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplcnpoaW1jc3htZ3l4bndyb2pmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMzE0NDMsImV4cCI6MjA3OTkwNzQ0M30.zsZvnuqrtjahyeUr0nhXthbgKOwb3Yz_bsVC4rvfKPM';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const state = {
    user: null,
    profile: null,
    activePage: 'listings',
    filter: 'all',
    chatPartner: null
};
let currentViewListing = null;
const app = {
    async init() {
        sb.auth.onAuthStateChange(async (event, session) => {
            state.user = session?.user || null;
            if (state.user) {
                await app.loadProfile();
                document.getElementById('authBtns').classList.add('hidden');
                document.getElementById('userMenu').classList.remove('hidden');
                document.getElementById('userMenu').classList.add('flex');
                document.getElementById('createBtn').classList.remove('hidden');
                app.checkMessages();
            } else {
                state.profile = null;
                document.getElementById('authBtns').classList.remove('hidden');
                document.getElementById('userMenu').classList.add('hidden');
                document.getElementById('userMenu').classList.remove('flex');
                document.getElementById('createBtn').classList.add('hidden');
                app.nav('listings'); 
            }
            app.renderHeader();
        });
        app.loadListings();
    },
    nav(page) {
        document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if (page === 'messages' || page === 'profile') {
            if (!state.user) return modal.show('login');
        }
        document.getElementById(`page-${page}`).classList.remove('hidden');
        const navBtn = document.querySelector(`.nav-item[data-page="${page}"]`);
        if(navBtn) navBtn.classList.add('active');
        state.activePage = page;
        if(page === 'listings') app.loadListings();
        if(page === 'profile') app.renderProfilePage();
        if(page === 'messages') app.loadChats();
    },
    async loadProfile() {
        if (!state.user) return;
        const { data, error } = await sb.from('rustex_profiles').select('*').eq('user_id', state.user.id).single();
        if (data) state.profile = data;
    },
    renderHeader() {
        if (state.profile) {
            document.getElementById('headerUser').innerText = state.profile.username;
            document.getElementById('headerNick').innerText = state.profile.game_nick || '–ë–µ–∑ –Ω–∏–∫–∞';
            document.getElementById('headerAvatar').src = state.profile.avatar_url || `https://ui-avatars.com/api/?name=${state.profile.username}&background=567236&color=fff`;
        }
    },
    async register(e) {
        e.preventDefault();
        const username = document.getElementById('regName').value.trim();
        const email = document.getElementById('regEmail').value.trim();
        const password = document.getElementById('regPassword').value;
        const { data: exist } = await sb.from('rustex_profiles').select('id').eq('username', username).maybeSingle();
        if (exist) return toast.show('–≠—Ç–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ', 'error');
        const { data, error } = await sb.auth.signUp({ email, password });
        if (error) return toast.show(error.message, 'error');
        if (data.user) {
            const { error: profError } = await sb.from('rustex_profiles').insert({
                user_id: data.user.id,
                username: username,
                email: email
            });
            modal.close();
            toast.show('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É.', 'success');
        }
    },
    async login(e) {
        e.preventDefault();
        const email = document.getElementById('logEmail').value.trim();
        const password = document.getElementById('logPass').value;
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) return toast.show('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message, 'error');
        modal.close();
        toast.show('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!');
    },
    async logout() {
        await sb.auth.signOut();
        window.location.reload();
    },
    async loadListings() {
        let query = sb.from('rustex_listings').select('*, rustex_profiles(username, avatar_url)').order('created_at', { ascending: false });
        if (state.filter !== 'all') query = query.eq('category', state.filter);
        const { data, error } = await query;
        if (error) return console.error(error);
        const grid = document.getElementById('listingsGrid');
        const empty = document.getElementById('listingsEmpty');
        grid.innerHTML = '';
        if (!data || data.length === 0) {
            empty.classList.remove('hidden');
            return;
        }
        empty.classList.add('hidden');
        data.forEach(item => {
            const cats = {team:'TEAM', teammate:'DUO/TRIO', clan:'CLAN', work:'WORK'};
            const card = document.createElement('div');
            card.className = 'rust-panel listing-card rounded overflow-hidden cursor-pointer bg-[#1a1a1a]';
            card.onclick = () => app.viewListing(item.id);
            card.innerHTML = `
                <div class="h-32 bg-cover bg-center relative" style="background-image:url('${item.image_url}')">
                    <div class="absolute top-2 left-2 bg-black/70 px-2 py-1 text-[10px] font-bold text-white uppercase border border-white/20">
                        ${cats[item.category] || item.category}
                    </div>
                </div>
                <div class="p-3">
                    <h3 class="font-bold text-white truncate text-sm mb-1">${app.esc(item.title)}</h3>
                    <div class="flex items-center gap-2 mt-2 pt-2 border-t border-[#333]">
                        <img src="${item.rustex_profiles?.avatar_url || 'https://placehold.co/40'}" class="w-6 h-6 rounded-full">
                        <span class="text-xs text-[#888] truncate">${app.esc(item.rustex_profiles?.username)}</span>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    },
    filter(cat) {
        state.filter = cat;
        app.loadListings();
    },
    async createListing() {
        if (!state.user) return modal.show('login');
        if(!state.profile.game_nick || state.profile.game_nick === '') {
            toast.show('–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏ –Ω–∏–∫ –≤ –ø—Ä–æ—Ñ–∏–ª–µ!', 'error');
            app.nav('profile');
            setTimeout(() => modal.show('editProfile'), 500);
            return;
        }
        document.getElementById('clNick').value = state.profile.game_nick;
        document.getElementById('clVk').value = state.profile.vk !== '-' ? state.profile.vk : '';
        document.getElementById('clFile').value = '';
        modal.show('createListing');
    },
    async submitListing(e) {
        e.preventDefault();
        let imgUrl = 'https://files.facepunch.com/paddy/20230801/header_bg.jpg';
        const fileInput = document.getElementById('clFile');
        
        if(fileInput.files && fileInput.files[0]) {
            const file = fileInput.files[0];
            if(file.size > 3000000) return toast.show('–ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è (–º–∞–∫—Å 3–ú–ë)', 'error');
            try {
                imgUrl = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            } catch(err) {
                return toast.show('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ', 'error');
            }
        }

        const form = {
            user_id: state.user.id,
            category: document.getElementById('clCat').value,
            title: document.getElementById('clTitle').value,
            description: document.getElementById('clDesc').value,
            image_url: imgUrl,
            game_nick: document.getElementById('clNick').value,
            vk: app.formatVk(document.getElementById('clVk').value),
            telegram: '-' 
        };
        const { error } = await sb.from('rustex_listings').insert(form);
        if (error) return toast.show(error.message, 'error');
        modal.close();
        toast.show('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!');
        app.loadListings();
        document.querySelector('#createListingModal form').reset();
    },
    async viewListing(id) {
        const { data, error } = await sb.from('rustex_listings').select('*, rustex_profiles(*)').eq('id', id).single();
        if (error || !data) return toast.show('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
        currentViewListing = data;
        const p = data.rustex_profiles;
        document.getElementById('viewListTitle').innerText = data.title;
        document.getElementById('viewListDesc').innerText = data.description;
        document.getElementById('viewListCat').innerText = data.category;
        document.getElementById('viewListImg').style.backgroundImage = `url('${data.image_url}')`;
        document.getElementById('viewListViews').innerText = (data.views || 0) + 1;
        document.getElementById('viewListDate').innerText = new Date(data.created_at).toLocaleDateString();
        document.getElementById('viewListUser').innerText = p.username;
        document.getElementById('viewListNick').innerText = 'üéÆ ' + data.game_nick;
        document.getElementById('viewListAvatar').src = p.avatar_url || 'https://placehold.co/100';
        const socialsDiv = document.getElementById('viewListSocials');
        socialsDiv.innerHTML = '';
        if(data.vk && data.vk !== '-') {
            socialsDiv.innerHTML += `<a href="${data.vk}" target="_blank" class="block bg-[#2787F5] text-white text-center text-xs font-bold py-2 rounded hover:opacity-90">VKONTAKTE</a>`;
        }
        const btn = document.getElementById('writeMsgBtn');
        if(state.user && state.user.id === data.user_id) {
            btn.innerText = '–≠–¢–û –í–ê–®–ï –û–ë–™–Ø–í–õ–ï–ù–ò–ï';
            btn.disabled = true;
            btn.classList.add('opacity-50');
        } else {
            btn.innerText = '–ù–ê–ü–ò–°–ê–¢–¨ –°–û–û–ë–©–ï–ù–ò–ï';
            btn.disabled = false;
            btn.classList.remove('opacity-50');
            btn.onclick = () => app.startChat(data.user_id);
        }
        app.nav('viewListing');
        sb.from('rustex_listings').update({ views: (data.views || 0) + 1 }).eq('id', id).then();
    },
    async viewProfile(userId) {
        if(state.user && userId === state.user.id) return app.nav('profile');
    },
    async renderProfilePage() {
        if(!state.profile) return;
        const p = state.profile;
        document.getElementById('profUsername').innerText = p.username;
        document.getElementById('profGameNick').innerText = p.game_nick || '–ù–µ —É–∫–∞–∑–∞–Ω';
        document.getElementById('profDesc').innerText = p.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç...';
        document.getElementById('profAvatar').src = p.avatar_url || `https://ui-avatars.com/api/?name=${p.username}`;
        const { data } = await sb.from('rustex_listings').select('*').eq('user_id', state.user.id);
        const listDiv = document.getElementById('myListings');
        listDiv.innerHTML = (data || []).map(l => `
            <div class="rust-panel p-3 flex justify-between items-center bg-[#1a1a1a]">
                <div class="font-bold truncate w-1/2 text-white text-sm">${app.esc(l.title)}</div>
                <button class="text-red-500 hover:text-red-400 text-xs uppercase font-bold" onclick="app.deleteListing('${l.id}')">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        `).join('') || '<div class="text-[#444] text-sm">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π</div>';
        document.getElementById('edUsername').value = p.username;
        document.getElementById('edGameNick').value = p.game_nick;
        document.getElementById('edDesc').value = p.description;
        document.getElementById('edVk').value = p.vk === '-' ? '' : p.vk;
        document.getElementById('edTg').value = p.telegram === '-' ? '' : p.telegram;
    },
    async saveProfile(e) {
        e.preventDefault();
        const updates = {
            game_nick: document.getElementById('edGameNick').value,
            description: document.getElementById('edDesc').value,
            vk: app.formatVk(document.getElementById('edVk').value),
            telegram: document.getElementById('edTg').value || '-'
        };
        const { error } = await sb.from('rustex_profiles').update(updates).eq('user_id', state.user.id);
        if(error) return toast.show(error.message, 'error');
        await app.loadProfile();
        modal.close();
        app.renderProfilePage();
        toast.show('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
    },
    async uploadAvatar(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result;
                if(base64.length > 3000000) return toast.show('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π!', 'error');
                await sb.from('rustex_profiles').update({ avatar_url: base64 }).eq('user_id', state.user.id);
                app.loadProfile().then(() => app.renderProfilePage());
            }
            reader.readAsDataURL(input.files[0]);
        }
    },
    async deleteListing(id) {
        if(!confirm('–£–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?')) return;
        await sb.from('rustex_listings').delete().eq('id', id);
        app.renderProfilePage();
    },
    async startChat(targetId) {
        if(!state.user) return modal.show('login');
        state.chatPartner = targetId;
        app.nav('messages');
        app.loadMessages(targetId);
    },
    async loadChats() {
        const { data: sent } = await sb.from('rustex_messages').select('receiver_id').eq('sender_id', state.user.id);
        const { data: recv } = await sb.from('rustex_messages').select('sender_id').eq('receiver_id', state.user.id);
        const ids = new Set([...(sent||[]).map(x=>x.receiver_id), ...(recv||[]).map(x=>x.sender_id)]);
        if(ids.size === 0) {
            document.getElementById('chatList').innerHTML = '<div class="text-[#444] text-center text-xs mt-4">–ù–µ—Ç —á–∞—Ç–æ–≤</div>';
            return;
        }
        const { data: users } = await sb.from('rustex_profiles').select('*').in('user_id', Array.from(ids));
        document.getElementById('chatList').innerHTML = users.map(u => `
            <div class="p-3 hover:bg-[#2a2a2a] cursor-pointer flex items-center gap-3 rounded transition ${state.chatPartner === u.user_id ? 'bg-[#2a2a2a] border-l-2 border-rust-orange' : ''}" onclick="app.loadMessages('${u.user_id}')">
                <img src="${u.avatar_url || 'https://placehold.co/30'}" class="w-8 h-8 rounded-full bg-black">
                <div class="overflow-hidden">
                    <div class="text-white text-sm font-bold truncate">${app.esc(u.username)}</div>
                    <div class="text-[#666] text-xs truncate">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —á–∞—Ç–∞</div>
                </div>
            </div>
        `).join('');
    },
    async loadMessages(partnerId) {
        state.chatPartner = partnerId;
        document.getElementById('chatHeader').classList.remove('hidden');
        document.getElementById('chatInputArea').classList.remove('hidden');
        const { data: partner } = await sb.from('rustex_profiles').select('*').eq('user_id', partnerId).single();
        document.getElementById('chatHeaderName').innerText = partner.username;
        document.getElementById('chatHeaderAvatar').src = partner.avatar_url || 'https://placehold.co/30';
        const { data } = await sb.from('rustex_messages').select('*')
            .or(`and(sender_id.eq.${state.user.id},receiver_id.eq.${partnerId}),and(sender_id.eq.${partnerId},receiver_id.eq.${state.user.id})`)
            .order('created_at', {ascending: true});
        const container = document.getElementById('chatMessages');
        container.innerHTML = data.map(m => `
            <div class="chat-msg ${m.sender_id === state.user.id ? 'me' : 'them'}">
                ${app.esc(m.content)}
            </div>
        `).join('');
        container.scrollTop = container.scrollHeight;
        await sb.from('rustex_messages').update({is_read: true}).eq('sender_id', partnerId).eq('receiver_id', state.user.id);
    },
    async sendMessage(e) {
        e.preventDefault();
        const inp = document.getElementById('msgInput');
        const txt = inp.value.trim();
        if(!txt || !state.chatPartner) return;
        await sb.from('rustex_messages').insert({
            sender_id: state.user.id,
            receiver_id: state.chatPartner,
            content: txt
        });
        inp.value = '';
        app.loadMessages(state.chatPartner);
    },
    async checkMessages() {
        const { count } = await sb.from('rustex_messages').select('*', { count: 'exact', head: true }).eq('receiver_id', state.user.id).eq('is_read', false);
        const badge = document.getElementById('unreadCount');
        if(count > 0) {
            badge.innerText = count;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    },
    formatVk(val) {
        if(!val || val === '-' || val.trim() === '') return '-';
        val = val.trim();
        if(val.startsWith('http')) return val;
        return 'https://vk.com/' + val.replace('@', '');
    },
    esc(str) {
        if(!str) return '';
        return str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }
};
const modal = {
    show(id) {
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
        document.getElementById(id + 'Modal').classList.add('show');
    },
    close() {
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
    },
    switch(id) {
        modal.close();
        setTimeout(() => modal.show(id), 200);
    }
};
const toast = {
    show(msg, type = 'success') {
        const el = document.getElementById('toast');
        el.innerText = msg;
        el.className = 'toast show ' + type;
        setTimeout(() => el.classList.remove('show'), 3000);
    }
};
app.init();
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) modal.close();
}
</script>
</body>
</html>
