<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RustEx Searching</title>
<link rel="icon" href="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" type="image/svg+xml">
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Roboto+Condensed:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--rust-orange:#cd412b;--rust-red:#a83222;--rust-dark:#1a1a1a;--rust-darker:#0f0f0f;--rust-darkest:#0a0a0a;--rust-metal:#2a2a2a;--rust-metal-light:#3a3a3a;--rust-light:#e0e0e0;--rust-gold:#c9a227;--rust-brown:#3d2c1f}
body{font-family:'Roboto',sans-serif;background:var(--rust-darkest);color:var(--rust-light);min-height:100vh}
body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:url('https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=1920&q=80') center/cover fixed;opacity:0.15;z-index:-2}
body::after{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(10,10,10,0.95) 0%,rgba(15,15,15,0.9) 50%,rgba(10,10,10,0.95) 100%);z-index:-1}
.rust-font{font-family:'Russo One',sans-serif;text-transform:uppercase;letter-spacing:3px}
.rust-font-condensed{font-family:'Roboto Condensed',sans-serif;text-transform:uppercase;letter-spacing:2px}
.rust-btn{background:linear-gradient(180deg,#cd412b 0%,#8b2216 50%,#6d1a11 100%);border:none;padding:14px 28px;color:#fff;font-family:'Roboto Condensed',sans-serif;font-weight:700;text-transform:uppercase;letter-spacing:2px;cursor:pointer;transition:all 0.2s;position:relative;box-shadow:0 4px 0 #4a0f0a,0 6px 20px rgba(0,0,0,0.5),inset 0 1px 0 rgba(255,255,255,0.2);text-shadow:0 2px 4px rgba(0,0,0,0.5)}
.rust-btn:hover{transform:translateY(-2px);box-shadow:0 6px 0 #4a0f0a,0 8px 25px rgba(205,65,43,0.4),inset 0 1px 0 rgba(255,255,255,0.2);background:linear-gradient(180deg,#e04a33 0%,#a82a1c 50%,#7d1f14 100%)}
.rust-btn:active{transform:translateY(2px);box-shadow:0 2px 0 #4a0f0a,0 3px 10px rgba(0,0,0,0.5),inset 0 1px 0 rgba(255,255,255,0.2)}
.rust-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.rust-btn-secondary{background:linear-gradient(180deg,#3a3a3a 0%,#2a2a2a 50%,#1a1a1a 100%);box-shadow:0 4px 0 #111,0 6px 20px rgba(0,0,0,0.5),inset 0 1px 0 rgba(255,255,255,0.1)}
.rust-btn-secondary:hover{background:linear-gradient(180deg,#4a4a4a 0%,#3a3a3a 50%,#2a2a2a 100%);box-shadow:0 6px 0 #111,0 8px 25px rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.1)}
.rust-input{background:linear-gradient(180deg,#1a1a1a 0%,#252525 100%);border:2px solid #3a3a3a;padding:14px 18px;color:#e0e0e0;width:100%;transition:all 0.2s;font-size:15px;box-shadow:inset 0 2px 8px rgba(0,0,0,0.5)}
.rust-input:focus{outline:none;border-color:var(--rust-orange);box-shadow:inset 0 2px 8px rgba(0,0,0,0.5),0 0 15px rgba(205,65,43,0.3)}
.rust-input::placeholder{color:#666}
.rust-card{background:linear-gradient(180deg,#252525 0%,#1a1a1a 100%);border:2px solid #333;position:relative;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
.rust-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#8b2216,#cd412b,#c9a227,#cd412b,#8b2216)}
.rust-card::after{content:'';position:absolute;top:4px;left:0;right:0;height:1px;background:rgba(255,255,255,0.1)}
.metal-header{background:linear-gradient(180deg,#2a2a2a 0%,#1a1a1a 100%);border-bottom:3px solid #333;box-shadow:0 4px 20px rgba(0,0,0,0.5)}
.metal-header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,transparent,var(--rust-orange),transparent)}
.nav-link{padding:16px 24px;cursor:pointer;transition:all 0.2s;border-bottom:3px solid transparent;text-transform:uppercase;letter-spacing:2px;font-size:13px;font-family:'Roboto Condensed',sans-serif;font-weight:700;color:#888;position:relative}
.nav-link:hover{color:var(--rust-orange);background:rgba(205,65,43,0.1)}
.nav-link.active{color:var(--rust-orange);border-bottom-color:var(--rust-orange);background:rgba(205,65,43,0.15)}
.nav-link.active::after{content:'';position:absolute;bottom:-3px;left:50%;transform:translateX(-50%);border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:6px solid var(--rust-orange)}
.listing-card{transition:all 0.3s;cursor:pointer}
.listing-card:hover{transform:translateY(-8px) scale(1.02);box-shadow:0 20px 50px rgba(0,0,0,0.6),0 0 30px rgba(205,65,43,0.2)}
.category-badge{font-size:11px;padding:6px 12px;text-transform:uppercase;letter-spacing:1px;font-weight:700;font-family:'Roboto Condensed',sans-serif}
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(5px)}
.modal.show{display:flex}
.chat-message{max-width:75%;padding:12px 16px;margin:8px 0;position:relative}
.chat-message.sent{background:linear-gradient(135deg,#cd412b,#a83222);margin-left:auto;border-radius:16px 16px 4px 16px;box-shadow:0 4px 15px rgba(205,65,43,0.3)}
.chat-message.received{background:linear-gradient(135deg,#3a3a3a,#2a2a2a);margin-right:auto;border-radius:16px 16px 16px 4px;box-shadow:0 4px 15px rgba(0,0,0,0.3)}
.avatar{width:50px;height:50px;border-radius:50%;object-fit:cover;border:3px solid var(--rust-orange);box-shadow:0 4px 15px rgba(0,0,0,0.4)}
.avatar-lg{width:130px;height:130px;border-width:4px}
.view-counter{display:flex;align-items:center;gap:6px;font-size:13px;color:#888;font-family:'Roboto Condensed',sans-serif}
.social-btn{width:42px;height:42px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.3s;box-shadow:0 4px 15px rgba(0,0,0,0.3)}
.social-btn:hover{transform:scale(1.15) translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.4)}
.tg-btn{background:linear-gradient(135deg,#0088cc,#006699)}
.vk-btn{background:linear-gradient(135deg,#4c75a3,#3d5f85)}
.toast{position:fixed;bottom:30px;right:30px;padding:18px 28px;border-radius:4px;z-index:2000;transform:translateX(150%);transition:transform 0.3s;font-family:'Roboto Condensed',sans-serif;font-weight:700;text-transform:uppercase;letter-spacing:1px;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
.toast.show{transform:translateX(0)}
.toast.success{background:linear-gradient(135deg,#22c55e,#16a34a)}
.toast.error{background:linear-gradient(135deg,#ef4444,#dc2626)}
.unread-badge{position:absolute;top:-8px;right:-8px;background:linear-gradient(135deg,#cd412b,#a83222);color:white;font-size:11px;min-width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 4px 10px rgba(205,65,43,0.5)}
.rust-divider{height:2px;background:linear-gradient(90deg,transparent,#444,transparent);margin:20px 0}
.glow-text{text-shadow:0 0 20px rgba(205,65,43,0.5),0 0 40px rgba(205,65,43,0.3)}
.section-title{position:relative;display:inline-block}
.section-title::after{content:'';position:absolute;bottom:-8px;left:0;width:60px;height:3px;background:linear-gradient(90deg,var(--rust-orange),transparent)}
::-webkit-scrollbar{width:10px}
::-webkit-scrollbar-track{background:#0a0a0a}
::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#3a3a3a,#2a2a2a);border-radius:5px;border:2px solid #0a0a0a}
::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg,#4a4a4a,#3a3a3a)}
.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(10,10,10,0.95);z-index:3000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px}
.loading-spinner{width:60px;height:60px;border:4px solid #333;border-top-color:var(--rust-orange);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.animate-pulse{animation:pulse 2s infinite}
</style>
</head>
<body>
<div id="loadingOverlay" class="loading-overlay">
<img src="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" alt="RustEx" class="h-20 animate-pulse">
<div class="loading-spinner"></div>
<div class="rust-font text-lg" style="color:var(--rust-orange)">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>
<div id="app" style="opacity:0;transition:opacity 0.5s">
<header class="sticky top-0 z-50 metal-header relative">
<div class="max-w-7xl mx-auto px-6">
<div class="flex items-center justify-between h-20">
<div class="flex items-center gap-4 cursor-pointer group" onclick="showPage('listings')">
<img src="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" alt="RustEx" class="h-12 transition-transform group-hover:scale-110">
<div>
<div class="flex items-center gap-2">
<span class="rust-font text-2xl glow-text" style="color:var(--rust-orange)">RustEx</span>
<span class="rust-font text-2xl text-white">Searching</span>
</div>
<div class="text-xs text-gray-500 tracking-widest">FIND YOUR TEAM</div>
</div>
</div>
<nav class="hidden md:flex items-center h-full" id="mainNav">
<div class="nav-link active h-full flex items-center" onclick="showPage('listings')">
<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M9 12l-4.463 2.346.853-4.97L2.036 6.06l4.992-.725L9 1l1.972 4.335 4.992.725-3.354 3.315.853 4.97z"/></svg>
–û–±—ä—è–≤–ª–µ–Ω–∏—è
</div>
<div class="nav-link h-full flex items-center relative" onclick="showPage('messages')" id="messagesNavBtn" style="display:none">
<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z"/></svg>
–°–æ–æ–±—â–µ–Ω–∏—è
<span class="unread-badge" id="unreadBadge" style="display:none">0</span>
</div>
<div class="nav-link h-full flex items-center" onclick="showPage('profile')" id="profileNavBtn" style="display:none">
<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M10 10a4 4 0 100-8 4 4 0 000 8zm-7 8a7 7 0 1114 0H3z"/></svg>
–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
</div>
</nav>
<div class="flex items-center gap-4">
<div id="authButtons">
<button class="rust-btn text-sm" onclick="showModal('loginModal')">
<svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3h-2V4H5v12h10v-2h2v3a1 1 0 01-1 1H4a1 1 0 01-1-1V3z"/><path d="M15.293 9.293a1 1 0 011.414 0l2 2a1 1 0 010 1.414l-2 2a1 1 0 01-1.414-1.414l.293-.293H8a1 1 0 110-2h7.586l-.293-.293a1 1 0 010-1.414z"/></svg>
–í–æ–π—Ç–∏
</button>
</div>
<div id="userMenu" style="display:none" class="flex items-center gap-4 cursor-pointer group" onclick="showPage('profile')">
<img id="headerAvatar" src="" class="w-12 h-12 rounded-full border-3 border-orange-600 transition-all group-hover:border-orange-400 group-hover:scale-105">
<div class="hidden md:block">
<span id="headerUsername" class="font-bold text-white group-hover:text-orange-400 transition-colors"></span>
<div class="text-xs text-gray-500">–û–Ω–ª–∞–π–Ω</div>
</div>
</div>
</div>
</div>
</div>
</header>
<main class="max-w-7xl mx-auto px-6 py-10">
<div id="listingsPage">
<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
<div>
<h1 class="rust-font text-4xl mb-3 glow-text section-title" style="color:var(--rust-orange)">–û–±—ä—è–≤–ª–µ–Ω–∏—è</h1>
<p class="text-gray-400 text-lg mt-4">–ù–∞–π–¥–∏ —Ç–∏–º–º–µ–π—Ç–æ–≤, –∫–ª–∞–Ω –∏–ª–∏ —Ä–∞–±–æ—Ç—É –≤ RustEx Remake</p>
</div>
<button class="rust-btn flex items-center gap-2" onclick="createListing()" id="createListingBtn" style="display:none">
<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"/></svg>
–°–æ–∑–¥–∞—Ç—å
</button>
</div>
<div class="flex flex-wrap gap-3 mb-8">
<button class="category-filter px-5 py-3 rounded text-sm transition-all bg-orange-600 text-white" data-category="all" onclick="filterCategory('all')">–í—Å–µ</button>
<button class="category-filter px-5 py-3 rounded text-sm transition-all bg-zinc-800 hover:bg-zinc-700 text-gray-300" data-category="team" onclick="filterCategory('team')">üéÆ –í —Ç–∏–º–º—É</button>
<button class="category-filter px-5 py-3 rounded text-sm transition-all bg-zinc-800 hover:bg-zinc-700 text-gray-300" data-category="teammate" onclick="filterCategory('teammate')">üë• –ù–∞–ø–∞—Ä–Ω–∏–∫–∞</button>
<button class="category-filter px-5 py-3 rounded text-sm transition-all bg-zinc-800 hover:bg-zinc-700 text-gray-300" data-category="clan_search" onclick="filterCategory('clan_search')">üè∞ –ò—â—É –∫–ª–∞–Ω</button>
<button class="category-filter px-5 py-3 rounded text-sm transition-all bg-zinc-800 hover:bg-zinc-700 text-gray-300" data-category="clan_recruit" onclick="filterCategory('clan_recruit')">‚öîÔ∏è –ù–∞–±–æ—Ä –≤ –∫–ª–∞–Ω</button>
<button class="category-filter px-5 py-3 rounded text-sm transition-all bg-zinc-800 hover:bg-zinc-700 text-gray-300" data-category="farmer" onclick="filterCategory('farmer')">üåæ –§–∞—Ä–º–µ—Ä</button>
<button class="category-filter px-5 py-3 rounded text-sm transition-all bg-zinc-800 hover:bg-zinc-700 text-gray-300" data-category="pvp" onclick="filterCategory('pvp')">üíÄ –ü–í–ü—à–µ—Ä</button>
</div>
<div id="listingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
<div id="listingsEmpty" class="text-center py-24" style="display:none">
<svg class="w-24 h-24 mx-auto mb-6 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"/></svg>
<h3 class="rust-font text-2xl mb-3 text-gray-400">–û–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</h3>
<p class="text-gray-500 text-lg">–ë—É–¥—å –ø–µ—Ä–≤—ã–º, –∫—Ç–æ —Å–æ–∑–¥–∞—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ!</p>
</div>
</div>
<div id="messagesPage" style="display:none">
<h1 class="rust-font text-4xl mb-8 glow-text section-title" style="color:var(--rust-orange)">–°–æ–æ–±—â–µ–Ω–∏—è</h1>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
<div class="rust-card rounded-lg p-5">
<h3 class="font-bold mb-5 text-gray-300 rust-font-condensed text-lg">–î–∏–∞–ª–æ–≥–∏</h3>
<div id="chatsList" class="space-y-3 max-h-[500px] overflow-y-auto"></div>
</div>
<div class="lg:col-span-2 rust-card rounded-lg flex flex-col" style="height:550px">
<div id="chatHeader" class="p-5 border-b border-zinc-700 flex items-center gap-4" style="display:none">
<img id="chatAvatar" src="" class="avatar">
<div class="flex-1">
<div id="chatName" class="font-bold text-lg"></div>
<div id="chatNick" class="text-sm text-gray-400"></div>
</div>
<button class="rust-btn-secondary rust-btn text-xs py-2 px-4" onclick="viewProfile(currentChatUserId)">–ü—Ä–æ—Ñ–∏–ª—å</button>
</div>
<div id="chatMessages" class="flex-1 p-5 overflow-y-auto"></div>
<div id="chatInput" class="p-5 border-t border-zinc-700" style="display:none">
<div class="flex gap-3">
<input type="text" id="messageInput" class="rust-input flex-1" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter')sendMessage()">
<button class="rust-btn px-6" onclick="sendMessage()">
<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/></svg>
</button>
</div>
</div>
<div id="chatEmpty" class="flex-1 flex items-center justify-center text-gray-500">
<div class="text-center">
<svg class="w-16 h-16 mx-auto mb-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z"/></svg>
<p class="rust-font-condensed text-lg">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥</p>
</div>
</div>
</div>
</div>
</div>
<div id="profilePage" style="display:none">
<div class="rust-card rounded-lg p-8 mb-8">
<div class="flex flex-col md:flex-row gap-8 items-start">
<div class="relative">
<img id="profileAvatar" src="" class="avatar avatar-lg">
<label class="absolute bottom-2 right-2 w-10 h-10 bg-orange-600 rounded-full flex items-center justify-center cursor-pointer hover:bg-orange-500 transition-colors shadow-lg">
<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z"/></svg>
<input type="file" accept="image/*" class="hidden" onchange="uploadAvatar(event)">
</label>
</div>
<div class="flex-1">
<h2 id="profileUsername" class="rust-font text-3xl mb-3 glow-text" style="color:var(--rust-orange)"></h2>
<div class="flex flex-wrap items-center gap-6 text-sm text-gray-400 mb-5">
<span class="flex items-center gap-2">
<svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/></svg>
<span id="profileNick">-</span>
</span>
<span class="flex items-center gap-2">
<svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1z"/></svg>
–£—á–∞—Å—Ç–Ω–∏–∫ —Å <span id="profileJoined"></span>
</span>
</div>
<div class="flex gap-3 mb-5" id="profileSocials"></div>
<p id="profileDesc" class="text-gray-300 leading-relaxed"></p>
</div>
<button class="rust-btn text-sm" onclick="showModal('editProfileModal')">
<svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/></svg>
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
</button>
</div>
</div>
<h3 class="rust-font text-2xl mb-6 section-title" style="color:var(--rust-orange)">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h3>
<div id="myListingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
</div>
<div id="viewListingPage" style="display:none">
<button class="mb-6 text-gray-400 hover:text-white flex items-center gap-2 transition-colors" onclick="showPage('listings')">
<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/></svg>
–ù–∞–∑–∞–¥ –∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º
</button>
<div class="rust-card rounded-lg overflow-hidden">
<div id="listingDetail"></div>
</div>
</div>
<div id="viewProfilePage" style="display:none">
<button class="mb-6 text-gray-400 hover:text-white flex items-center gap-2 transition-colors" onclick="showPage('listings')">
<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/></svg>
–ù–∞–∑–∞–¥
</button>
<div class="rust-card rounded-lg p-8 mb-8">
<div class="flex flex-col md:flex-row gap-8 items-start">
<img id="viewProfileAvatar" src="" class="avatar avatar-lg">
<div class="flex-1">
<h2 id="viewProfileUsername" class="rust-font text-3xl mb-3 glow-text" style="color:var(--rust-orange)"></h2>
<div class="flex items-center gap-6 text-sm text-gray-400 mb-5">
<span class="flex items-center gap-2">
<svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/></svg>
<span id="viewProfileNick">-</span>
</span>
</div>
<div class="flex gap-3 mb-5" id="viewProfileSocials"></div>
<p id="viewProfileDesc" class="text-gray-300 leading-relaxed"></p>
</div>
<button class="rust-btn" onclick="startChatWith(viewingUserId)">
<svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z"/></svg>
–ù–∞–ø–∏—Å–∞—Ç—å
</button>
</div>
</div>
<h3 class="rust-font text-2xl mb-6 section-title" style="color:var(--rust-orange)">–û–±—ä—è–≤–ª–µ–Ω–∏—è</h3>
<div id="userListingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
</div>
</main>
<footer class="border-t border-zinc-800 mt-20 py-10 text-center text-gray-500">
<div class="flex items-center justify-center gap-3 mb-4">
<img src="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" alt="RustEx" class="h-8 opacity-50">
<span class="rust-font text-lg">RustEx Searching</span>
</div>
<p class="text-sm">¬© 2024 RustEx Remake. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
</footer>
</div>
<div id="loginModal" class="modal">
<div class="rust-card rounded-lg p-10 w-full max-w-md mx-4 relative">
<div class="text-center mb-8">
<img src="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" alt="RustEx" class="h-14 mx-auto mb-4">
<h2 class="rust-font text-2xl glow-text" style="color:var(--rust-orange)">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
</div>
<form onsubmit="login(event)">
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">Email</label>
<input type="email" id="loginEmail" class="rust-input" required placeholder="your@email.com">
</div>
<div class="mb-8">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–ü–∞—Ä–æ–ª—å</label>
<input type="password" id="loginPassword" class="rust-input" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
</div>
<button type="submit" class="rust-btn w-full mb-5">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</button>
<p class="text-center text-gray-400">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span class="text-orange-500 cursor-pointer hover:underline font-bold" onclick="switchModal('registerModal')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></p>
</form>
<button class="absolute top-5 right-5 text-gray-500 hover:text-white text-3xl transition-colors" onclick="hideModal('loginModal')">√ó</button>
</div>
</div>
<div id="registerModal" class="modal">
<div class="rust-card rounded-lg p-10 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto relative">
<div class="text-center mb-8">
<img src="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" alt="RustEx" class="h-14 mx-auto mb-4">
<h2 class="rust-font text-2xl glow-text" style="color:var(--rust-orange)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
</div>
<form onsubmit="register(event)">
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
<input type="text" id="regUsername" class="rust-input" required minlength="3" maxlength="20" placeholder="CoolPlayer">
</div>
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">Email</label>
<input type="email" id="regEmail" class="rust-input" required placeholder="your@email.com">
</div>
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–ü–∞—Ä–æ–ª—å</label>
<input type="password" id="regPassword" class="rust-input" required minlength="6" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤">
</div>
<div class="mb-8">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–ù–∏–∫ –≤ RustEx Remake</label>
<input type="text" id="regGameNick" class="rust-input" placeholder="–í–∞—à –Ω–∏–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ">
</div>
<button type="submit" class="rust-btn w-full mb-5">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
<p class="text-center text-gray-400">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <span class="text-orange-500 cursor-pointer hover:underline font-bold" onclick="switchModal('loginModal')">–í–æ–π—Ç–∏</span></p>
</form>
<button class="absolute top-5 right-5 text-gray-500 hover:text-white text-3xl transition-colors" onclick="hideModal('registerModal')">√ó</button>
</div>
</div>
<div id="welcomeModal" class="modal">
<div class="rust-card rounded-lg p-10 w-full max-w-xl mx-4 relative">
<div class="text-center mb-8">
<img src="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" alt="RustEx" class="h-20 mx-auto mb-4">
<h2 class="rust-font text-3xl glow-text" style="color:var(--rust-orange)">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
</div>
<div class="space-y-4 mb-8">
<div class="flex items-start gap-4 p-4 bg-zinc-800/50 rounded-lg">
<span class="text-3xl">üéÆ</span>
<div>
<h4 class="font-bold text-white mb-1">RustEx Searching</h4>
<p class="text-gray-400 text-sm">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–∏–º–º–µ–π—Ç–æ–≤, –∫–ª–∞–Ω–æ–≤ –∏ —Ä–∞–±–æ—Ç—ã –≤ RustEx Remake</p>
</div>
</div>
<div class="flex items-start gap-4 p-4 bg-zinc-800/50 rounded-lg">
<span class="text-3xl">üìù</span>
<div>
<h4 class="font-bold text-white mb-1">–î–æ 3 –æ–±—ä—è–≤–ª–µ–Ω–∏–π</h4>
<p class="text-gray-400 text-sm">–¢—ã –º–æ–∂–µ—à—å —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–æ 3 –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ</p>
</div>
</div>
<div class="flex items-start gap-4 p-4 bg-zinc-800/50 rounded-lg">
<span class="text-3xl">üí¨</span>
<div>
<h4 class="font-bold text-white mb-1">–û–±—â–µ–Ω–∏–µ</h4>
<p class="text-gray-400 text-sm">–ü–∏—à–∏ –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º –ø—Ä—è–º–æ –Ω–∞ —Å–∞–π—Ç–µ</p>
</div>
</div>
<div class="flex items-start gap-4 p-4 bg-zinc-800/50 rounded-lg">
<span class="text-3xl">üë§</span>
<div>
<h4 class="font-bold text-white mb-1">–¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h4>
<p class="text-gray-400 text-sm">–ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏ —É–∑–Ω–∞–ª–∏ –æ —Ç–µ–±–µ –±–æ–ª—å—à–µ!</p>
</div>
</div>
</div>
<button class="rust-btn w-full" onclick="hideModal('welcomeModal');showPage('profile')">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
</div>
</div>
<div id="editProfileModal" class="modal">
<div class="rust-card rounded-lg p-10 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto relative">
<h2 class="rust-font text-xl text-center mb-8 glow-text" style="color:var(--rust-orange)">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h2>
<form onsubmit="updateProfile(event)">
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–ù–∏–∫ –≤ RustEx Remake</label>
<input type="text" id="editGameNick" class="rust-input" placeholder="–í–∞—à –Ω–∏–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ">
</div>
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">Telegram</label>
<input type="text" id="editTelegram" class="rust-input" placeholder="@username –∏–ª–∏ -">
</div>
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">VK</label>
<input type="text" id="editVk" class="rust-input" placeholder="https://vk.com/... –∏–ª–∏ -">
</div>
<div class="mb-8">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–û —Å–µ–±–µ</label>
<textarea id="editDescription" class="rust-input" rows="4" maxlength="500" placeholder="–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ..."></textarea>
</div>
<button type="submit" class="rust-btn w-full">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
</form>
<button class="absolute top-5 right-5 text-gray-500 hover:text-white text-3xl transition-colors" onclick="hideModal('editProfileModal')">√ó</button>
</div>
</div>
<div id="createListingModal" class="modal">
<div class="rust-card rounded-lg p-10 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto relative">
<h2 class="rust-font text-xl text-center mb-6 glow-text" style="color:var(--rust-orange)">–ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
<div id="listingHint" class="bg-orange-900/30 border border-orange-600/50 rounded-lg p-4 mb-6">
<div class="flex items-start gap-3">
<span class="text-2xl">üí°</span>
<div>
<h4 class="font-bold text-orange-400 mb-1">–ü–æ–¥—Å–∫–∞–∑–∫–∞</h4>
<p class="text-sm text-gray-300">–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è. –ï—Å–ª–∏ —É —Ç–µ–±—è –Ω–µ—Ç Telegram –∏–ª–∏ VK ‚Äî –Ω–∞–ø–∏—à–∏ "-"</p>
</div>
</div>
</div>
<form onsubmit="submitListing(event)">
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
<select id="listingCategory" class="rust-input" required>
<option value="">–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
<option value="team">üéÆ –ò—â—É –∏–≥—Ä–æ–∫–æ–≤ –≤ —Ç–∏–º–º—É</option>
<option value="teammate">üë• –ò—â—É –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞</option>
<option value="clan_search">üè∞ –ò—â—É –∫–ª–∞–Ω</option>
<option value="clan_recruit">‚öîÔ∏è –ù–∞–±–æ—Ä –≤ –∫–ª–∞–Ω</option>
<option value="farmer">üåæ –§–∞—Ä–º–µ—Ä (–∏—â—É —Ä–∞–±–æ—Ç—É)</option>
<option value="pvp">üíÄ –ü–í–ü—à–µ—Ä (–∏—â—É —Ä–∞–±–æ—Ç—É)</option>
</select>
</div>
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–ù–∞–∑–≤–∞–Ω–∏–µ (–¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤)</label>
<input type="text" id="listingTitle" class="rust-input" required maxlength="20" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
</div>
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–û–ø–∏—Å–∞–Ω–∏–µ (–¥–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤)</label>
<textarea id="listingDesc" class="rust-input" rows="4" required maxlength="1000" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
</div>
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É</label>
<input type="url" id="listingImage" class="rust-input" placeholder="https://...">
</div>
<div class="grid grid-cols-2 gap-4 mb-5">
<div>
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">Telegram</label>
<input type="text" id="listingTelegram" class="rust-input" placeholder="@username">
</div>
<div>
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">VK</label>
<input type="text" id="listingVk" class="rust-input" placeholder="—Å—Å—ã–ª–∫–∞ –∏–ª–∏ -">
</div>
</div>
<div class="mb-8">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–ù–∏–∫ –≤ RustEx Remake</label>
<input type="text" id="listingNick" class="rust-input" required placeholder="–í–∞—à –Ω–∏–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ">
</div>
<button type="submit" class="rust-btn w-full">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
</form>
<button class="absolute top-5 right-5 text-gray-500 hover:text-white text-3xl transition-colors" onclick="hideModal('createListingModal')">√ó</button>
</div>
</div>
<div id="toast" class="toast"></div>
<script>
const SUPABASE_URL='https://jerzhimcsxmgyxnwrojf.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplcnpoaW1jc3htZ3l4bndyb2pmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMzE0NDMsImV4cCI6MjA3OTkwNzQ0M30.zsZvnuqrtjahyeUr0nhXthbgKOwb3Yz_bsVC4rvfKPM';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let currentUser=null;
let currentProfile=null;
let currentCategory='all';
let viewingUserId=null;
let currentChatUserId=null;
let viewTimer=null;
const categoryLabels={team:'üéÆ –ü–æ–∏—Å–∫ –≤ —Ç–∏–º–º—É',teammate:'üë• –ü–æ–∏—Å–∫ –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞',clan_search:'üè∞ –ò—â—É –∫–ª–∞–Ω',clan_recruit:'‚öîÔ∏è –ù–∞–±–æ—Ä –≤ –∫–ª–∞–Ω',farmer:'üåæ –§–∞—Ä–º–µ—Ä',pvp:'üíÄ –ü–í–ü—à–µ—Ä'};
const categoryColors={team:'bg-blue-600',teammate:'bg-green-600',clan_search:'bg-purple-600',clan_recruit:'bg-red-600',farmer:'bg-yellow-600',pvp:'bg-pink-600'};
async function init(){
try{
const{data:{session}}=await supabase.auth.getSession();
if(session&&session.user){
currentUser=session.user;
await loadProfile();
}
updateUIForAuth();
await loadListings();
supabase.auth.onAuthStateChange(async(event,session)=>{
console.log('Auth event:',event);
if(event==='SIGNED_IN'&&session&&session.user){
currentUser=session.user;
await loadProfile();
updateUIForAuth();
loadListings();
}else if(event==='SIGNED_OUT'){
currentUser=null;
currentProfile=null;
updateUIForAuth();
loadListings();
}
});
}catch(err){
console.error('Init error:',err);
}finally{
document.getElementById('loadingOverlay').style.display='none';
document.getElementById('app').style.opacity='1';
}
}
async function loadProfile(){
if(!currentUser)return null;
try{
const{data,error}=await supabase.from('rustex_profiles').select('*').eq('user_id',currentUser.id).maybeSingle();
if(error)throw error;
if(data){
currentProfile=data;
if(data.is_new){
setTimeout(()=>showModal('welcomeModal'),500);
await supabase.from('rustex_profiles').update({is_new:false}).eq('user_id',currentUser.id);
}
return data;
}
return null;
}catch(err){
console.error('Load profile error:',err);
return null;
}
}
function updateUIForAuth(){
const authBtns=document.getElementById('authButtons');
const userMenu=document.getElementById('userMenu');
const createBtn=document.getElementById('createListingBtn');
const msgNav=document.getElementById('messagesNavBtn');
const profNav=document.getElementById('profileNavBtn');
if(currentUser&&currentProfile){
authBtns.style.display='none';
userMenu.style.display='flex';
createBtn.style.display='flex';
msgNav.style.display='flex';
profNav.style.display='flex';
const avatarUrl=currentProfile.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(currentProfile.username)}&background=cd412b&color=fff&size=128`;
document.getElementById('headerAvatar').src=avatarUrl;
document.getElementById('headerUsername').textContent=currentProfile.username;
checkUnreadMessages();
}else{
authBtns.style.display='block';
userMenu.style.display='none';
createBtn.style.display='none';
msgNav.style.display='none';
profNav.style.display='none';
}
}
async function register(e){
e.preventDefault();
const username=document.getElementById('regUsername').value.trim();
const email=document.getElementById('regEmail').value.trim();
const password=document.getElementById('regPassword').value;
const gameNick=document.getElementById('regGameNick').value.trim()||'-';
try{
const{data,error}=await supabase.auth.signUp({email,password,options:{data:{username}}});
if(error)throw error;
if(data.user){
const{error:profileError}=await supabase.from('rustex_profiles').insert({user_id:data.user.id,username,email,game_nick:gameNick,is_new:true});
if(profileError)console.error('Profile create error:',profileError);
hideModal('registerModal');
showToast('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.','success');
setTimeout(()=>showModal('loginModal'),1000);
}
}catch(err){
showToast(err.message||'–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏','error');
}
}
async function login(e){
e.preventDefault();
const email=document.getElementById('loginEmail').value.trim();
const password=document.getElementById('loginPassword').value;
try{
const{data,error}=await supabase.auth.signInWithPassword({email,password});
if(error)throw error;
if(data.user){
currentUser=data.user;
await loadProfile();
if(!currentProfile){
const username=email.split('@')[0];
await supabase.from('rustex_profiles').insert({user_id:data.user.id,username,email,is_new:true});
await loadProfile();
}
updateUIForAuth();
hideModal('loginModal');
showToast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, '+currentProfile.username+'!','success');
loadListings();
}
}catch(err){
showToast(err.message||'–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞','error');
}
}
async function logout(){
await supabase.auth.signOut();
currentUser=null;
currentProfile=null;
updateUIForAuth();
showPage('listings');
showToast('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞','success');
}
async function loadListings(){
try{
let query=supabase.from('rustex_listings').select('*').order('created_at',{ascending:false});
if(currentCategory!=='all')query=query.eq('category',currentCategory);
const{data,error}=await query;
const grid=document.getElementById('listingsGrid');
const empty=document.getElementById('listingsEmpty');
if(error||!data||data.length===0){
grid.innerHTML='';
empty.style.display='block';
return;
}
empty.style.display='none';
const userIds=[...new Set(data.map(l=>l.user_id))];
const{data:profiles}=await supabase.from('rustex_profiles').select('user_id,username,avatar_url').in('user_id',userIds);
const profileMap={};
(profiles||[]).forEach(p=>profileMap[p.user_id]=p);
grid.innerHTML=data.map(l=>{
const profile=profileMap[l.user_id]||{};
return `
<div class="rust-card listing-card rounded-lg overflow-hidden" onclick="viewListing('${l.id}')">
<div class="h-44 bg-cover bg-center relative" style="background-image:url('${l.image_url||'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=400'}')">
<div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
<div class="absolute bottom-4 left-4 right-4">
<span class="category-badge ${categoryColors[l.category]} rounded">${categoryLabels[l.category]}</span>
</div>
</div>
<div class="p-5">
<h3 class="font-bold text-lg mb-2 truncate text-white">${escapeHtml(l.title)}</h3>
<p class="text-gray-400 text-sm mb-4 line-clamp-2">${escapeHtml(l.description.substring(0,80))}...</p>
<div class="flex items-center justify-between">
<div class="flex items-center gap-3">
<img src="${profile.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(profile.username||'U')}&background=cd412b&color=fff`}" class="w-9 h-9 rounded-full border-2 border-zinc-600">
<span class="text-sm text-gray-300 font-medium">${escapeHtml(profile.username||'Unknown')}</span>
</div>
<div class="view-counter">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
${l.views||0}
</div>
</div>
</div>
</div>`;
}).join('');
}catch(err){
console.error('Load listings error:',err);
}
}
function filterCategory(cat){
currentCategory=cat;
document.querySelectorAll('.category-filter').forEach(b=>{
b.classList.remove('bg-orange-600','text-white');
b.classList.add('bg-zinc-800','text-gray-300');
if(b.dataset.category===cat){
b.classList.add('bg-orange-600','text-white');
b.classList.remove('bg-zinc-800','text-gray-300');
}
});
loadListings();
}
async function viewListing(id){
if(!currentUser){
showToast('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ','error');
showModal('loginModal');
return;
}
try{
const{data:l}=await supabase.from('rustex_listings').select('*').eq('id',id).single();
if(!l)return;
const{data:profile}=await supabase.from('rustex_profiles').select('*').eq('user_id',l.user_id).single();
showPage('viewListing');
document.getElementById('listingDetail').innerHTML=`
<div class="md:flex">
<div class="md:w-1/2 h-72 md:h-auto bg-cover bg-center relative" style="background-image:url('${l.image_url||'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=600'}')">
<div class="absolute inset-0 bg-gradient-to-r from-black/50 to-transparent md:bg-gradient-to-t"></div>
</div>
<div class="md:w-1/2 p-8">
<span class="category-badge ${categoryColors[l.category]} rounded inline-block mb-4">${categoryLabels[l.category]}</span>
<h1 class="rust-font text-3xl mb-5 glow-text" style="color:var(--rust-orange)">${escapeHtml(l.title)}</h1>
<p class="text-gray-300 mb-8 whitespace-pre-wrap leading-relaxed">${escapeHtml(l.description)}</p>
<div class="bg-zinc-800/50 rounded-lg p-5 mb-8">
<div class="grid grid-cols-2 gap-4 text-sm">
<div class="flex items-center gap-2">
<svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/></svg>
<span class="text-gray-400">–ù–∏–∫:</span>
<span class="text-white font-medium">${escapeHtml(l.game_nick)}</span>
</div>
<div class="flex items-center gap-2">
<svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
<span class="text-gray-400">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</span>
<span class="text-white font-medium">${l.views||0}</span>
</div>
</div>
</div>
<div class="flex items-center gap-5 p-4 bg-zinc-800/30 rounded-lg mb-8 cursor-pointer hover:bg-zinc-800/50 transition-colors" onclick="viewProfile('${l.user_id}')">
<img src="${profile?.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(profile?.username||'U')}&background=cd412b&color=fff`}" class="avatar">
<div class="flex-1">
<div class="font-bold text-lg text-white">${escapeHtml(profile?.username||'Unknown')}</div>
<div class="text-sm text-gray-400 flex items-center gap-2">
<svg class="w-4 h-4 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/></svg>
${escapeHtml(profile?.game_nick||'-')}
</div>
</div>
<svg class="w-6 h-6 text-gray-500" fill="currentColor" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/></svg>
</div>
<div class="flex flex-wrap gap-4">
${l.telegram&&l.telegram!=='-'?`<a href="${l.telegram.startsWith('@')?'https://t.me/'+l.telegram.slice(1):l.telegram.startsWith('http')?l.telegram:'https://t.me/'+l.telegram}" target="_blank" class="social-btn tg-btn"><svg class="w-5 h-5" fill="white" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg></a>`:''}
${l.vk&&l.vk!=='-'?`<a href="${l.vk.startsWith('http')?l.vk:'https://vk.com/'+l.vk}" target="_blank" class="social-btn vk-btn"><svg class="w-5 h-5" fill="white" viewBox="0 0 24 24"><path d="M15.684 0H8.316C1.592 0 0 1.592 0 8.316v7.368C0 22.408 1.592 24 8.316 24h7.368C22.408 24 24 22.408 24 15.684V8.316C24 1.592 22.408 0 15.684 0zm3.692 17.123h-1.744c-.66 0-.864-.525-2.05-1.727-1.033-1-1.49-1.135-1.744-1.135-.356 0-.458.102-.458.593v1.575c0 .424-.135.678-1.253.678-1.846 0-3.896-1.118-5.335-3.202C4.624 10.857 4 8.57 4 8.096c0-.254.102-.491.593-.491h1.744c.44 0 .61.203.78.678.863 2.49 2.303 4.675 2.896 4.675.22 0 .322-.102.322-.66V9.721c-.068-1.186-.695-1.287-.695-1.71 0-.203.17-.407.44-.407h2.743c.373 0 .508.203.508.643v3.473c0 .372.17.508.271.508.22 0 .407-.136.814-.542 1.27-1.422 2.18-3.61 2.18-3.61.119-.254.322-.491.763-.491h1.744c.525 0 .644.27.525.643-.22 1.017-2.354 4.031-2.354 4.031-.186.305-.254.44 0 .78.186.254.796.779 1.203 1.253.745.847 1.32 1.558 1.473 2.05.17.49-.085.744-.576.744z"/></svg></a>`:''}
<button class="rust-btn flex-1" onclick="startChatWith('${l.user_id}')">
<svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z"/></svg>
–ù–∞–ø–∏—Å–∞—Ç—å
</button>
</div>
</div>
</div>`;
if(viewTimer)clearTimeout(viewTimer);
viewTimer=setTimeout(async()=>{
if(l.user_id!==currentUser?.id){
await supabase.from('rustex_listings').update({views:(l.views||0)+1}).eq('id',id);
}
},5000);
}catch(err){
console.error('View listing error:',err);
}
}
async function viewProfile(userId){
viewingUserId=userId;
try{
const{data:p}=await supabase.from('rustex_profiles').select('*').eq('user_id',userId).single();
if(!p)return;
showPage('viewProfile');
document.getElementById('viewProfileAvatar').src=p.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(p.username)}&background=cd412b&color=fff&size=128`;
document.getElementById('viewProfileUsername').textContent=p.username;
document.getElementById('viewProfileNick').textContent=p.game_nick||'-';
document.getElementById('viewProfileDesc').textContent=p.description||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω–∏–ª –æ–ø–∏—Å–∞–Ω–∏–µ.';
let socials='';
if(p.telegram&&p.telegram!=='-')socials+=`<a href="${p.telegram.startsWith('@')?'https://t.me/'+p.telegram.slice(1):p.telegram.startsWith('http')?p.telegram:'https://t.me/'+p.telegram}" target="_blank" class="social-btn tg-btn"><svg class="w-5 h-5" fill="white" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg></a>`;
if(p.vk&&p.vk!=='-')socials+=`<a href="${p.vk.startsWith('http')?p.vk:'https://vk.com/'+p.vk}" target="_blank" class="social-btn vk-btn"><svg class="w-5 h-5" fill="white" viewBox="0 0 24 24"><path d="M15.684 0H8.316C1.592 0 0 1.592 0 8.316v7.368C0 22.408 1.592 24 8.316 24h7.368C22.408 24 24 22.408 24 15.684V8.316C24 1.592 22.408 0 15.684 0zm3.692 17.123h-1.744c-.66 0-.864-.525-2.05-1.727-1.033-1-1.49-1.135-1.744-1.135-.356 0-.458.102-.458.593v1.575c0 .424-.135.678-1.253.678-1.846 0-3.896-1.118-5.335-3.202C4.624 10.857 4 8.57 4 8.096c0-.254.102-.491.593-.491h1.744c.44 0 .61.203.78.678.863 2.49 2.303 4.675 2.896 4.675.22 0 .322-.102.322-.66V9.721c-.068-1.186-.695-1.287-.695-1.71 0-.203.17-.407.44-.407h2.743c.373 0 .508.203.508.643v3.473c0 .372.17.508.271.508.22 0 .407-.136.814-.542 1.27-1.422 2.18-3.61 2.18-3.61.119-.254.322-.491.763-.491h1.744c.525 0 .644.27.525.643-.22 1.017-2.354 4.031-2.354 4.031-.186.305-.254.44 0 .78.186.254.796.779 1.203 1.253.745.847 1.32 1.558 1.473 2.05.17.49-.085.744-.576.744z"/></svg></a>`;
document.getElementById('viewProfileSocials').innerHTML=socials;
const{data:listings}=await supabase.from('rustex_listings').select('*').eq('user_id',userId);
document.getElementById('userListingsGrid').innerHTML=(listings||[]).map(l=>`
<div class="rust-card listing-card rounded-lg overflow-hidden" onclick="viewListing('${l.id}')">
<div class="h-36 bg-cover bg-center relative" style="background-image:url('${l.image_url||'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=400'}')">
<div class="absolute inset-0 bg-gradient-to-t from-black to-transparent"></div>
</div>
<div class="p-5">
<span class="category-badge ${categoryColors[l.category]} rounded text-xs">${categoryLabels[l.category]}</span>
<h3 class="font-bold mt-3 text-white">${escapeHtml(l.title)}</h3>
<div class="view-counter mt-3">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
${l.views||0}
</div>
</div>
</div>
`).join('')||'<p class="text-gray-500 col-span-3 text-center py-10">–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p>';
}catch(err){
console.error('View profile error:',err);
}
}
function showPage(page){
document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
['listingsPage','messagesPage','profilePage','viewListingPage','viewProfilePage'].forEach(p=>document.getElementById(p).style.display='none');
if(page==='listings'){
document.getElementById('listingsPage').style.display='block';
document.querySelector('.nav-link').classList.add('active');
loadListings();
}else if(page==='messages'){
if(!currentUser){showModal('loginModal');return}
document.getElementById('messagesPage').style.display='block';
document.getElementById('messagesNavBtn').classList.add('active');
loadChats();
}else if(page==='profile'){
if(!currentUser){showModal('loginModal');return}
document.getElementById('profilePage').style.display='block';
document.getElementById('profileNavBtn').classList.add('active');
loadMyProfile();
}else if(page==='viewListing'){
document.getElementById('viewListingPage').style.display='block';
}else if(page==='viewProfile'){
document.getElementById('viewProfilePage').style.display='block';
}
window.scrollTo(0,0);
}
async function loadMyProfile(){
if(!currentProfile)return;
document.getElementById('profileAvatar').src=currentProfile.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(currentProfile.username)}&background=cd412b&color=fff&size=128`;
document.getElementById('profileUsername').textContent=currentProfile.username;
document.getElementById('profileNick').textContent=currentProfile.game_nick||'-';
document.getElementById('profileDesc').textContent=currentProfile.description||'–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏ —É–∑–Ω–∞–ª–∏ –æ –≤–∞—Å –±–æ–ª—å—à–µ.';
document.getElementById('profileJoined').textContent=new Date(currentProfile.created_at).toLocaleDateString('ru');
let socials='';
if(currentProfile.telegram&&currentProfile.telegram!=='-')socials+=`<a href="${currentProfile.telegram.startsWith('@')?'https://t.me/'+currentProfile.telegram.slice(1):'https://t.me/'+currentProfile.telegram}" target="_blank" class="social-btn tg-btn"><svg class="w-5 h-5" fill="white" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg></a>`;
if(currentProfile.vk&&currentProfile.vk!=='-')socials+=`<a href="${currentProfile.vk}" target="_blank" class="social-btn vk-btn"><svg class="w-5 h-5" fill="white" viewBox="0 0 24 24"><path d="M15.684 0H8.316C1.592 0 0 1.592 0 8.316v7.368C0 22.408 1.592 24 8.316 24h7.368C22.408 24 24 22.408 24 15.684V8.316C24 1.592 22.408 0 15.684 0zm3.692 17.123h-1.744c-.66 0-.864-.525-2.05-1.727-1.033-1-1.49-1.135-1.744-1.135-.356 0-.458.102-.458.593v1.575c0 .424-.135.678-1.253.678-1.846 0-3.896-1.118-5.335-3.202C4.624 10.857 4 8.57 4 8.096c0-.254.102-.491.593-.491h1.744c.44 0 .61.203.78.678.863 2.49 2.303 4.675 2.896 4.675.22 0 .322-.102.322-.66V9.721c-.068-1.186-.695-1.287-.695-1.71 0-.203.17-.407.44-.407h2.743c.373 0 .508.203.508.643v3.473c0 .372.17.508.271.508.22 0 .407-.136.814-.542 1.27-1.422 2.18-3.61 2.18-3.61.119-.254.322-.491.763-.491h1.744c.525 0 .644.27.525.643-.22 1.017-2.354 4.031-2.354 4.031-.186.305-.254.44 0 .78.186.254.796.779 1.203 1.253.745.847 1.32 1.558 1.473 2.05.17.49-.085.744-.576.744z"/></svg></a>`;
socials+=`<button class="rust-btn-secondary rust-btn text-xs py-2 px-4" onclick="logout()">–í—ã–π—Ç–∏</button>`;
document.getElementById('profileSocials').innerHTML=socials;
document.getElementById('editGameNick').value=currentProfile.game_nick||'';
document.getElementById('editTelegram').value=currentProfile.telegram||'';
document.getElementById('editVk').value=currentProfile.vk||'';
document.getElementById('editDescription').value=currentProfile.description||'';
const{data:myListings}=await supabase.from('rustex_listings').select('*').eq('user_id',currentUser.id);
document.getElementById('myListingsGrid').innerHTML=(myListings||[]).map(l=>`
<div class="rust-card listing-card rounded-lg overflow-hidden">
<div class="h-36 bg-cover bg-center relative" style="background-image:url('${l.image_url||'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=400'}')">
<div class="absolute inset-0 bg-gradient-to-t from-black to-transparent"></div>
</div>
<div class="p-5">
<span class="category-badge ${categoryColors[l.category]} rounded text-xs">${categoryLabels[l.category]}</span>
<h3 class="font-bold mt-3 text-white">${escapeHtml(l.title)}</h3>
<div class="flex justify-between items-center mt-4">
<div class="view-counter">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
${l.views||0}
</div>
<button class="text-red-500 hover:text-red-400 text-sm flex items-center gap-1 transition-colors" onclick="event.stopPropagation();deleteListing('${l.id}')">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/></svg>
–£–¥–∞–ª–∏—Ç—å
</button>
</div>
</div>
</div>
`).join('')||'<div class="col-span-3 text-center py-16"><svg class="w-16 h-16 mx-auto mb-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/></svg><p class="text-gray-500 text-lg">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p><button class="rust-btn mt-4" onclick="createListing()">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–µ</button></div>';
}
async function updateProfile(e){
e.preventDefault();
const updates={game_nick:document.getElementById('editGameNick').value||'-',telegram:document.getElementById('editTelegram').value||'-',vk:document.getElementById('editVk').value||'-',description:document.getElementById('editDescription').value};
await supabase.from('rustex_profiles').update(updates).eq('user_id',currentUser.id);
currentProfile={...currentProfile,...updates};
hideModal('editProfileModal');
loadMyProfile();
updateUIForAuth();
showToast('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!','success');
}
async function uploadAvatar(e){
const file=e.target.files[0];
if(!file)return;
if(file.size>500000){showToast('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 500KB)','error');return}
const reader=new FileReader();
reader.onload=async(ev)=>{
const avatarUrl=ev.target.result;
await supabase.from('rustex_profiles').update({avatar_url:avatarUrl}).eq('user_id',currentUser.id);
currentProfile.avatar_url=avatarUrl;
loadMyProfile();
updateUIForAuth();
showToast('–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!','success');
};
reader.readAsDataURL(file);
}
async function createListing(){
if(!currentUser){showModal('loginModal');return}
const{data:myListings}=await supabase.from('rustex_listings').select('id').eq('user_id',currentUser.id);
if(myListings&&myListings.length>=3){showToast('–ú–∞–∫—Å–∏–º—É–º 3 –æ–±—ä—è–≤–ª–µ–Ω–∏—è. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä–æ–µ.','error');return}
document.getElementById('listingNick').value=currentProfile?.game_nick||'';
document.getElementById('listingTelegram').value=currentProfile?.telegram||'';
document.getElementById('listingVk').value=currentProfile?.vk||'';
const hasListings=myListings&&myListings.length>0;
document.getElementById('listingHint').style.display=hasListings?'none':'block';
showModal('createListingModal');
}
async function submitListing(e){
e.preventDefault();
const listing={user_id:currentUser.id,category:document.getElementById('listingCategory').value,title:document.getElementById('listingTitle').value,description:document.getElementById('listingDesc').value,image_url:document.getElementById('listingImage').value||'',telegram:document.getElementById('listingTelegram').value||'-',vk:document.getElementById('listingVk').value||'-',game_nick:document.getElementById('listingNick').value,views:0};
const{error}=await supabase.from('rustex_listings').insert(listing);
if(error){showToast('–û—à–∏–±–∫–∞: '+error.message,'error');return}
hideModal('createListingModal');
document.querySelector('#createListingModal form').reset();
loadListings();
showToast('–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!','success');
}
async function deleteListing(id){
if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?'))return;
await supabase.from('rustex_listings').delete().eq('id',id);
loadMyProfile();
showToast('–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ','success');
}
async function loadChats(){
const{data:sent}=await supabase.from('rustex_messages').select('receiver_id').eq('sender_id',currentUser.id);
const{data:received}=await supabase.from('rustex_messages').select('sender_id').eq('receiver_id',currentUser.id);
const userIds=new Set();
(sent||[]).forEach(m=>userIds.add(m.receiver_id));
(received||[]).forEach(m=>userIds.add(m.sender_id));
if(userIds.size===0){
document.getElementById('chatsList').innerHTML='<div class="text-center py-10 text-gray-500"><svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z"/></svg><p>–ù–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤</p></div>';
return;
}
const{data:profiles}=await supabase.from('rustex_profiles').select('*').in('user_id',Array.from(userIds));
const{data:unread}=await supabase.from('rustex_messages').select('sender_id').eq('receiver_id',currentUser.id).eq('is_read',false);
const unreadMap={};
(unread||[]).forEach(m=>{unreadMap[m.sender_id]=(unreadMap[m.sender_id]||0)+1});
document.getElementById('chatsList').innerHTML=(profiles||[]).map(p=>`
<div class="flex items-center gap-4 p-4 rounded-lg cursor-pointer transition-all ${currentChatUserId===p.user_id?'bg-orange-600/20 border border-orange-600/50':'hover:bg-zinc-800/50'}" onclick="openChat('${p.user_id}')">
<img src="${p.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(p.username)}&background=cd412b&color=fff`}" class="w-12 h-12 rounded-full border-2 ${currentChatUserId===p.user_id?'border-orange-500':'border-zinc-600'}">
<div class="flex-1 min-w-0">
<div class="font-bold truncate ${currentChatUserId===p.user_id?'text-orange-400':'text-white'}">${escapeHtml(p.username)}</div>
<div class="text-xs text-gray-400 truncate flex items-center gap-1">
<svg class="w-3 h-3 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/></svg>
${escapeHtml(p.game_nick||'-')}
</div>
</div>
${unreadMap[p.user_id]?`<span class="bg-orange-600 text-white text-xs px-2 py-1 rounded-full font-bold min-w-[24px] text-center">${unreadMap[p.user_id]}</span>`:''}
</div>
`).join('');
}
async function openChat(userId){
currentChatUserId=userId;
loadChats();
const{data:p}=await supabase.from('rustex_profiles').select('*').eq('user_id',userId).single();
document.getElementById('chatHeader').style.display='flex';
document.getElementById('chatInput').style.display='block';
document.getElementById('chatEmpty').style.display='none';
document.getElementById('chatAvatar').src=p?.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(p?.username||'U')}&background=cd412b&color=fff`;
document.getElementById('chatName').textContent=p?.username||'Unknown';
document.getElementById('chatNick').textContent=p?.game_nick||'-';
await supabase.from('rustex_messages').update({is_read:true}).eq('sender_id',userId).eq('receiver_id',currentUser.id);
loadMessages();
checkUnreadMessages();
}
async function loadMessages(){
if(!currentChatUserId)return;
const{data}=await supabase.from('rustex_messages').select('*').or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${currentChatUserId}),and(sender_id.eq.${currentChatUserId},receiver_id.eq.${currentUser.id})`).order('created_at');
const container=document.getElementById('chatMessages');
container.innerHTML=(data||[]).map(m=>`
<div class="chat-message ${m.sender_id===currentUser.id?'sent':'received'}">
<div>${escapeHtml(m.content)}</div>
<div class="text-xs opacity-60 mt-1">${new Date(m.created_at).toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'})}</div>
</div>
`).join('');
container.scrollTop=container.scrollHeight;
}
async function sendMessage(){
const input=document.getElementById('messageInput');
const content=input.value.trim();
if(!content||!currentChatUserId)return;
await supabase.from('rustex_messages').insert({sender_id:currentUser.id,receiver_id:currentChatUserId,content});
input.value='';
loadMessages();
}
async function startChatWith(userId){
if(!currentUser){showModal('loginModal');return}
if(userId===currentUser.id){showToast('–ù–µ–ª—å–∑—è –Ω–∞–ø–∏—Å–∞—Ç—å —Å–µ–±–µ','error');return}
showPage('messages');
openChat(userId);
}
async function checkUnreadMessages(){
if(!currentUser)return;
const{data}=await supabase.from('rustex_messages').select('id').eq('receiver_id',currentUser.id).eq('is_read',false);
const badge=document.getElementById('unreadBadge');
if(data&&data.length>0){
badge.style.display='flex';
badge.textContent=data.length;
}else{
badge.style.display='none';
}
}
function showModal(id){hideAllModals();document.getElementById(id).classList.add('show')}
function hideModal(id){document.getElementById(id).classList.remove('show')}
function hideAllModals(){document.querySelectorAll('.modal').forEach(m=>m.classList.remove('show'))}
function switchModal(id){hideAllModals();setTimeout(()=>showModal(id),150)}
function showToast(msg,type='success'){
const t=document.getElementById('toast');
t.textContent=msg;
t.className='toast '+type+' show';
setTimeout(()=>t.classList.remove('show'),4000);
}
function escapeHtml(str){if(!str)return'';return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
document.querySelectorAll('.modal').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)hideModal(m.id)})});
setInterval(()=>{if(currentUser)checkUnreadMessages()},15000);
setInterval(()=>{if(currentChatUserId)loadMessages()},5000);
init();
</script>
</body>
</html>"