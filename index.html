<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RustEx Searching</title>
<link rel="icon" href="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" type="image/svg+xml">
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Roboto+Condensed:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--rust-orange:#cd412b;--rust-red:#a83222;--rust-dark:#1a1a1a;--rust-darker:#0f0f0f;--rust-darkest:#0a0a0a;--rust-metal:#2a2a2a;--rust-metal-light:#3a3a3a;--rust-light:#e0e0e0;--rust-gold:#c9a227;--rust-brown:#3d2c1f}
body{font-family:'Roboto',sans-serif;background:var(--rust-darkest);color:var(--rust-light);min-height:100vh}
body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:url('https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=1920&q=80') center/cover fixed;opacity:0.08;z-index:-2;pointer-events:none}
body::after{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(10,10,10,0.97) 0%,rgba(15,15,15,0.95) 50%,rgba(10,10,10,0.97) 100%);z-index:-1;pointer-events:none}
.rust-font{font-family:'Russo One',sans-serif;text-transform:uppercase;letter-spacing:3px}
.rust-font-condensed{font-family:'Roboto Condensed',sans-serif;text-transform:uppercase;letter-spacing:2px}
.rust-btn{background:linear-gradient(180deg,#cd412b 0%,#8b2216 50%,#6d1a11 100%);border:none;padding:14px 28px;color:#fff;font-family:'Roboto Condensed',sans-serif;font-weight:700;text-transform:uppercase;letter-spacing:2px;cursor:pointer;transition:all 0.2s;position:relative;box-shadow:0 4px 0 #4a0f0a,0 6px 20px rgba(0,0,0,0.5),inset 0 1px 0 rgba(255,255,255,0.2);text-shadow:0 2px 4px rgba(0,0,0,0.5)}
.rust-btn:hover{transform:translateY(-2px);box-shadow:0 6px 0 #4a0f0a,0 8px 25px rgba(205,65,43,0.4),inset 0 1px 0 rgba(255,255,255,0.2);background:linear-gradient(180deg,#e04a33 0%,#a82a1c 50%,#7d1f14 100%)}
.rust-btn:active{transform:translateY(2px);box-shadow:0 2px 0 #4a0f0a,0 3px 10px rgba(0,0,0,0.5),inset 0 1px 0 rgba(255,255,255,0.2)}
.rust-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.rust-btn-secondary{background:linear-gradient(180deg,#3a3a3a 0%,#2a2a2a 50%,#1a1a1a 100%);box-shadow:0 4px 0 #111,0 6px 20px rgba(0,0,0,0.5),inset 0 1px 0 rgba(255,255,255,0.1)}
.rust-btn-secondary:hover{background:linear-gradient(180deg,#4a4a4a 0%,#3a3a3a 50%,#2a2a2a 100%);box-shadow:0 6px 0 #111,0 8px 25px rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.1)}
.rust-input{background:linear-gradient(180deg,#1a1a1a 0%,#252525 100%);border:2px solid #3a3a3a;padding:14px 18px;color:#e0e0e0;width:100%;transition:all 0.2s;font-size:15px;box-shadow:inset 0 2px 8px rgba(0,0,0,0.5);border-radius:4px}
.rust-input:focus{outline:none;border-color:var(--rust-orange);box-shadow:inset 0 2px 8px rgba(0,0,0,0.5),0 0 15px rgba(205,65,43,0.3)}
.rust-input::placeholder{color:#666}
.rust-select{background:linear-gradient(180deg,#1a1a1a 0%,#252525 100%);border:2px solid #3a3a3a;padding:14px 18px;color:#e0e0e0;width:100%;font-size:15px;box-shadow:inset 0 2px 8px rgba(0,0,0,0.5);border-radius:4px;cursor:pointer}
.rust-select:focus{outline:none;border-color:var(--rust-orange)}
.rust-card{background:linear-gradient(180deg,#252525 0%,#1a1a1a 100%);border:2px solid #333;position:relative;box-shadow:0 10px 40px rgba(0,0,0,0.5);border-radius:8px}
.rust-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#8b2216,#cd412b,#c9a227,#cd412b,#8b2216);border-radius:8px 8px 0 0}
.metal-header{background:linear-gradient(180deg,#1a1a1a 0%,#0f0f0f 100%);border-bottom:3px solid #333;box-shadow:0 4px 20px rgba(0,0,0,0.5)}
.metal-header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,transparent,var(--rust-orange),transparent)}
.nav-link{padding:16px 24px;cursor:pointer;transition:all 0.2s;border-bottom:3px solid transparent;text-transform:uppercase;letter-spacing:2px;font-size:13px;font-family:'Roboto Condensed',sans-serif;font-weight:700;color:#888;position:relative}
.nav-link:hover{color:var(--rust-orange);background:rgba(205,65,43,0.1)}
.nav-link.active{color:var(--rust-orange);border-bottom-color:var(--rust-orange);background:rgba(205,65,43,0.15)}
.nav-link.active::after{content:'';position:absolute;bottom:-3px;left:50%;transform:translateX(-50%);border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:6px solid var(--rust-orange)}
.listing-card{transition:all 0.3s;cursor:pointer}
.listing-card:hover{transform:translateY(-8px) scale(1.02);box-shadow:0 20px 50px rgba(0,0,0,0.6),0 0 30px rgba(205,65,43,0.2)}
.category-badge{font-size:11px;padding:6px 12px;text-transform:uppercase;letter-spacing:1px;font-weight:700;font-family:'Roboto Condensed',sans-serif;border-radius:4px}
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(5px)}
.modal.show{display:flex}
.chat-message{max-width:75%;padding:12px 16px;margin:8px 0;position:relative}
.chat-message.sent{background:linear-gradient(135deg,#cd412b,#a83222);margin-left:auto;border-radius:16px 16px 4px 16px;box-shadow:0 4px 15px rgba(205,65,43,0.3)}
.chat-message.received{background:linear-gradient(135deg,#3a3a3a,#2a2a2a);margin-right:auto;border-radius:16px 16px 16px 4px;box-shadow:0 4px 15px rgba(0,0,0,0.3)}
.avatar{width:50px;height:50px;border-radius:50%;object-fit:cover;border:3px solid var(--rust-orange);box-shadow:0 4px 15px rgba(0,0,0,0.4)}
.avatar-lg{width:130px;height:130px;border-width:4px}
.view-counter{display:flex;align-items:center;gap:6px;font-size:13px;color:#888;font-family:'Roboto Condensed',sans-serif}
.social-btn{width:42px;height:42px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.3s;box-shadow:0 4px 15px rgba(0,0,0,0.3)}
.social-btn:hover{transform:scale(1.15) translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.4)}
.tg-btn{background:linear-gradient(135deg,#0088cc,#006699)}
.vk-btn{background:linear-gradient(135deg,#4c75a3,#3d5f85)}
.toast{position:fixed;bottom:30px;right:30px;padding:18px 28px;border-radius:4px;z-index:2000;transform:translateX(150%);transition:transform 0.3s;font-family:'Roboto Condensed',sans-serif;font-weight:700;text-transform:uppercase;letter-spacing:1px;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
.toast.show{transform:translateX(0)}
.toast.success{background:linear-gradient(135deg,#22c55e,#16a34a)}
.toast.error{background:linear-gradient(135deg,#ef4444,#dc2626)}
.unread-badge{position:absolute;top:-8px;right:-8px;background:linear-gradient(135deg,#cd412b,#a83222);color:white;font-size:11px;min-width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 4px 10px rgba(205,65,43,0.5)}
.glow-text{text-shadow:0 0 20px rgba(205,65,43,0.5),0 0 40px rgba(205,65,43,0.3)}
.section-title{position:relative;display:inline-block}
.section-title::after{content:'';position:absolute;bottom:-8px;left:0;width:60px;height:3px;background:linear-gradient(90deg,var(--rust-orange),transparent)}
::-webkit-scrollbar{width:10px}
::-webkit-scrollbar-track{background:#0a0a0a}
::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#3a3a3a,#2a2a2a);border-radius:5px;border:2px solid #0a0a0a}
::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg,#4a4a4a,#3a3a3a)}
.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(10,10,10,0.98);z-index:3000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px}
.loading-spinner{width:60px;height:60px;border:4px solid #333;border-top-color:var(--rust-orange);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.animate-pulse{animation:pulse 2s infinite}
.error-box{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;padding:16px;margin-bottom:16px}
.file-upload{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;border:2px dashed #3a3a3a;border-radius:8px;padding:30px;cursor:pointer;transition:all 0.3s;background:linear-gradient(180deg,#1a1a1a 0%,#252525 100%)}
.file-upload:hover{border-color:var(--rust-orange);background:rgba(205,65,43,0.05)}
.file-upload input{position:absolute;inset:0;opacity:0;cursor:pointer}
.file-upload img{max-width:100%;max-height:150px;border-radius:4px;margin-bottom:10px}
.online-dot{width:12px;height:12px;background:#22c55e;border-radius:50%;border:2px solid #1a1a1a;animation:pulse 2s infinite}
</style>
</head>
<body>
<div id="loadingOverlay" class="loading-overlay">
<img src="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" alt="RustEx" class="h-20 animate-pulse">
<div class="loading-spinner"></div>
<div class="rust-font text-lg" style="color:var(--rust-orange)">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>
<div id="app" style="opacity:0;transition:opacity 0.5s">
<header class="sticky top-0 z-50 metal-header relative">
<div class="max-w-7xl mx-auto px-6">
<div class="flex items-center justify-between h-20">
<div class="flex items-center gap-4 cursor-pointer group" onclick="showPage('listings')">
<img src="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" alt="RustEx" class="h-12 transition-transform group-hover:scale-110">
<div>
<div class="flex items-center gap-2">
<span class="rust-font text-2xl glow-text" style="color:var(--rust-orange)">RustEx</span>
<span class="rust-font text-2xl text-white">Searching</span>
</div>
<div class="text-xs text-gray-500 tracking-widest">–ù–ê–ô–î–ò –°–í–û–Æ –ö–û–ú–ê–ù–î–£</div>
</div>
</div>
<nav class="hidden md:flex items-center h-full" id="mainNav">
<div class="nav-link active h-full flex items-center" onclick="showPage('listings')" data-page="listings">
<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M9 12l-4.463 2.346.853-4.97L2.036 6.06l4.992-.725L9 1l1.972 4.335 4.992.725-3.354 3.315.853 4.97z"/></svg>
–û–±—ä—è–≤–ª–µ–Ω–∏—è
</div>
<div class="nav-link h-full flex items-center relative" onclick="showPage('messages')" id="messagesNavBtn" style="display:none" data-page="messages">
<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z"/></svg>
–°–æ–æ–±—â–µ–Ω–∏—è
<span class="unread-badge" id="unreadBadge" style="display:none">0</span>
</div>
<div class="nav-link h-full flex items-center" onclick="showPage('profile')" id="profileNavBtn" style="display:none" data-page="profile">
<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M10 10a4 4 0 100-8 4 4 0 000 8zm-7 8a7 7 0 1114 0H3z"/></svg>
–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
</div>
</nav>
<div class="flex items-center gap-4">
<div id="authButtons">
<button class="rust-btn text-sm" onclick="showModal('loginModal')">
<svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3h-2V4H5v12h10v-2h2v3a1 1 0 01-1 1H4a1 1 0 01-1-1V3z"/><path d="M15.293 9.293a1 1 0 011.414 0l2 2a1 1 0 010 1.414l-2 2a1 1 0 01-1.414-1.414l.293-.293H8a1 1 0 110-2h7.586l-.293-.293a1 1 0 010-1.414z"/></svg>
–í–æ–π—Ç–∏
</button>
</div>
<div id="userMenu" style="display:none" class="flex items-center gap-4 cursor-pointer group" onclick="showPage('profile')">
<div class="relative">
<img id="headerAvatar" src="" class="w-12 h-12 rounded-full border-3 border-orange-600 transition-all group-hover:border-orange-400 group-hover:scale-105">
<div class="online-dot absolute bottom-0 right-0"></div>
</div>
<div class="hidden md:block">
<span id="headerUsername" class="font-bold text-white group-hover:text-orange-400 transition-colors"></span>
<div class="text-xs text-green-500">–í —Å–µ—Ç–∏</div>
</div>
</div>
</div>
</div>
</div>
</header>
<main class="max-w-7xl mx-auto px-6 py-10">
<div id="listingsPage">
<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
<div>
<h1 class="rust-font text-4xl mb-3 glow-text section-title" style="color:var(--rust-orange)">–û–±—ä—è–≤–ª–µ–Ω–∏—è</h1>
<p class="text-gray-400 text-lg mt-4">–ù–∞–π–¥–∏ —Ç–∏–º–º–µ–π—Ç–æ–≤, –∫–ª–∞–Ω –∏–ª–∏ —Ä–∞–±–æ—Ç—É –≤ RustEx Remake</p>
</div>
<button class="rust-btn flex items-center gap-2" onclick="createListing()" id="createListingBtn" style="display:none">
<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"/></svg>
–°–æ–∑–¥–∞—Ç—å
</button>
</div>
<div class="flex flex-wrap gap-3 mb-8">
<button class="category-filter px-5 py-3 rounded text-sm transition-all bg-orange-600 text-white" data-category="all" onclick="filterCategory('all')">–í—Å–µ</button>
<button class="category-filter px-5 py-3 rounded text-sm transition-all bg-zinc-800 hover:bg-zinc-700 text-gray-300" data-category="team" onclick="filterCategory('team')">–í —Ç–∏–º–º—É</button>
<button class="category-filter px-5 py-3 rounded text-sm transition-all bg-zinc-800 hover:bg-zinc-700 text-gray-300" data-category="teammate" onclick="filterCategory('teammate')">–ù–∞–ø–∞—Ä–Ω–∏–∫–∞</button>
<button class="category-filter px-5 py-3 rounded text-sm transition-all bg-zinc-800 hover:bg-zinc-700 text-gray-300" data-category="clan_search" onclick="filterCategory('clan_search')">–ò—â—É –∫–ª–∞–Ω</button>
<button class="category-filter px-5 py-3 rounded text-sm transition-all bg-zinc-800 hover:bg-zinc-700 text-gray-300" data-category="clan_recruit" onclick="filterCategory('clan_recruit')">–ù–∞–±–æ—Ä –≤ –∫–ª–∞–Ω</button>
<button class="category-filter px-5 py-3 rounded text-sm transition-all bg-zinc-800 hover:bg-zinc-700 text-gray-300" data-category="farmer" onclick="filterCategory('farmer')">–§–∞—Ä–º–µ—Ä</button>
<button class="category-filter px-5 py-3 rounded text-sm transition-all bg-zinc-800 hover:bg-zinc-700 text-gray-300" data-category="pvp" onclick="filterCategory('pvp')">–ü–í–ü—à–µ—Ä</button>
</div>
<div id="listingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
<div id="listingsEmpty" class="text-center py-24" style="display:none">
<svg class="w-24 h-24 mx-auto mb-6 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"/></svg>
<h3 class="rust-font text-2xl mb-3 text-gray-400">–û–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</h3>
<p class="text-gray-500 text-lg">–ë—É–¥—å –ø–µ—Ä–≤—ã–º, –∫—Ç–æ —Å–æ–∑–¥–∞—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ!</p>
</div>
<div id="listingsLoading" class="text-center py-24">
<div class="loading-spinner mx-auto mb-4"></div>
<p class="text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π...</p>
</div>
</div>
<div id="messagesPage" style="display:none">
<h1 class="rust-font text-4xl mb-8 glow-text section-title" style="color:var(--rust-orange)">–°–æ–æ–±—â–µ–Ω–∏—è</h1>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
<div class="rust-card rounded-lg p-5">
<h3 class="font-bold mb-5 text-gray-300 rust-font-condensed text-lg">–î–∏–∞–ª–æ–≥–∏</h3>
<div id="chatsList" class="space-y-3 max-h-[500px] overflow-y-auto"></div>
</div>
<div class="lg:col-span-2 rust-card rounded-lg flex flex-col" style="height:550px">
<div id="chatHeader" class="p-5 border-b border-zinc-700 flex items-center gap-4" style="display:none">
<img id="chatAvatar" src="" class="avatar">
<div class="flex-1">
<div id="chatName" class="font-bold text-lg"></div>
<div id="chatNick" class="text-sm text-gray-400"></div>
</div>
<button class="rust-btn-secondary rust-btn text-xs py-2 px-4" onclick="viewProfile(currentChatUserId)">–ü—Ä–æ—Ñ–∏–ª—å</button>
</div>
<div id="chatMessages" class="flex-1 p-5 overflow-y-auto"></div>
<div id="chatInput" class="p-5 border-t border-zinc-700" style="display:none">
<div class="flex gap-3">
<input type="text" id="messageInput" class="rust-input flex-1" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter')sendMessage()">
<button class="rust-btn px-6" onclick="sendMessage()">
<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/></svg>
</button>
</div>
</div>
<div id="chatEmpty" class="flex-1 flex items-center justify-center text-gray-500">
<div class="text-center">
<svg class="w-16 h-16 mx-auto mb-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z"/></svg>
<p class="rust-font-condensed text-lg">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥</p>
</div>
</div>
</div>
</div>
</div>
<div id="profilePage" style="display:none">
<div class="rust-card rounded-lg p-8 mb-8">
<div class="flex flex-col md:flex-row gap-8 items-start">
<div class="relative">
<img id="profileAvatar" src="" class="avatar avatar-lg">
<label class="absolute bottom-2 right-2 w-10 h-10 bg-orange-600 rounded-full flex items-center justify-center cursor-pointer hover:bg-orange-500 transition-colors shadow-lg">
<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z"/></svg>
<input type="file" accept="image/*" class="hidden" onchange="uploadAvatar(event)">
</label>
</div>
<div class="flex-1">
<h2 id="profileUsername" class="rust-font text-3xl mb-3 glow-text" style="color:var(--rust-orange)"></h2>
<div class="flex flex-wrap items-center gap-6 text-sm text-gray-400 mb-5">
<span class="flex items-center gap-2">
<svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/></svg>
<span id="profileNick">-</span>
</span>
<span class="flex items-center gap-2">
<svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1z"/></svg>
–£—á–∞—Å—Ç–Ω–∏–∫ —Å <span id="profileJoined"></span>
</span>
</div>
<div class="flex gap-3 mb-5" id="profileSocials"></div>
<p id="profileDesc" class="text-gray-300 leading-relaxed"></p>
</div>
<button class="rust-btn text-sm" onclick="showModal('editProfileModal')">
<svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/></svg>
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
</button>
</div>
</div>
<h3 class="rust-font text-2xl mb-6 section-title" style="color:var(--rust-orange)">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h3>
<div id="myListingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
</div>
<div id="viewListingPage" style="display:none">
<button class="mb-6 text-gray-400 hover:text-white flex items-center gap-2 transition-colors" onclick="goBack()">
<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/></svg>
–ù–∞–∑–∞–¥ –∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º
</button>
<div class="rust-card rounded-lg overflow-hidden">
<div id="listingDetail"></div>
</div>
</div>
<div id="viewProfilePage" style="display:none">
<button class="mb-6 text-gray-400 hover:text-white flex items-center gap-2 transition-colors" onclick="goBack()">
<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/></svg>
–ù–∞–∑–∞–¥
</button>
<div class="rust-card rounded-lg p-8 mb-8">
<div class="flex flex-col md:flex-row gap-8 items-start">
<img id="viewProfileAvatar" src="" class="avatar avatar-lg">
<div class="flex-1">
<h2 id="viewProfileUsername" class="rust-font text-3xl mb-3 glow-text" style="color:var(--rust-orange)"></h2>
<div class="flex items-center gap-6 text-sm text-gray-400 mb-5">
<span class="flex items-center gap-2">
<svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/></svg>
<span id="viewProfileNick">-</span>
</span>
</div>
<div class="flex gap-3 mb-5" id="viewProfileSocials"></div>
<p id="viewProfileDesc" class="text-gray-300 leading-relaxed"></p>
</div>
<button class="rust-btn" onclick="startChatWith(viewingUserId)" id="viewProfileChatBtn">
<svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z"/></svg>
–ù–∞–ø–∏—Å–∞—Ç—å
</button>
</div>
</div>
<h3 class="rust-font text-2xl mb-6 section-title" style="color:var(--rust-orange)">–û–±—ä—è–≤–ª–µ–Ω–∏—è</h3>
<div id="userListingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
</div>
</main>
<footer class="border-t border-zinc-800 mt-20 py-10 text-center text-gray-500">
<div class="flex items-center justify-center gap-3 mb-4">
<img src="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" alt="RustEx" class="h-8 opacity-50">
<span class="rust-font text-lg">RustEx Searching</span>
</div>
<p class="text-sm">2024 RustEx Remake. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
</footer>
</div>
<div id="loginModal" class="modal">
<div class="rust-card rounded-lg p-10 w-full max-w-md mx-4 relative">
<div class="text-center mb-8">
<img src="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" alt="RustEx" class="h-14 mx-auto mb-4">
<h2 class="rust-font text-2xl glow-text" style="color:var(--rust-orange)">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
</div>
<div id="loginError" class="error-box" style="display:none"></div>
<form onsubmit="login(event)">
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">Email</label>
<input type="email" id="loginEmail" class="rust-input" required placeholder="example@mail.ru">
</div>
<div class="mb-8">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–ü–∞—Ä–æ–ª—å</label>
<input type="password" id="loginPassword" class="rust-input" required placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å">
</div>
<button type="submit" class="rust-btn w-full mb-5" id="loginBtn">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</button>
<p class="text-center text-gray-400">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span class="text-orange-500 cursor-pointer hover:underline font-bold" onclick="switchModal('registerModal')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></p>
</form>
<button class="absolute top-5 right-5 text-gray-500 hover:text-white text-3xl transition-colors" onclick="hideModal('loginModal')">&times;</button>
</div>
</div>
<div id="registerModal" class="modal">
<div class="rust-card rounded-lg p-10 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto relative">
<div class="text-center mb-8">
<img src="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" alt="RustEx" class="h-14 mx-auto mb-4">
<h2 class="rust-font text-2xl glow-text" style="color:var(--rust-orange)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
</div>
<div id="registerError" class="error-box" style="display:none"></div>
<form onsubmit="register(event)">
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
<input type="text" id="regUsername" class="rust-input" required minlength="3" maxlength="20" placeholder="–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è">
<p class="text-xs text-gray-500 mt-1">–ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ç–æ–º –Ω–µ–ª—å–∑—è</p>
</div>
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">Email</label>
<input type="email" id="regEmail" class="rust-input" required placeholder="example@mail.ru">
</div>
<div class="mb-8">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–ü–∞—Ä–æ–ª—å</label>
<input type="password" id="regPassword" class="rust-input" required minlength="6" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤">
</div>
<button type="submit" class="rust-btn w-full mb-5" id="regBtn">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
<p class="text-center text-gray-400">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <span class="text-orange-500 cursor-pointer hover:underline font-bold" onclick="switchModal('loginModal')">–í–æ–π—Ç–∏</span></p>
</form>
<button class="absolute top-5 right-5 text-gray-500 hover:text-white text-3xl transition-colors" onclick="hideModal('registerModal')">&times;</button>
</div>
</div>
<div id="welcomeModal" class="modal">
<div class="rust-card rounded-lg p-10 w-full max-w-xl mx-4 relative">
<div class="text-center mb-8">
<img src="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" alt="RustEx" class="h-20 mx-auto mb-4">
<h2 class="rust-font text-3xl glow-text" style="color:var(--rust-orange)">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
</div>
<div class="space-y-4 mb-8">
<div class="flex items-start gap-4 p-4 bg-zinc-800/50 rounded-lg">
<span class="text-3xl">üéÆ</span>
<div>
<h4 class="font-bold text-white mb-1">RustEx Searching</h4>
<p class="text-gray-400 text-sm">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–∏–º–º–µ–π—Ç–æ–≤, –∫–ª–∞–Ω–æ–≤ –∏ —Ä–∞–±–æ—Ç—ã –≤ RustEx Remake</p>
</div>
</div>
<div class="flex items-start gap-4 p-4 bg-zinc-800/50 rounded-lg">
<span class="text-3xl">üìù</span>
<div>
<h4 class="font-bold text-white mb-1">–î–æ 3 –æ–±—ä—è–≤–ª–µ–Ω–∏–π</h4>
<p class="text-gray-400 text-sm">–¢—ã –º–æ–∂–µ—à—å —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–æ 3 –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ</p>
</div>
</div>
<div class="flex items-start gap-4 p-4 bg-zinc-800/50 rounded-lg">
<span class="text-3xl">üí¨</span>
<div>
<h4 class="font-bold text-white mb-1">–û–±—â–µ–Ω–∏–µ</h4>
<p class="text-gray-400 text-sm">–ü–∏—à–∏ –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º –ø—Ä—è–º–æ –Ω–∞ —Å–∞–π—Ç–µ –∏–ª–∏ —á–µ—Ä–µ–∑ —Å–æ—Ü. —Å–µ—Ç–∏</p>
</div>
</div>
<div class="flex items-start gap-4 p-4 bg-zinc-800/50 rounded-lg">
<span class="text-3xl">üë§</span>
<div>
<h4 class="font-bold text-white mb-1">–¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h4>
<p class="text-gray-400 text-sm">–ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏ —É–∑–Ω–∞–ª–∏ –æ —Ç–µ–±–µ –±–æ–ª—å—à–µ!</p>
</div>
</div>
</div>
<button class="rust-btn w-full" onclick="hideModal('welcomeModal');showPage('profile')">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
</div>
</div>
<div id="editProfileModal" class="modal">
<div class="rust-card rounded-lg p-10 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto relative">
<h2 class="rust-font text-xl text-center mb-8 glow-text" style="color:var(--rust-orange)">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h2>
<form onsubmit="updateProfile(event)">
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–ù–∏–∫ –≤ RustEx Remake</label>
<input type="text" id="editGameNick" class="rust-input" placeholder="–í–∞—à –Ω–∏–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ">
</div>
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">Telegram</label>
<input type="text" id="editTelegram" class="rust-input" placeholder="@username –∏–ª–∏ —Å—Å—ã–ª–∫–∞">
<p class="text-xs text-gray-500 mt-1">–ï—Å–ª–∏ –Ω–µ—Ç - –Ω–∞–ø–∏—à–∏ -</p>
</div>
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">VK</label>
<input type="text" id="editVk" class="rust-input" placeholder="@username –∏–ª–∏ —Å—Å—ã–ª–∫–∞">
<p class="text-xs text-gray-500 mt-1">–ï—Å–ª–∏ –Ω–µ—Ç - –Ω–∞–ø–∏—à–∏ -</p>
</div>
<div class="mb-8">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–û —Å–µ–±–µ</label>
<textarea id="editDescription" class="rust-input" rows="4" maxlength="500" placeholder="–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ..."></textarea>
</div>
<button type="submit" class="rust-btn w-full">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
</form>
<button class="absolute top-5 right-5 text-gray-500 hover:text-white text-3xl transition-colors" onclick="hideModal('editProfileModal')">&times;</button>
</div>
</div>
<div id="createListingModal" class="modal">
<div class="rust-card rounded-lg p-10 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto relative">
<h2 class="rust-font text-xl text-center mb-6 glow-text" style="color:var(--rust-orange)">–ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
<div id="listingHint" class="bg-orange-900/30 border border-orange-600/50 rounded-lg p-4 mb-6">
<div class="flex items-start gap-3">
<span class="text-2xl">üí°</span>
<div>
<h4 class="font-bold text-orange-400 mb-1">–ü–æ–¥—Å–∫–∞–∑–∫–∞</h4>
<p class="text-sm text-gray-300">–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è. –ï—Å–ª–∏ –Ω–µ—Ç Telegram –∏–ª–∏ VK - –Ω–∞–ø–∏—à–∏ –ø—Ä–æ—á–µ—Ä–∫ "-"</p>
</div>
</div>
</div>
<form onsubmit="submitListing(event)">
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
<select id="listingCategory" class="rust-select" required>
<option value="">–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
<option value="team">–ò—â—É –∏–≥—Ä–æ–∫–æ–≤ –≤ —Ç–∏–º–º—É</option>
<option value="teammate">–ò—â—É –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞</option>
<option value="clan_search">–ò—â—É –∫–ª–∞–Ω</option>
<option value="clan_recruit">–ù–∞–±–æ—Ä –≤ –∫–ª–∞–Ω</option>
<option value="farmer">–§–∞—Ä–º–µ—Ä (–∏—â—É —Ä–∞–±–æ—Ç—É)</option>
<option value="pvp">–ü–í–ü—à–µ—Ä (–∏—â—É —Ä–∞–±–æ—Ç—É)</option>
</select>
</div>
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–ù–∞–∑–≤–∞–Ω–∏–µ (–¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤)</label>
<input type="text" id="listingTitle" class="rust-input" required maxlength="20" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
</div>
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–û–ø–∏—Å–∞–Ω–∏–µ (–¥–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤)</label>
<textarea id="listingDesc" class="rust-input" rows="4" required maxlength="1000" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
</div>
<div class="mb-5">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–§–æ—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</label>
<div class="file-upload" id="listingImageUpload">
<svg class="w-12 h-12 text-gray-500 mb-2" fill="currentColor" viewBox="0 0 20 20"><path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/></svg>
<span class="text-gray-400 text-sm">–ù–∞–∂–º–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</span>
<input type="file" accept="image/*" onchange="previewListingImage(event)">
</div>
<input type="hidden" id="listingImage">
</div>
<div class="grid grid-cols-2 gap-4 mb-5">
<div>
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">Telegram</label>
<input type="text" id="listingTelegram" class="rust-input" placeholder="@username">
</div>
<div>
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">VK</label>
<input type="text" id="listingVk" class="rust-input" placeholder="@id –∏–ª–∏ —Å—Å—ã–ª–∫–∞">
</div>
</div>
<div class="mb-8">
<label class="block text-sm mb-2 text-gray-400 rust-font-condensed">–ù–∏–∫ –≤ RustEx Remake</label>
<input type="text" id="listingNick" class="rust-input" required placeholder="–í–∞—à –Ω–∏–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ">
</div>
<button type="submit" class="rust-btn w-full" id="submitListingBtn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
</form>
<button class="absolute top-5 right-5 text-gray-500 hover:text-white text-3xl transition-colors" onclick="hideModal('createListingModal')">&times;</button>
</div>
</div>
<div id="toast" class="toast"></div>
<script>
const SUPABASE_URL='https://jerzhimcsxmgyxnwrojf.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplcnpoaW1jc3htZ3l4bndyb2pmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMzE0NDMsImV4cCI6MjA3OTkwNzQ0M30.zsZvnuqrtjahyeUr0nhXthbgKOwb3Yz_bsVC4rvfKPM';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let currentUser=null;
let currentProfile=null;
let currentCategory='all';
let viewingUserId=null;
let currentChatUserId=null;
let viewTimer=null;
let previousPage='listings';
let tablesReady=false;
const categoryLabels={team:'–ü–æ–∏—Å–∫ –≤ —Ç–∏–º–º—É',teammate:'–ü–æ–∏—Å–∫ –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞',clan_search:'–ò—â—É –∫–ª–∞–Ω',clan_recruit:'–ù–∞–±–æ—Ä –≤ –∫–ª–∞–Ω',farmer:'–§–∞—Ä–º–µ—Ä',pvp:'–ü–í–ü—à–µ—Ä'};
const categoryColors={team:'bg-blue-600',teammate:'bg-green-600',clan_search:'bg-purple-600',clan_recruit:'bg-red-600',farmer:'bg-yellow-600',pvp:'bg-pink-600'};
async function initTables(){
try{
const profilesCheck=await fetch(`${SUPABASE_URL}/rest/v1/rustex_profiles?select=id&limit=1`,{headers:{'apikey':SUPABASE_KEY}});
const listingsCheck=await fetch(`${SUPABASE_URL}/rest/v1/rustex_listings?select=id&limit=1`,{headers:{'apikey':SUPABASE_KEY}});
const messagesCheck=await fetch(`${SUPABASE_URL}/rest/v1/rustex_messages?select=id&limit=1`,{headers:{'apikey':SUPABASE_KEY}});
if(profilesCheck.status===404||listingsCheck.status===404||messagesCheck.status===404){
console.log('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –≤ Supabase');
}
tablesReady=true;
}catch(e){
console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü:',e);
tablesReady=true;
}
}
async function init(){
try{
await initTables();
const hash=window.location.hash;
if(hash&&hash.includes('access_token')){
const params=new URLSearchParams(hash.substring(1));
const accessToken=params.get('access_token');
const refreshToken=params.get('refresh_token');
if(accessToken&&refreshToken){
try{
const{data,error}=await supabase.auth.setSession({access_token:accessToken,refresh_token:refreshToken});
if(!error&&data.session){
window.history.replaceState(null,'',window.location.pathname);
currentUser=data.session.user;
await loadOrCreateProfile();
updateUIForAuth();
showToast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!','success');
}
}catch(e){
console.log('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Å—Å–∏–∏:',e);
}
}
}
const{data:{session}}=await supabase.auth.getSession();
if(session&&session.user){
currentUser=session.user;
await loadOrCreateProfile();
}
updateUIForAuth();
await loadListings();
supabase.auth.onAuthStateChange(async(event,session)=>{
if(event==='SIGNED_IN'&&session&&session.user){
currentUser=session.user;
await loadOrCreateProfile();
updateUIForAuth();
loadListings();
}else if(event==='SIGNED_OUT'){
currentUser=null;
currentProfile=null;
updateUIForAuth();
loadListings();
}
});
}catch(err){
console.log('Init:',err);
}finally{
document.getElementById('loadingOverlay').style.display='none';
document.getElementById('app').style.opacity='1';
}
}
async function loadOrCreateProfile(){
if(!currentUser)return null;
try{
const{data,error}=await supabase.from('rustex_profiles').select('*').eq('user_id',currentUser.id).maybeSingle();
if(data){
currentProfile=data;
if(data.is_new){
setTimeout(()=>showModal('welcomeModal'),500);
await supabase.from('rustex_profiles').update({is_new:false}).eq('user_id',currentUser.id);
}
return data;
}
const username=currentUser.user_metadata?.username||currentUser.email?.split('@')[0]||'User'+Date.now();
const gameNick=username;
const newProfile={
user_id:currentUser.id,
username:username,
email:currentUser.email||'',
game_nick:gameNick,
is_new:true,
avatar_url:'',
telegram:'-',
vk:'-',
description:''
};
const{data:created,error:createErr}=await supabase.from('rustex_profiles').insert(newProfile).select().single();
if(createErr){
console.log('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:',createErr);
currentProfile={...newProfile,created_at:new Date().toISOString()};
return currentProfile;
}
currentProfile=created;
setTimeout(()=>showModal('welcomeModal'),500);
return created;
}catch(err){
console.log('loadOrCreateProfile:',err);
currentProfile={
username:currentUser.user_metadata?.username||currentUser.email?.split('@')[0]||'User',
game_nick:currentUser.user_metadata?.username||'-',
avatar_url:'',
telegram:'-',
vk:'-',
description:'',
created_at:new Date().toISOString()
};
return currentProfile;
}
}
function getAvatarUrl(profile,size=128){
if(profile&&profile.avatar_url&&profile.avatar_url.length>10){
return profile.avatar_url;
}
const name=encodeURIComponent((profile?.username||'U').substring(0,2));
return`https://ui-avatars.com/api/?name=${name}&background=cd412b&color=fff&size=${size}&bold=true`;
}
function updateUIForAuth(){
const authBtns=document.getElementById('authButtons');
const userMenu=document.getElementById('userMenu');
const createBtn=document.getElementById('createListingBtn');
const msgNav=document.getElementById('messagesNavBtn');
const profNav=document.getElementById('profileNavBtn');
if(currentUser&&currentProfile){
authBtns.style.display='none';
userMenu.style.display='flex';
createBtn.style.display='flex';
msgNav.style.display='flex';
profNav.style.display='flex';
document.getElementById('headerAvatar').src=getAvatarUrl(currentProfile);
document.getElementById('headerUsername').textContent=currentProfile.username||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
checkUnreadMessages();
}else{
authBtns.style.display='block';
userMenu.style.display='none';
createBtn.style.display='none';
msgNav.style.display='none';
profNav.style.display='none';
}
}
async function checkUsernameAvailable(username){
try{
const{data}=await supabase.from('rustex_profiles').select('id').eq('username',username).maybeSingle();
return !data;
}catch(e){
return true;
}
}
async function register(e){
e.preventDefault();
const btn=document.getElementById('regBtn');
const errBox=document.getElementById('registerError');
btn.disabled=true;
btn.textContent='–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';
errBox.style.display='none';
const username=document.getElementById('regUsername').value.trim();
const email=document.getElementById('regEmail').value.trim();
const password=document.getElementById('regPassword').value;
if(username.length<3){
errBox.innerHTML='<span class="text-red-400">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞</span>';
errBox.style.display='block';
btn.disabled=false;
btn.textContent='–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
return;
}
const isAvailable=await checkUsernameAvailable(username);
if(!isAvailable){
errBox.innerHTML='<span class="text-red-400">–≠—Ç–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ</span>';
errBox.style.display='block';
btn.disabled=false;
btn.textContent='–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
return;
}
try{
const{data,error}=await supabase.auth.signUp({
email,
password,
options:{
data:{username:username,game_nick:username}
}
});
if(error)throw error;
if(data.user){
if(data.session){
currentUser=data.user;
await loadOrCreateProfile();
updateUIForAuth();
hideModal('registerModal');
showToast('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!','success');
loadListings();
}else{
const{data:loginData,error:loginErr}=await supabase.auth.signInWithPassword({email,password});
if(loginErr)throw loginErr;
currentUser=loginData.user;
await loadOrCreateProfile();
updateUIForAuth();
hideModal('registerModal');
showToast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, '+username+'!','success');
loadListings();
}
}
}catch(err){
let msg=err.message||'–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
if(msg.includes('already registered'))msg='–≠—Ç–æ—Ç email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';
errBox.innerHTML='<span class="text-red-400">'+escapeHtml(msg)+'</span>';
errBox.style.display='block';
}finally{
btn.disabled=false;
btn.textContent='–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
}
}
async function login(e){
e.preventDefault();
const btn=document.getElementById('loginBtn');
const errBox=document.getElementById('loginError');
btn.disabled=true;
btn.textContent='–í—Ö–æ–¥...';
errBox.style.display='none';
const email=document.getElementById('loginEmail').value.trim();
const password=document.getElementById('loginPassword').value;
try{
const{data,error}=await supabase.auth.signInWithPassword({email,password});
if(error)throw error;
if(data.user){
currentUser=data.user;
await loadOrCreateProfile();
updateUIForAuth();
hideModal('loginModal');
showToast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!'+(currentProfile?.username?' '+currentProfile.username:''),'success');
loadListings();
}
}catch(err){
let msg=err.message||'–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
if(msg.includes('Invalid login'))msg='–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
if(msg.includes('Email not confirmed'))msg='–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É)';
errBox.innerHTML='<span class="text-red-400">'+escapeHtml(msg)+'</span>';
errBox.style.display='block';
}finally{
btn.disabled=false;
btn.textContent='–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç';
}
}
async function logout(){
await supabase.auth.signOut();
currentUser=null;
currentProfile=null;
updateUIForAuth();
showPage('listings');
showToast('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞','success');
}
async function loadListings(){
const grid=document.getElementById('listingsGrid');
const empty=document.getElementById('listingsEmpty');
const loading=document.getElementById('listingsLoading');
loading.style.display='block';
grid.innerHTML='';
empty.style.display='none';
try{
let query=supabase.from('rustex_listings').select('*').order('created_at',{ascending:false});
if(currentCategory!=='all')query=query.eq('category',currentCategory);
const{data,error}=await query;
loading.style.display='none';
if(error){
console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π:',error);
empty.style.display='block';
return;
}
if(!data||data.length===0){
empty.style.display='block';
return;
}
const userIds=[...new Set(data.map(l=>l.user_id))];
let profileMap={};
try{
const{data:profiles}=await supabase.from('rustex_profiles').select('user_id,username,avatar_url').in('user_id',userIds);
(profiles||[]).forEach(p=>profileMap[p.user_id]=p);
}catch(e){}
grid.innerHTML=data.map(l=>{
const profile=profileMap[l.user_id]||{username:'–ò–≥—Ä–æ–∫',avatar_url:''};
const imgUrl=l.image_url||'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=400';
return`
<div class="rust-card listing-card rounded-lg overflow-hidden" onclick="viewListing('${l.id}')">
<div class="h-44 bg-cover bg-center relative" style="background-image:url('${imgUrl}')">
<div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
<div class="absolute bottom-4 left-4 right-4">
<span class="category-badge ${categoryColors[l.category]||'bg-gray-600'}">${categoryLabels[l.category]||l.category}</span>
</div>
</div>
<div class="p-5">
<h3 class="font-bold text-lg mb-2 truncate text-white">${escapeHtml(l.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</h3>
<p class="text-gray-400 text-sm mb-4 line-clamp-2">${escapeHtml((l.description||'').substring(0,80))}${(l.description||'').length>80?'...':''}</p>
<div class="flex items-center justify-between">
<div class="flex items-center gap-3">
<img src="${getAvatarUrl(profile,72)}" class="w-9 h-9 rounded-full border-2 border-zinc-600">
<span class="text-sm text-gray-300 font-medium">${escapeHtml(profile.username||'–ò–≥—Ä–æ–∫')}</span>
</div>
<div class="view-counter">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
${l.views||0}
</div>
</div>
</div>
</div>`;
}).join('');
}catch(err){
console.log('loadListings:',err);
loading.style.display='none';
empty.style.display='block';
}
}
function filterCategory(cat){
currentCategory=cat;
document.querySelectorAll('.category-filter').forEach(b=>{
b.classList.remove('bg-orange-600','text-white');
b.classList.add('bg-zinc-800','text-gray-300');
if(b.dataset.category===cat){
b.classList.add('bg-orange-600','text-white');
b.classList.remove('bg-zinc-800','text-gray-300');
}
});
loadListings();
}
async function viewListing(id){
if(!currentUser){
showToast('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ','error');
showModal('loginModal');
return;
}
try{
const{data:l,error}=await supabase.from('rustex_listings').select('*').eq('id',id).single();
if(error||!l){
showToast('–û–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ','error');
return;
}
let profile={username:'–ò–≥—Ä–æ–∫',avatar_url:'',game_nick:'-'};
try{
const{data:p}=await supabase.from('rustex_profiles').select('*').eq('user_id',l.user_id).maybeSingle();
if(p)profile=p;
}catch(e){}
previousPage='listings';
showPage('viewListing');
const imgUrl=l.image_url||'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=600';
document.getElementById('listingDetail').innerHTML=`
<div class="md:flex">
<div class="md:w-1/2 h-72 md:h-auto bg-cover bg-center relative" style="background-image:url('${imgUrl}');min-height:300px">
<div class="absolute inset-0 bg-gradient-to-r from-black/50 to-transparent md:bg-gradient-to-t"></div>
</div>
<div class="md:w-1/2 p-8">
<span class="category-badge ${categoryColors[l.category]||'bg-gray-600'} inline-block mb-4">${categoryLabels[l.category]||l.category}</span>
<h1 class="rust-font text-3xl mb-5 glow-text" style="color:var(--rust-orange)">${escapeHtml(l.title||'')}</h1>
<p class="text-gray-300 mb-8 whitespace-pre-wrap leading-relaxed">${escapeHtml(l.description||'')}</p>
<div class="bg-zinc-800/50 rounded-lg p-5 mb-8">
<div class="grid grid-cols-2 gap-4 text-sm">
<div class="flex items-center gap-2">
<svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/></svg>
<span class="text-gray-400">–ù–∏–∫:</span>
<span class="text-white font-medium">${escapeHtml(l.game_nick||'-')}</span>
</div>
<div class="flex items-center gap-2">
<svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
<span class="text-gray-400">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</span>
<span class="text-white font-medium">${l.views||0}</span>
</div>
</div>
</div>
<div class="flex items-center gap-5 p-4 bg-zinc-800/30 rounded-lg mb-8 cursor-pointer hover:bg-zinc-800/50 transition-colors" onclick="viewProfile('${l.user_id}')">
<img src="${getAvatarUrl(profile)}" class="avatar">
<div class="flex-1">
<div class="font-bold text-lg text-white">${escapeHtml(profile.username||'–ò–≥—Ä–æ–∫')}</div>
<div class="text-sm text-gray-400 flex items-center gap-2">
<svg class="w-4 h-4 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/></svg>
${escapeHtml(profile.game_nick||'-')}
</div>
</div>
<svg class="w-6 h-6 text-gray-500" fill="currentColor" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/></svg>
</div>
<div class="flex flex-wrap gap-4">
${renderSocialBtn(l.telegram,'tg')}
${renderSocialBtn(l.vk,'vk')}
<button class="rust-btn flex-1" onclick="startChatWith('${l.user_id}')">
<svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z"/></svg>
–ù–∞–ø–∏—Å–∞—Ç—å
</button>
</div>
</div>
</div>`;
if(viewTimer)clearTimeout(viewTimer);
viewTimer=setTimeout(async()=>{
if(l.user_id!==currentUser?.id){
try{
await supabase.from('rustex_listings').update({views:(l.views||0)+1}).eq('id',id);
}catch(e){}
}
},5000);
}catch(err){
console.log('viewListing:',err);
showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏','error');
}
}
function renderSocialBtn(value,type){
if(!value||value==='-')return '';
let url='';
if(type==='tg'){
if(value.startsWith('http'))url=value;
else if(value.startsWith('@'))url='https://t.me/'+value.slice(1);
else url='https://t.me/'+value;
return`<a href="${url}" target="_blank" class="social-btn tg-btn"><svg class="w-5 h-5" fill="white" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg></a>`;
}
if(type==='vk'){
if(value.startsWith('http'))url=value;
else if(value.startsWith('@'))url='https://vk.com/'+value.slice(1);
else url='https://vk.com/'+value;
return`<a href="${url}" target="_blank" class="social-btn vk-btn"><svg class="w-5 h-5" fill="white" viewBox="0 0 24 24"><path d="M15.684 0H8.316C1.592 0 0 1.592 0 8.316v7.368C0 22.408 1.592 24 8.316 24h7.368C22.408 24 24 22.408 24 15.684V8.316C24 1.592 22.408 0 15.684 0zm3.692 17.123h-1.744c-.66 0-.864-.525-2.05-1.727-1.033-1-1.49-1.135-1.744-1.135-.356 0-.458.102-.458.593v1.575c0 .424-.135.678-1.253.678-1.846 0-3.896-1.118-5.335-3.202C4.624 10.857 4 8.57 4 8.096c0-.254.102-.491.593-.491h1.744c.44 0 .61.203.78.678.863 2.49 2.303 4.675 2.896 4.675.22 0 .322-.102.322-.66V9.721c-.068-1.186-.695-1.287-.695-1.71 0-.203.17-.407.44-.407h2.743c.373 0 .508.203.508.643v3.473c0 .372.17.508.271.508.22 0 .407-.136.814-.542 1.27-1.422 2.18-3.61 2.18-3.61.119-.254.322-.491.763-.491h1.744c.525 0 .644.27.525.643-.22 1.017-2.354 4.031-2.354 4.031-.186.305-.254.44 0 .78.186.254.796.779 1.203 1.253.745.847 1.32 1.558 1.473 2.05.17.49-.085.744-.576.744z"/></svg></a>`;
}
return '';
}
async function viewProfile(userId){
viewingUserId=userId;
try{
let p={username:'–ò–≥—Ä–æ–∫',avatar_url:'',game_nick:'-',description:'',telegram:'-',vk:'-'};
try{
const{data}=await supabase.from('rustex_profiles').select('*').eq('user_id',userId).maybeSingle();
if(data)p=data;
}catch(e){}
previousPage='listings';
showPage('viewProfile');
document.getElementById('viewProfileAvatar').src=getAvatarUrl(p,256);
document.getElementById('viewProfileUsername').textContent=p.username||'–ò–≥—Ä–æ–∫';
document.getElementById('viewProfileNick').textContent=p.game_nick||'-';
document.getElementById('viewProfileDesc').textContent=p.description||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω–∏–ª –æ–ø–∏—Å–∞–Ω–∏–µ.';
const chatBtn=document.getElementById('viewProfileChatBtn');
chatBtn.style.display=(currentUser&&currentUser.id===userId)?'none':'inline-flex';
let socials='';
socials+=renderSocialBtn(p.telegram,'tg');
socials+=renderSocialBtn(p.vk,'vk');
document.getElementById('viewProfileSocials').innerHTML=socials;
let listings=[];
try{
const{data}=await supabase.from('rustex_listings').select('*').eq('user_id',userId);
if(data)listings=data;
}catch(e){}
document.getElementById('userListingsGrid').innerHTML=listings.length?listings.map(l=>renderListingCard(l,p)).join(''):'<p class="text-gray-500 col-span-3 text-center py-10">–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p>';
}catch(err){
console.log('viewProfile:',err);
}
}
function renderListingCard(l,profile){
const imgUrl=l.image_url||'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=400';
return`
<div class="rust-card listing-card rounded-lg overflow-hidden" onclick="viewListing('${l.id}')">
<div class="h-36 bg-cover bg-center relative" style="background-image:url('${imgUrl}')">
<div class="absolute inset-0 bg-gradient-to-t from-black to-transparent"></div>
</div>
<div class="p-5">
<span class="category-badge ${categoryColors[l.category]||'bg-gray-600'} text-xs">${categoryLabels[l.category]||l.category}</span>
<h3 class="font-bold mt-3 text-white">${escapeHtml(l.title||'')}</h3>
<div class="view-counter mt-3">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
${l.views||0}
</div>
</div>
</div>`;
}
function goBack(){
showPage(previousPage);
}
function showPage(page){
document.querySelectorAll('.nav-link').forEach(l=>{
l.classList.remove('active');
if(l.dataset.page===page)l.classList.add('active');
});
['listingsPage','messagesPage','profilePage','viewListingPage','viewProfilePage'].forEach(p=>document.getElementById(p).style.display='none');
if(page==='listings'){
document.getElementById('listingsPage').style.display='block';
previousPage='listings';
loadListings();
}else if(page==='messages'){
if(!currentUser){showModal('loginModal');return}
document.getElementById('messagesPage').style.display='block';
previousPage='messages';
loadChats();
}else if(page==='profile'){
if(!currentUser){showModal('loginModal');return}
document.getElementById('profilePage').style.display='block';
previousPage='profile';
loadMyProfile();
}else if(page==='viewListing'){
document.getElementById('viewListingPage').style.display='block';
}else if(page==='viewProfile'){
document.getElementById('viewProfilePage').style.display='block';
}
window.scrollTo(0,0);
}
async function loadMyProfile(){
if(!currentProfile){
await loadOrCreateProfile();
if(!currentProfile)return;
}
document.getElementById('profileAvatar').src=getAvatarUrl(currentProfile,256);
document.getElementById('profileUsername').textContent=currentProfile.username||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
document.getElementById('profileNick').textContent=currentProfile.game_nick||'-';
document.getElementById('profileDesc').textContent=currentProfile.description||'–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏ —É–∑–Ω–∞–ª–∏ –æ –≤–∞—Å –±–æ–ª—å—à–µ.';
document.getElementById('profileJoined').textContent=currentProfile.created_at?new Date(currentProfile.created_at).toLocaleDateString('ru'):'‚Äî';
let socials='';
socials+=renderSocialBtn(currentProfile.telegram,'tg');
socials+=renderSocialBtn(currentProfile.vk,'vk');
socials+=`<button class="rust-btn-secondary rust-btn text-xs py-2 px-4" onclick="logout()">–í—ã–π—Ç–∏</button>`;
document.getElementById('profileSocials').innerHTML=socials;
document.getElementById('editGameNick').value=currentProfile.game_nick||'';
document.getElementById('editTelegram').value=currentProfile.telegram||'';
document.getElementById('editVk').value=currentProfile.vk||'';
document.getElementById('editDescription').value=currentProfile.description||'';
let myListings=[];
try{
const{data}=await supabase.from('rustex_listings').select('*').eq('user_id',currentUser.id);
if(data)myListings=data;
}catch(e){}
document.getElementById('myListingsGrid').innerHTML=myListings.length?myListings.map(l=>`
<div class="rust-card listing-card rounded-lg overflow-hidden">
<div class="h-36 bg-cover bg-center relative" style="background-image:url('${l.image_url||'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=400'}')">
<div class="absolute inset-0 bg-gradient-to-t from-black to-transparent"></div>
</div>
<div class="p-5">
<span class="category-badge ${categoryColors[l.category]||'bg-gray-600'} text-xs">${categoryLabels[l.category]||l.category}</span>
<h3 class="font-bold mt-3 text-white">${escapeHtml(l.title||'')}</h3>
<div class="flex justify-between items-center mt-4">
<div class="view-counter">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
${l.views||0}
</div>
<button class="text-red-500 hover:text-red-400 text-sm flex items-center gap-1 transition-colors" onclick="event.stopPropagation();deleteListing('${l.id}')">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/></svg>
–£–¥–∞–ª–∏—Ç—å
</button>
</div>
</div>
</div>
`).join(''):'<div class="col-span-3 text-center py-16"><svg class="w-16 h-16 mx-auto mb-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/></svg><p class="text-gray-500 text-lg">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p><button class="rust-btn mt-4" onclick="createListing()">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–µ</button></div>';
}
async function updateProfile(e){
e.preventDefault();
const updates={
game_nick:document.getElementById('editGameNick').value.trim()||'-',
telegram:document.getElementById('editTelegram').value.trim()||'-',
vk:document.getElementById('editVk').value.trim()||'-',
description:document.getElementById('editDescription').value.trim()||''
};
try{
const{error}=await supabase.from('rustex_profiles').update(updates).eq('user_id',currentUser.id);
if(error)throw error;
currentProfile={...currentProfile,...updates};
hideModal('editProfileModal');
loadMyProfile();
updateUIForAuth();
showToast('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!','success');
}catch(err){
console.log('updateProfile:',err);
showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è','error');
}
}
async function uploadAvatar(e){
const file=e.target.files[0];
if(!file)return;
if(file.size>500000){
showToast('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 500KB)','error');
return;
}
const reader=new FileReader();
reader.onload=async(ev)=>{
try{
const avatarUrl=ev.target.result;
const{error}=await supabase.from('rustex_profiles').update({avatar_url:avatarUrl}).eq('user_id',currentUser.id);
if(error)throw error;
currentProfile.avatar_url=avatarUrl;
loadMyProfile();
updateUIForAuth();
showToast('–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!','success');
}catch(err){
console.log('uploadAvatar:',err);
showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞','error');
}
};
reader.readAsDataURL(file);
}
function previewListingImage(e){
const file=e.target.files[0];
if(!file)return;
if(file.size>1000000){
showToast('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å 1MB)','error');
return;
}
const reader=new FileReader();
reader.onload=(ev)=>{
document.getElementById('listingImage').value=ev.target.result;
const upload=document.getElementById('listingImageUpload');
upload.innerHTML=`<img src="${ev.target.result}" class="max-h-40 rounded"><span class="text-green-400 text-sm mt-2">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–æ</span><input type="file" accept="image/*" onchange="previewListingImage(event)">`;
};
reader.readAsDataURL(file);
}
async function createListing(){
if(!currentUser){showModal('loginModal');return}
let myListings=[];
try{
const{data}=await supabase.from('rustex_listings').select('id').eq('user_id',currentUser.id);
if(data)myListings=data;
}catch(e){}
if(myListings.length>=3){
showToast('–ú–∞–∫—Å–∏–º—É–º 3 –æ–±—ä—è–≤–ª–µ–Ω–∏—è. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä–æ–µ.','error');
return;
}
document.getElementById('listingNick').value=currentProfile?.game_nick||currentProfile?.username||'';
document.getElementById('listingTelegram').value=currentProfile?.telegram||'';
document.getElementById('listingVk').value=currentProfile?.vk||'';
document.getElementById('listingImage').value='';
document.getElementById('listingImageUpload').innerHTML=`<svg class="w-12 h-12 text-gray-500 mb-2" fill="currentColor" viewBox="0 0 20 20"><path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/></svg><span class="text-gray-400 text-sm">–ù–∞–∂–º–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</span><input type="file" accept="image/*" onchange="previewListingImage(event)">`;
document.getElementById('listingHint').style.display=myListings.length>0?'none':'block';
showModal('createListingModal');
}
async function submitListing(e){
e.preventDefault();
const btn=document.getElementById('submitListingBtn');
btn.disabled=true;
btn.textContent='–ü—É–±–ª–∏–∫–∞—Ü–∏—è...';
const listing={
user_id:currentUser.id,
category:document.getElementById('listingCategory').value,
title:document.getElementById('listingTitle').value.trim(),
description:document.getElementById('listingDesc').value.trim(),
image_url:document.getElementById('listingImage').value||'',
telegram:document.getElementById('listingTelegram').value.trim()||'-',
vk:document.getElementById('listingVk').value.trim()||'-',
game_nick:document.getElementById('listingNick').value.trim(),
views:0
};
try{
const{error}=await supabase.from('rustex_listings').insert(listing);
if(error)throw error;
hideModal('createListingModal');
document.querySelector('#createListingModal form').reset();
loadListings();
showToast('–û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!','success');
}catch(err){
console.log('submitListing:',err);
showToast('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏','error');
}finally{
btn.disabled=false;
btn.textContent='–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å';
}
}
async function deleteListing(id){
if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?'))return;
try{
const{error}=await supabase.from('rustex_listings').delete().eq('id',id);
if(error)throw error;
loadMyProfile();
showToast('–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ','success');
}catch(err){
console.log('deleteListing:',err);
showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è','error');
}
}
async function loadChats(){
let userIds=new Set();
try{
const{data:sent}=await supabase.from('rustex_messages').select('receiver_id').eq('sender_id',currentUser.id);
const{data:received}=await supabase.from('rustex_messages').select('sender_id').eq('receiver_id',currentUser.id);
(sent||[]).forEach(m=>userIds.add(m.receiver_id));
(received||[]).forEach(m=>userIds.add(m.sender_id));
}catch(e){}
if(userIds.size===0){
document.getElementById('chatsList').innerHTML='<div class="text-center py-10 text-gray-500"><svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z"/></svg><p>–ù–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤</p></div>';
return;
}
let profiles=[];
let unreadMap={};
try{
const{data}=await supabase.from('rustex_profiles').select('*').in('user_id',Array.from(userIds));
if(data)profiles=data;
const{data:unread}=await supabase.from('rustex_messages').select('sender_id').eq('receiver_id',currentUser.id).eq('is_read',false);
(unread||[]).forEach(m=>{unreadMap[m.sender_id]=(unreadMap[m.sender_id]||0)+1});
}catch(e){}
document.getElementById('chatsList').innerHTML=profiles.map(p=>`
<div class="flex items-center gap-4 p-4 rounded-lg cursor-pointer transition-all ${currentChatUserId===p.user_id?'bg-orange-600/20 border border-orange-600/50':'hover:bg-zinc-800/50'}" onclick="openChat('${p.user_id}')">
<img src="${getAvatarUrl(p)}" class="w-12 h-12 rounded-full border-2 ${currentChatUserId===p.user_id?'border-orange-500':'border-zinc-600'}">
<div class="flex-1 min-w-0">
<div class="font-bold truncate ${currentChatUserId===p.user_id?'text-orange-400':'text-white'}">${escapeHtml(p.username||'–ò–≥—Ä–æ–∫')}</div>
<div class="text-xs text-gray-400 truncate flex items-center gap-1">
<svg class="w-3 h-3 text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"/></svg>
${escapeHtml(p.game_nick||'-')}
</div>
</div>
${unreadMap[p.user_id]?`<span class="bg-orange-600 text-white text-xs px-2 py-1 rounded-full font-bold min-w-[24px] text-center">${unreadMap[p.user_id]}</span>`:''}
</div>
`).join('');
}
async function openChat(userId){
currentChatUserId=userId;
loadChats();
let p={username:'–ò–≥—Ä–æ–∫',avatar_url:'',game_nick:'-'};
try{
const{data}=await supabase.from('rustex_profiles').select('*').eq('user_id',userId).maybeSingle();
if(data)p=data;
}catch(e){}
document.getElementById('chatHeader').style.display='flex';
document.getElementById('chatInput').style.display='block';
document.getElementById('chatEmpty').style.display='none';
document.getElementById('chatAvatar').src=getAvatarUrl(p);
document.getElementById('chatName').textContent=p.username||'–ò–≥—Ä–æ–∫';
document.getElementById('chatNick').textContent=p.game_nick||'-';
try{
await supabase.from('rustex_messages').update({is_read:true}).eq('sender_id',userId).eq('receiver_id',currentUser.id);
}catch(e){}
loadMessages();
checkUnreadMessages();
}
async function loadMessages(){
if(!currentChatUserId)return;
let messages=[];
try{
const{data}=await supabase.from('rustex_messages').select('*').or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${currentChatUserId}),and(sender_id.eq.${currentChatUserId},receiver_id.eq.${currentUser.id})`).order('created_at');
if(data)messages=data;
}catch(e){}
const container=document.getElementById('chatMessages');
container.innerHTML=messages.map(m=>`
<div class="chat-message ${m.sender_id===currentUser.id?'sent':'received'}">
<div>${escapeHtml(m.content||'')}</div>
<div class="text-xs opacity-60 mt-1">${new Date(m.created_at).toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'})}</div>
</div>
`).join('');
container.scrollTop=container.scrollHeight;
}
async function sendMessage(){
const input=document.getElementById('messageInput');
const content=input.value.trim();
if(!content||!currentChatUserId)return;
try{
const{error}=await supabase.from('rustex_messages').insert({sender_id:currentUser.id,receiver_id:currentChatUserId,content});
if(error)throw error;
input.value='';
loadMessages();
}catch(err){
console.log('sendMessage:',err);
showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏','error');
}
}
async function startChatWith(userId){
if(!currentUser){showModal('loginModal');return}
if(userId===currentUser.id){showToast('–ù–µ–ª—å–∑—è –Ω–∞–ø–∏—Å–∞—Ç—å —Å–µ–±–µ','error');return}
showPage('messages');
setTimeout(()=>openChat(userId),100);
}
async function checkUnreadMessages(){
if(!currentUser)return;
try{
const{data}=await supabase.from('rustex_messages').select('id').eq('receiver_id',currentUser.id).eq('is_read',false);
const badge=document.getElementById('unreadBadge');
if(data&&data.length>0){
badge.style.display='flex';
badge.textContent=data.length;
}else{
badge.style.display='none';
}
}catch(e){}
}
function showModal(id){
hideAllModals();
document.getElementById(id).classList.add('show');
}
function hideModal(id){
document.getElementById(id).classList.remove('show');
}
function hideAllModals(){
document.querySelectorAll('.modal').forEach(m=>m.classList.remove('show'));
}
function switchModal(id){
hideAllModals();
setTimeout(()=>showModal(id),150);
}
function showToast(msg,type='success'){
const t=document.getElementById('toast');
t.textContent=msg;
t.className='toast '+type+' show';
setTimeout(()=>t.classList.remove('show'),4000);
}
function escapeHtml(str){
if(!str)return '';
return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
document.querySelectorAll('.modal').forEach(m=>{
m.addEventListener('click',e=>{
if(e.target===m)hideModal(m.id);
});
});
setInterval(()=>{if(currentUser)checkUnreadMessages()},15000);
setInterval(()=>{if(currentChatUserId)loadMessages()},5000);
init();
</script>
</body>
</html>