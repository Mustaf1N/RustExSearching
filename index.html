<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RustEx Searching - Professional Edition</title>
<link rel="icon" href="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" type="image/svg+xml">
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--rust-orange:#cd412b;--rust-red:#8b0000;--rust-dark:#1a1a1a;--rust-darker:#0d0d0d;--rust-metal:#2d2d2d;--rust-light:#e8e8e8;--rust-gold:#d4a853}
body{font-family:'Roboto',sans-serif;background:var(--rust-darker);color:var(--rust-light);min-height:100vh;background-image:url('https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=1920&q=80');background-size:cover;background-attachment:fixed;background-position:center}
body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(13,13,13,0.92);z-index:-1}
.rust-font{font-family:'Russo One',sans-serif;text-transform:uppercase;letter-spacing:2px}
.rust-btn{background:linear-gradient(180deg,#cd412b 0%,#8b0000 100%);border:2px solid #ff6b4a;padding:12px 24px;color:white;font-weight:bold;text-transform:uppercase;letter-spacing:1px;cursor:pointer;transition:all 0.3s;position:relative;overflow:hidden}
.rust-btn:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(205,65,43,0.5);border-color:#ffaa80}
.rust-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.rust-input{background:rgba(30,30,30,0.9);border:2px solid #444;padding:12px 16px;color:white;width:100%;transition:all 0.3s}
.rust-input:focus{outline:none;border-color:var(--rust-orange);box-shadow:0 0 10px rgba(205,65,43,0.3)}
.rust-card{background:linear-gradient(145deg,rgba(45,45,45,0.95),rgba(26,26,26,0.95));border:1px solid #444;position:relative;overflow:hidden}
.rust-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--rust-orange),var(--rust-gold),var(--rust-orange))}
.metal-texture{background:repeating-linear-gradient(90deg,transparent,transparent 2px,rgba(255,255,255,0.03) 2px,rgba(255,255,255,0.03) 4px)}
.nav-link{padding:12px 20px;cursor:pointer;transition:all 0.3s;border-bottom:3px solid transparent;text-transform:uppercase;letter-spacing:1px;font-size:14px}
.nav-link:hover,.nav-link.active{background:rgba(205,65,43,0.2);border-bottom-color:var(--rust-orange);color:var(--rust-orange)}
.listing-card{transition:all 0.3s}
.listing-card:hover{transform:translateY(-5px);box-shadow:0 10px 30px rgba(0,0,0,0.5)}
.category-badge{font-size:11px;padding:4px 10px;text-transform:uppercase;letter-spacing:1px}
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(5px)}
.modal.show{display:flex}
.chat-message{max-width:70%;padding:10px 14px;border-radius:12px;margin:5px 0;word-wrap:break-word}
.chat-message.sent{background:var(--rust-orange);margin-left:auto;border-bottom-right-radius:4px}
.chat-message.received{background:var(--rust-metal);margin-right:auto;border-bottom-left-radius:4px}
.avatar{width:50px;height:50px;border-radius:50%;object-fit:cover;border:2px solid var(--rust-orange)}
.avatar-lg{width:120px;height:120px}
.view-counter{display:flex;align-items:center;gap:4px;font-size:12px;color:#888}
.social-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.3s}
.social-btn:hover{transform:scale(1.1)}
.tg-btn{background:#0088cc}
.vk-btn{background:#4c75a3}
.toast{position:fixed;bottom:20px;right:20px;padding:16px 24px;border-radius:8px;z-index:2000;transform:translateX(150%);transition:transform 0.3s;font-weight:bold}
.toast.show{transform:translateX(0)}
.toast.success{background:#22c55e;color:white}
.toast.error{background:#ef4444;color:white}
.unread-badge{position:absolute;top:-5px;right:-5px;background:var(--rust-orange);color:white;font-size:10px;min-width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold}
.image-upload-preview{width:100%;max-height:200px;object-fit:cover;border-radius:8px;margin-top:10px}
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-track{background:var(--rust-darker)}
::-webkit-scrollbar-thumb{background:var(--rust-metal);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:#444}
</style>
</head>
<body>
<div id="app">
<header class="sticky top-0 z-50 metal-texture" style="background:linear-gradient(180deg,rgba(26,26,26,0.98),rgba(13,13,13,0.98));border-bottom:2px solid #333">
<div class="max-w-7xl mx-auto px-4">
<div class="flex items-center justify-between h-16">
<div class="flex items-center gap-3 cursor-pointer" onclick="showPage('listings')">
<img src="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" alt="Rust" class="h-10">
<div>
<span class="rust-font text-xl" style="color:var(--rust-orange)">RustEx</span>
<span class="rust-font text-xl text-white">Searching</span>
</div>
</div>
<nav class="hidden md:flex items-center" id="mainNav">
<div class="nav-link active" onclick="showPage('listings')">
<span>üéØ</span> –û–±—ä—è–≤–ª–µ–Ω–∏—è
</div>
<div class="nav-link relative" onclick="showPage('messages')" id="messagesNavBtn" style="display:none">
<span>üí¨</span> –°–æ–æ–±—â–µ–Ω–∏—è
<span class="unread-badge" id="unreadBadge" style="display:none">0</span>
</div>
<div class="nav-link" onclick="showPage('profile')" id="profileNavBtn" style="display:none">
<span>üë§</span> –ü—Ä–æ—Ñ–∏–ª—å
</div>
</nav>
<div class="flex items-center gap-3">
<div id="authButtons">
<button class="rust-btn text-sm" onclick="showModal('loginModal')">–í–æ–π—Ç–∏</button>
</div>
<div id="userMenu" style="display:none" class="flex items-center gap-3 cursor-pointer" onclick="showPage('profile')">
<img id="headerAvatar" src="" class="w-10 h-10 rounded-full border-2 border-orange-500">
<span id="headerUsername" class="hidden md:block font-medium"></span>
</div>
</div>
</div>
</div>
</header>

<main class="max-w-7xl mx-auto px-4 py-8">
<div id="listingsPage">
<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
<div>
<h1 class="rust-font text-3xl mb-2" style="color:var(--rust-orange)">–û–±—ä—è–≤–ª–µ–Ω–∏—è</h1>
<p class="text-gray-400">–ù–∞–π–¥–∏ —Ç–∏–º–º–µ–π—Ç–æ–≤, –∫–ª–∞–Ω –∏–ª–∏ —Ä–∞–±–æ—Ç—É –≤ Rust</p>
</div>
<button class="rust-btn" onclick="createListing()" id="createListingBtn" style="display:none">
+ –°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
</button>
</div>

<div class="flex flex-wrap gap-2 mb-6">
<button class="category-filter px-4 py-2 rounded-full text-sm transition-all bg-orange-600" data-category="all" onclick="filterCategory('all')">–í—Å–µ</button>
<button class="category-filter px-4 py-2 rounded-full text-sm transition-all bg-gray-700 hover:bg-gray-600" data-category="team" onclick="filterCategory('team')">üéÆ –ü–æ–∏—Å–∫ –≤ —Ç–∏–º–º—É</button>
<button class="category-filter px-4 py-2 rounded-full text-sm transition-all bg-gray-700 hover:bg-gray-600" data-category="teammate" onclick="filterCategory('teammate')">üë• –ü–æ–∏—Å–∫ –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞</button>
<button class="category-filter px-4 py-2 rounded-full text-sm transition-all bg-gray-700 hover:bg-gray-600" data-category="clan_search" onclick="filterCategory('clan_search')">üè∞ –ò—â—É –∫–ª–∞–Ω</button>
<button class="category-filter px-4 py-2 rounded-full text-sm transition-all bg-gray-700 hover:bg-gray-600" data-category="clan_recruit" onclick="filterCategory('clan_recruit')">‚öîÔ∏è –ù–∞–±–æ—Ä –≤ –∫–ª–∞–Ω</button>
<button class="category-filter px-4 py-2 rounded-full text-sm transition-all bg-gray-700 hover:bg-gray-600" data-category="farmer" onclick="filterCategory('farmer')">üåæ –§–∞—Ä–º–µ—Ä</button>
<button class="category-filter px-4 py-2 rounded-full text-sm transition-all bg-gray-700 hover:bg-gray-600" data-category="pvp" onclick="filterCategory('pvp')">üíÄ –ü–í–ü—à–µ—Ä</button>
</div>

<div id="listingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
<div id="listingsEmpty" class="text-center py-20" style="display:none">
<div class="text-6xl mb-4">üîç</div>
<h3 class="rust-font text-xl mb-2">–û–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</h3>
<p class="text-gray-400">–ë—É–¥—å –ø–µ—Ä–≤—ã–º!</p>
</div>
</div>

<div id="messagesPage" style="display:none">
<h1 class="rust-font text-3xl mb-6" style="color:var(--rust-orange)">–°–æ–æ–±—â–µ–Ω–∏—è</h1>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
<div class="rust-card rounded-lg p-4">
<h3 class="font-bold mb-4 text-gray-300">–î–∏–∞–ª–æ–≥–∏</h3>
<div id="chatsList" class="space-y-2 max-h-96 overflow-y-auto"></div>
</div>
<div class="lg:col-span-2 rust-card rounded-lg flex flex-col" style="height:500px">
<div id="chatHeader" class="p-4 border-b border-gray-700 flex items-center gap-3" style="display:none">
<img id="chatAvatar" src="" class="avatar">
<div>
<div id="chatName" class="font-bold"></div>
<div id="chatNick" class="text-sm text-gray-400"></div>
</div>
</div>
<div id="chatMessages" class="flex-1 p-4 overflow-y-auto"></div>
<div id="chatInput" class="p-4 border-t border-gray-700" style="display:none">
<div class="flex gap-2">
<input type="text" id="messageInput" class="rust-input flex-1" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter')sendMessage()">
<button class="rust-btn" onclick="sendMessage()">‚û§</button>
</div>
</div>
<div id="chatEmpty" class="flex-1 flex items-center justify-center text-gray-500">
<div class="text-center">
<div class="text-4xl mb-2">üí¨</div>
<p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥</p>
</div>
</div>
</div>
</div>
</div>

<div id="profilePage" style="display:none">
<div class="rust-card rounded-lg p-6 mb-6">
<div class="flex flex-col md:flex-row gap-6 items-start">
<div class="relative">
<img id="profileAvatar" src="" class="avatar avatar-lg">
<label class="absolute bottom-0 right-0 w-8 h-8 bg-orange-600 rounded-full flex items-center justify-center cursor-pointer hover:bg-orange-500">
<span>üì∑</span>
<input type="file" accept="image/*" class="hidden" onchange="uploadAvatar(event)">
</label>
</div>
<div class="flex-1">
<h2 id="profileUsername" class="rust-font text-2xl mb-2"></h2>
<div class="flex items-center gap-4 text-sm text-gray-400 mb-4">
<span>üéÆ <span id="profileNick">-</span></span>
<span>üìÖ <span id="profileJoined"></span></span>
</div>
<div class="flex gap-2 mb-4" id="profileSocials"></div>
<p id="profileDesc" class="text-gray-300"></p>
</div>
<button class="rust-btn text-sm" onclick="showModal('editProfileModal')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
</div>
</div>
<h3 class="rust-font text-xl mb-4" style="color:var(--rust-orange)">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h3>
<div id="myListingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
</div>

<div id="viewListingPage" style="display:none">
<button class="mb-4 text-gray-400 hover:text-white" onclick="showPage('listings')">‚Üê –ù–∞–∑–∞–¥</button>
<div class="rust-card rounded-lg overflow-hidden">
<div id="listingDetail"></div>
</div>
</div>

<div id="viewProfilePage" style="display:none">
<button class="mb-4 text-gray-400 hover:text-white" onclick="showPage('listings')">‚Üê –ù–∞–∑–∞–¥</button>
<div class="rust-card rounded-lg p-6 mb-6">
<div class="flex flex-col md:flex-row gap-6 items-start">
<img id="viewProfileAvatar" src="" class="avatar avatar-lg">
<div class="flex-1">
<h2 id="viewProfileUsername" class="rust-font text-2xl mb-2"></h2>
<div class="flex items-center gap-4 text-sm text-gray-400 mb-4">
<span>üéÆ <span id="viewProfileNick">-</span></span>
</div>
<div class="flex gap-2 mb-4" id="viewProfileSocials"></div>
<p id="viewProfileDesc" class="text-gray-300"></p>
</div>
<button class="rust-btn text-sm" onclick="startChatWith(viewingUserId)">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</button>
</div>
</div>
<h3 class="rust-font text-xl mb-4">–û–±—ä—è–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
<div id="userListingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
</div>
</main>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
<div id="loginModal" class="modal">
<div class="rust-card rounded-lg p-8 w-full max-w-md mx-4">
<h2 class="rust-font text-2xl text-center mb-6" style="color:var(--rust-orange)">–í—Ö–æ–¥</h2>
<form onsubmit="login(event)">
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-300">Email</label>
<input type="email" id="loginEmail" class="rust-input" required>
</div>
<div class="mb-6">
<label class="block text-sm mb-2 text-gray-300">–ü–∞—Ä–æ–ª—å</label>
<input type="password" id="loginPassword" class="rust-input" required>
</div>
<button type="submit" class="rust-btn w-full mb-4">–í–æ–π—Ç–∏</button>
<p class="text-center text-gray-400">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span class="text-orange-500 cursor-pointer hover:underline" onclick="switchModal('registerModal')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></p>
</form>
<button class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl" onclick="hideModal('loginModal')">√ó</button>
</div>
</div>

<div id="registerModal" class="modal">
<div class="rust-card rounded-lg p-8 w-full max-w-md mx-4 max-h-screen overflow-y-auto">
<h2 class="rust-font text-2xl text-center mb-6" style="color:var(--rust-orange)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
<form onsubmit="register(event)">
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-300">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—É–Ω–∏–∫–∞–ª—å–Ω–æ–µ, –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å)</label>
<input type="text" id="regUsername" class="rust-input" required minlength="3" maxlength="20" pattern="[a-zA-Z0-9_]+" title="–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ _">
</div>
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-300">Email</label>
<input type="email" id="regEmail" class="rust-input" required>
</div>
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-300">–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)</label>
<input type="password" id="regPassword" class="rust-input" required minlength="6">
</div>
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-300">–ù–∏–∫ –≤ Rust</label>
<input type="text" id="regGameNick" class="rust-input" placeholder="–í–∞—à –∏–≥—Ä–æ–≤–æ–π –Ω–∏–∫" required>
</div>
<button type="submit" class="rust-btn w-full mb-4">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
<p class="text-center text-gray-400">–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <span class="text-orange-500 cursor-pointer hover:underline" onclick="switchModal('loginModal')">–í–æ–π—Ç–∏</span></p>
</form>
<button class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl" onclick="hideModal('registerModal')">√ó</button>
</div>
</div>

<div id="welcomeModal" class="modal">
<div class="rust-card rounded-lg p-8 w-full max-w-lg mx-4">
<div class="text-center mb-6">
<img src="https://files.facepunch.com/lewis/1b2911b1/rust-marque.svg" alt="Rust" class="h-16 mx-auto mb-4">
<h2 class="rust-font text-2xl" style="color:var(--rust-orange)">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
</div>
<div class="text-gray-300 space-y-3 mb-6">
<p>üéÆ <strong>RustEx Searching</strong> ‚Äî –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–∏–º–º–µ–π—Ç–æ–≤ –∏ –∫–ª–∞–Ω–æ–≤</p>
<p>üìù –î–æ <strong>3 –æ–±—ä—è–≤–ª–µ–Ω–∏–π</strong> –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ</p>
<p>üí¨ –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —á–∞—Ç</p>
<p>üë§ –ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ—Ñ–∏–ª—å!</p>
</div>
<button class="rust-btn w-full" onclick="hideModal('welcomeModal');showPage('profile')">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å</button>
</div>
</div>

<div id="editProfileModal" class="modal">
<div class="rust-card rounded-lg p-8 w-full max-w-md mx-4 max-h-screen overflow-y-auto">
<h2 class="rust-font text-xl text-center mb-6" style="color:var(--rust-orange)">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h2>
<form onsubmit="updateProfile(event)">
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-300">–ù–∏–∫ –≤ Rust</label>
<input type="text" id="editGameNick" class="rust-input">
</div>
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-300">Telegram (@username –∏–ª–∏ —Å—Å—ã–ª–∫–∞)</label>
<input type="text" id="editTelegram" class="rust-input" placeholder="@username, t.me/username –∏–ª–∏ -">
</div>
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-300">VK (@id, —Å—Å—ã–ª–∫–∞ –∏–ª–∏ id123456)</label>
<input type="text" id="editVk" class="rust-input" placeholder="@id123, vk.com/id123 –∏–ª–∏ -">
</div>
<div class="mb-6">
<label class="block text-sm mb-2 text-gray-300">–û —Å–µ–±–µ (–¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤)</label>
<textarea id="editDescription" class="rust-input" rows="4" maxlength="500"></textarea>
</div>
<button type="submit" class="rust-btn w-full">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</form>
<button class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl" onclick="hideModal('editProfileModal')">√ó</button>
</div>
</div>

<div id="createListingModal" class="modal">
<div class="rust-card rounded-lg p-8 w-full max-w-lg mx-4 max-h-screen overflow-y-auto">
<h2 class="rust-font text-xl text-center mb-6" style="color:var(--rust-orange)">–ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
<form onsubmit="submitListing(event)">
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-300">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
<select id="listingCategory" class="rust-input" required>
<option value="">–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
<option value="team">üéÆ –ò—â—É –∏–≥—Ä–æ–∫–æ–≤ –≤ —Ç–∏–º–º—É</option>
<option value="teammate">üë• –ò—â—É –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞</option>
<option value="clan_search">üè∞ –ò—â—É –∫–ª–∞–Ω</option>
<option value="clan_recruit">‚öîÔ∏è –ù–∞–±–æ—Ä –≤ –∫–ª–∞–Ω</option>
<option value="farmer">üåæ –§–∞—Ä–º–µ—Ä</option>
<option value="pvp">üíÄ –ü–í–ü—à–µ—Ä</option>
</select>
</div>
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-300">–ù–∞–∑–≤–∞–Ω–∏–µ (–¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤)</label>
<input type="text" id="listingTitle" class="rust-input" required maxlength="50">
</div>
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-300">–û–ø–∏—Å–∞–Ω–∏–µ (–¥–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤)</label>
<textarea id="listingDesc" class="rust-input" rows="4" required maxlength="1000"></textarea>
</div>
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-300">–ö–∞—Ä—Ç–∏–Ω–∫–∞ (–ø—Ä—è–º–æ–π –≤—ã–±–æ—Ä)</label>
<input type="file" accept="image/*" id="listingImageFile" class="rust-input" onchange="previewListingImage(event)">
<img id="listingImagePreview" class="image-upload-preview" style="display:none">
</div>
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-300">Telegram</label>
<input type="text" id="listingTelegram" class="rust-input" placeholder="@username –∏–ª–∏ -">
</div>
<div class="mb-4">
<label class="block text-sm mb-2 text-gray-300">VK</label>
<input type="text" id="listingVk" class="rust-input" placeholder="@id –∏–ª–∏ —Å—Å—ã–ª–∫–∞">
</div>
<div class="mb-6">
<label class="block text-sm mb-2 text-gray-300">–ù–∏–∫ –≤ –∏–≥—Ä–µ</label>
<input type="text" id="listingNick" class="rust-input" required>
</div>
<button type="submit" class="rust-btn w-full">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
</form>
<button class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl" onclick="hideModal('createListingModal')">√ó</button>
</div>
</div>

<div id="toast" class="toast"></div>

<script>
// ============= –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =============
const SUPABASE_URL = 'https://jerzhimcsxmgyxnwrojf.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplcnpoaW1jc3htZ3l4bndyb2pmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMzE0NDMsImV4cCI6MjA3OTkwNzQ0M30.zsZvnuqrtjahyeUr0nhXthbgKOwb3Yz_bsVC4rvfKPM';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ============= –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï =============
let currentUser = null;
let currentProfile = null;
let currentCategory = 'all';
let viewingUserId = null;
let currentChatUserId = null;
let viewTimer = null;
let listingImageBase64 = '';

const categoryLabels = {
  team: 'üéÆ –ü–æ–∏—Å–∫ –≤ —Ç–∏–º–º—É',
  teammate: 'üë• –ü–æ–∏—Å–∫ –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞',
  clan_search: 'üè∞ –ò—â—É –∫–ª–∞–Ω',
  clan_recruit: '‚öîÔ∏è –ù–∞–±–æ—Ä –≤ –∫–ª–∞–Ω',
  farmer: 'üåæ –§–∞—Ä–º–µ—Ä',
  pvp: 'üíÄ –ü–í–ü—à–µ—Ä'
};

const categoryColors = {
  team: 'bg-blue-600',
  teammate: 'bg-green-600',
  clan_search: 'bg-purple-600',
  clan_recruit: 'bg-red-600',
  farmer: 'bg-yellow-600',
  pvp: 'bg-pink-600'
};

// ============= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–î =============
async function initDB() {
  try {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–æ—Ñ–∏–ª–µ–π
    const { error: e1 } = await supabase.from('rustex_profiles').select('id').limit(1);
    if (e1 && e1.code === '42P01') {
      await supabase.rpc('create_profiles_table', {});
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –æ–±—ä—è–≤–ª–µ–Ω–∏–π
    const { error: e2 } = await supabase.from('rustex_listings').select('id').limit(1);
    if (e2 && e2.code === '42P01') {
      await supabase.rpc('create_listings_table', {});
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–æ–±—â–µ–Ω–∏–π
    const { error: e3 } = await supabase.from('rustex_messages').select('id').limit(1);
    if (e3 && e3.code === '42P01') {
      await supabase.rpc('create_messages_table', {});
    }

    console.log('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
  } catch (err) {
    console.log('‚ö†Ô∏è –¢–∞–±–ª–∏—Ü—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏–ª–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:', err.message);
  }
}

// ============= –û–°–ù–û–í–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =============
async function init() {
  console.log('üöÄ –ó–∞–ø—É—Å–∫ RustEx...');
  
  await initDB();

  const { data: { session } } = await supabase.auth.getSession();
  if (session) {
    currentUser = session.user;
    await loadProfile();
    updateUIForAuth();
  }

  loadListings();

  supabase.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_IN' && session) {
      currentUser = session.user;
      await loadProfile();
      updateUIForAuth();
    } else if (event === 'SIGNED_OUT') {
      currentUser = null;
      currentProfile = null;
      updateUIForAuth();
    }
  });

  console.log('‚úÖ RustEx –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
}

// ============= –ó–ê–ì–†–£–ó–ö–ê –ü–†–û–§–ò–õ–Ø =============
async function loadProfile() {
  if (!currentUser) return;
  
  const { data, error } = await supabase
    .from('rustex_profiles')
    .select('*')
    .eq('user_id', currentUser.id)
    .single();

  if (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
    return;
  }

  if (data) {
    currentProfile = data;
    if (data.is_new) {
      showModal('welcomeModal');
      await supabase
        .from('rustex_profiles')
        .update({ is_new: false })
        .eq('user_id', currentUser.id);
    }
  }
}

// ============= –û–ë–ù–û–í–õ–ï–ù–ò–ï UI =============
function updateUIForAuth() {
  const authBtns = document.getElementById('authButtons');
  const userMenu = document.getElementById('userMenu');
  const createBtn = document.getElementById('createListingBtn');
  const msgNav = document.getElementById('messagesNavBtn');
  const profNav = document.getElementById('profileNavBtn');

  if (currentUser && currentProfile) {
    authBtns.style.display = 'none';
    userMenu.style.display = 'flex';
    createBtn.style.display = 'block';
    msgNav.style.display = 'block';
    profNav.style.display = 'block';

    const avatar = currentProfile.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentProfile.username)}&background=cd412b&color=fff`;
    document.getElementById('headerAvatar').src = avatar;
    document.getElementById('headerUsername').textContent = currentProfile.username;

    checkUnreadMessages();
  } else {
    authBtns.style.display = 'block';
    userMenu.style.display = 'none';
    createBtn.style.display = 'none';
    msgNav.style.display = 'none';
    profNav.style.display = 'none';
  }
}

// ============= –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø =============
async function register(e) {
  e.preventDefault();

  const username = document.getElementById('regUsername').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const password = document.getElementById('regPassword').value;
  const gameNick = document.getElementById('regGameNick').value.trim();

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const { data: existing } = await supabase
    .from('rustex_profiles')
    .select('username')
    .eq('username', username)
    .single();

  if (existing) {
    showToast('‚ùå –≠—Ç–æ –∏–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ!', 'error');
    return;
  }

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const { data, error } = await supabase.auth.signUp({ email, password });

  if (error) {
    showToast('‚ùå ' + error.message, 'error');
    return;
  }

  if (data.user) {
    // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —Å –Ω–∏–∫–æ–º —Å—Ä–∞–∑—É
    await supabase.from('rustex_profiles').insert({
      user_id: data.user.id,
      username: username,
      email: email,
      game_nick: gameNick,
      avatar_url: `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=cd412b&color=fff`
    });

    hideModal('registerModal');
    showToast('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email', 'success');
  }
}

// ============= –í–•–û–î =============
async function login(e) {
  e.preventDefault();

  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;

  const { error } = await supabase.auth.signInWithPassword({ email, password });

  if (error) {
    showToast('‚ùå ' + error.message, 'error');
    return;
  }

  hideModal('loginModal');
  showToast('‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', 'success');
}

// ============= –í–´–•–û–î =============
async function logout() {
  await supabase.auth.signOut();
  showPage('listings');
  showToast('üëã –î–æ –≤—Å—Ç—Ä–µ—á–∏!', 'success');
}

// ============= –ó–ê–ì–†–£–ó–ö–ê –û–ë–™–Ø–í–õ–ï–ù–ò–ô =============
async function loadListings() {
  let query = supabase
    .from('rustex_listings')
    .select('*, rustex_profiles!rustex_listings_user_id_fkey(username, avatar_url)')
    .order('created_at', { ascending: false });

  if (currentCategory !== 'all') {
    query = query.eq('category', currentCategory);
  }

  const { data, error } = await query;

  const grid = document.getElementById('listingsGrid');
  const empty = document.getElementById('listingsEmpty');

  if (error || !data || data.length === 0) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    return;
  }

  empty.style.display = 'none';
  grid.innerHTML = data.map(l => `
    <div class="rust-card listing-card rounded-lg overflow-hidden cursor-pointer" onclick="viewListing('${l.id}')">
      <div class="h-40 bg-cover bg-center" style="background-image:url('${l.image_url || 'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=400'}')">
        <div class="h-full bg-gradient-to-t from-black/80 to-transparent flex items-end p-4">
          <span class="category-badge ${categoryColors[l.category]} rounded">${categoryLabels[l.category]}</span>
        </div>
      </div>
      <div class="p-4">
        <h3 class="font-bold text-lg mb-2 truncate">${escapeHtml(l.title)}</h3>
        <p class="text-gray-400 text-sm mb-3 line-clamp-2">${escapeHtml(l.description.substring(0, 100))}...</p>
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <img src="${l.rustex_profiles?.avatar_url || 'https://ui-avatars.com/api/?name=U&background=cd412b&color=fff'}" class="w-8 h-8 rounded-full">
            <span class="text-sm text-gray-300">${escapeHtml(l.rustex_profiles?.username || 'Unknown')}</span>
          </div>
          <div class="view-counter">üëÅ ${l.views || 0}</div>
        </div>
      </div>
    </div>
  `).join('');
}

// ============= –§–ò–õ–¨–¢–† –ö–ê–¢–ï–ì–û–†–ò–ô =============
function filterCategory(cat) {
  currentCategory = cat;
  document.querySelectorAll('.category-filter').forEach(b => {
    b.classList.remove('bg-orange-600');
    b.classList.add('bg-gray-700');
    if (b.dataset.category === cat) {
      b.classList.add('bg-orange-600');
      b.classList.remove('bg-gray-700');
    }
  });
  loadListings();
}

// ============= –ü–†–û–°–ú–û–¢–† –û–ë–™–Ø–í–õ–ï–ù–ò–Ø =============
async function viewListing(id) {
  if (!currentUser) {
    showToast('‚ùå –í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞', 'error');
    showModal('loginModal');
    return;
  }

  const { data: l } = await supabase
    .from('rustex_listings')
    .select('*, rustex_profiles!rustex_listings_user_id_fkey(*)')
    .eq('id', id)
    .single();

  if (!l) return;

  showPage('viewListing');

  const tgLink = formatSocialLink(l.telegram, 'telegram');
  const vkLink = formatSocialLink(l.vk, 'vk');

  document.getElementById('listingDetail').innerHTML = `
    <div class="md:flex">
      <div class="md:w-1/2 h-64 md:h-auto bg-cover bg-center" style="background-image:url('${l.image_url || 'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=600'}')"></div>
      <div class="md:w-1/2 p-6">
        <span class="category-badge ${categoryColors[l.category]} rounded inline-block mb-3">${categoryLabels[l.category]}</span>
        <h1 class="rust-font text-2xl mb-4">${escapeHtml(l.title)}</h1>
        <p class="text-gray-300 mb-6 whitespace-pre-wrap">${escapeHtml(l.description)}</p>
        
        <div class="bg-black/30 rounded-lg p-4 mb-6">
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div><span class="text-gray-400">–ù–∏–∫ –≤ –∏–≥—Ä–µ:</span> <span class="text-white font-bold">${escapeHtml(l.game_nick)}</span></div>
            <div><span class="text-gray-400">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</span> <span class="text-white">${l.views || 0}</span></div>
          </div>
        </div>

        <div class="flex items-center gap-4 mb-6 cursor-pointer hover:bg-white/5 p-3 rounded-lg transition" onclick="viewProfile('${l.user_id}')">
          <img src="${l.rustex_profiles?.avatar_url || 'https://ui-avatars.com/api/?name=U&background=cd412b&color=fff'}" class="avatar">
          <div>
            <div class="font-bold">${escapeHtml(l.rustex_profiles?.username || 'Unknown')}</div>
            <div class="text-sm text-gray-400">üéÆ ${escapeHtml(l.rustex_profiles?.game_nick || '-')}</div>
          </div>
        </div>

        <div class="flex flex-wrap gap-3">
          ${tgLink ? `<a href="${tgLink}" target="_blank" class="social-btn tg-btn">${telegramIcon}</a>` : ''}
          ${vkLink ? `<a href="${vkLink}" target="_blank" class="social-btn vk-btn">${vkIcon}</a>` : ''}
          <button class="rust-btn flex-1" onclick="startChatWith('${l.user_id}')">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</button>
        </div>
      </div>
    </div>
  `;

  // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
  if (viewTimer) clearTimeout(viewTimer);
  viewTimer = setTimeout(async () => {
    if (l.user_id !== currentUser?.id) {
      await supabase
        .from('rustex_listings')
        .update({ views: (l.views || 0) + 1 })
        .eq('id', id);
    }
  }, 5000);
}

// ============= –ü–†–û–°–ú–û–¢–† –ü–†–û–§–ò–õ–Ø =============
async function viewProfile(userId) {
  viewingUserId = userId;

  const { data: p } = await supabase
    .from('rustex_profiles')
    .select('*')
    .eq('user_id', userId)
    .single();

  if (!p) return;

  showPage('viewProfile');

  document.getElementById('viewProfileAvatar').src = p.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.username)}&background=cd412b&color=fff`;
  document.getElementById('viewProfileUsername').textContent = p.username;
  document.getElementById('viewProfileNick').textContent = p.game_nick || '-';
  document.getElementById('viewProfileDesc').textContent = p.description || '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ';

  const tgLink = formatSocialLink(p.telegram, 'telegram');
  const vkLink = formatSocialLink(p.vk, 'vk');

  let socials = '';
  if (tgLink) socials += `<a href="${tgLink}" target="_blank" class="social-btn tg-btn">${telegramIcon}</a>`;
  if (vkLink) socials += `<a href="${vkLink}" target="_blank" class="social-btn vk-btn">${vkIcon}</a>`;

  document.getElementById('viewProfileSocials').innerHTML = socials;

  const { data: listings } = await supabase
    .from('rustex_listings')
    .select('*')
    .eq('user_id', userId);

  document.getElementById('userListingsGrid').innerHTML = (listings || []).map(l => `
    <div class="rust-card listing-card rounded-lg overflow-hidden cursor-pointer" onclick="viewListing('${l.id}')">
      <div class="h-32 bg-cover bg-center" style="background-image:url('${l.image_url || 'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=400'}')"></div>
      <div class="p-4">
        <span class="category-badge ${categoryColors[l.category]} rounded text-xs">${categoryLabels[l.category]}</span>
        <h3 class="font-bold mt-2 truncate">${escapeHtml(l.title)}</h3>
        <div class="view-counter mt-2">üëÅ ${l.views || 0}</div>
      </div>
    </div>
  `).join('') || '<p class="text-gray-400 col-span-3 text-center">–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p>';
}

// ============= –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –°–¢–†–ê–ù–ò–¶ =============
function showPage(page) {
  document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
  ['listingsPage', 'messagesPage', 'profilePage', 'viewListingPage', 'viewProfilePage'].forEach(p => {
    document.getElementById(p).style.display = 'none';
  });

  if (page === 'listings') {
    document.getElementById('listingsPage').style.display = 'block';
    document.querySelector('[onclick="showPage(\'listings\')"]').classList.add('active');
    loadListings();
  } else if (page === 'messages') {
    if (!currentUser) { showModal('loginModal'); return; }
    document.getElementById('messagesPage').style.display = 'block';
    document.getElementById('messagesNavBtn').classList.add('active');
    loadChats();
  } else if (page === 'profile') {
    if (!currentUser) { showModal('loginModal'); return; }
    document.getElementById('profilePage').style.display = 'block';
    document.getElementById('profileNavBtn').classList.add('active');
    loadMyProfile();
  } else if (page === 'viewListing') {
    document.getElementById('viewListingPage').style.display = 'block';
  } else if (page === 'viewProfile') {
    document.getElementById('viewProfilePage').style.display = 'block';
  }
}

// ============= –ú–û–ô –ü–†–û–§–ò–õ–¨ =============
async function loadMyProfile() {
  if (!currentProfile) return;

  document.getElementById('profileAvatar').src = currentProfile.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentProfile.username)}&background=cd412b&color=fff`;
  document.getElementById('profileUsername').textContent = currentProfile.username;
  document.getElementById('profileNick').textContent = currentProfile.game_nick || '-';
  document.getElementById('profileDesc').textContent = currentProfile.description || '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ';
  document.getElementById('profileJoined').textContent = new Date(currentProfile.created_at).toLocaleDateString('ru');

  const tgLink = formatSocialLink(currentProfile.telegram, 'telegram');
  const vkLink = formatSocialLink(currentProfile.vk, 'vk');

  let socials = '';
  if (tgLink) socials += `<a href="${tgLink}" target="_blank" class="social-btn tg-btn">${telegramIcon}</a>`;
  if (vkLink) socials += `<a href="${vkLink}" target="_blank" class="social-btn vk-btn">${vkIcon}</a>`;
  socials += `<button class="text-sm text-red-500 hover:text-red-400 ml-4 font-bold" onclick="logout()">–í—ã–π—Ç–∏</button>`;

  document.getElementById('profileSocials').innerHTML = socials;

  // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  document.getElementById('editGameNick').value = currentProfile.game_nick || '';
  document.getElementById('editTelegram').value = currentProfile.telegram || '';
  document.getElementById('editVk').value = currentProfile.vk || '';
  document.getElementById('editDescription').value = currentProfile.description || '';

  const { data: myListings } = await supabase
    .from('rustex_listings')
    .select('*')
    .eq('user_id', currentUser.id);

  document.getElementById('myListingsGrid').innerHTML = (myListings || []).map(l => `
    <div class="rust-card listing-card rounded-lg overflow-hidden">
      <div class="h-32 bg-cover bg-center" style="background-image:url('${l.image_url || 'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=400'}')"></div>
      <div class="p-4">
        <span class="category-badge ${categoryColors[l.category]} rounded text-xs">${categoryLabels[l.category]}</span>
        <h3 class="font-bold mt-2 truncate">${escapeHtml(l.title)}</h3>
        <div class="flex justify-between items-center mt-3">
          <div class="view-counter">üëÅ ${l.views || 0}</div>
          <button class="text-red-500 hover:text-red-400 text-sm font-bold" onclick="deleteListing('${l.id}')">üóë –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    </div>
  `).join('') || '<p class="text-gray-400 col-span-3 text-center">–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π. <span class="text-orange-500 cursor-pointer hover:underline" onclick="createListing()">–°–æ–∑–¥–∞—Ç—å?</span></p>';
}

// ============= –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–†–û–§–ò–õ–Ø =============
async function updateProfile(e) {
  e.preventDefault();

  const updates = {
    game_nick: document.getElementById('editGameNick').value.trim(),
    telegram: document.getElementById('editTelegram').value.trim() || '-',
    vk: document.getElementById('editVk').value.trim() || '-',
    description: document.getElementById('editDescription').value.trim()
  };

  await supabase
    .from('rustex_profiles')
    .update(updates)
    .eq('user_id', currentUser.id);

  currentProfile = { ...currentProfile, ...updates };

  hideModal('editProfileModal');
  loadMyProfile();
  updateUIForAuth();
  showToast('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
}

// ============= –ó–ê–ì–†–£–ó–ö–ê –ê–í–ê–¢–ê–†–ê =============
async function uploadAvatar(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async (ev) => {
    const avatarUrl = ev.target.result;

    await supabase
      .from('rustex_profiles')
      .update({ avatar_url: avatarUrl })
      .eq('user_id', currentUser.id);

    currentProfile.avatar_url = avatarUrl;
    loadMyProfile();
    updateUIForAuth();
    showToast('‚úÖ –ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
  };
  reader.readAsDataURL(file);
}

// ============= –°–û–ó–î–ê–ù–ò–ï –û–ë–™–Ø–í–õ–ï–ù–ò–Ø =============
async function createListing() {
  if (!currentUser) {
    showModal('loginModal');
    return;
  }

  const { data: myListings } = await supabase
    .from('rustex_listings')
    .select('id')
    .eq('user_id', currentUser.id);

  if (myListings && myListings.length >= 3) {
    showToast('‚ùå –ú–∞–∫—Å–∏–º—É–º 3 –æ–±—ä—è–≤–ª–µ–Ω–∏—è. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä–æ–µ!', 'error');
    return;
  }

  // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
  document.getElementById('listingNick').value = currentProfile?.game_nick || '';
  document.getElementById('listingTelegram').value = currentProfile?.telegram || '';
  document.getElementById('listingVk').value = currentProfile?.vk || '';
  listingImageBase64 = '';
  document.getElementById('listingImagePreview').style.display = 'none';

  showModal('createListingModal');
}

// ============= –ü–†–ï–í–¨–Æ –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø =============
function previewListingImage(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (ev) => {
    listingImageBase64 = ev.target.result;
    const preview = document.getElementById('listingImagePreview');
    preview.src = listingImageBase64;
    preview.style.display = 'block';
  };
  reader.readAsDataURL(file);
}

// ============= –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –û–ë–™–Ø–í–õ–ï–ù–ò–Ø =============
async function submitListing(e) {
  e.preventDefault();

  const listing = {
    user_id: currentUser.id,
    category: document.getElementById('listingCategory').value,
    title: document.getElementById('listingTitle').value.trim(),
    description: document.getElementById('listingDesc').value.trim(),
    image_url: listingImageBase64 || '',
    telegram: document.getElementById('listingTelegram').value.trim() || '-',
    vk: document.getElementById('listingVk').value.trim() || '-',
    game_nick: document.getElementById('listingNick').value.trim(),
    views: 0
  };

  const { error } = await supabase.from('rustex_listings').insert(listing);

  if (error) {
    showToast('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
    return;
  }

  hideModal('createListingModal');
  document.querySelector('#createListingModal form').reset();
  listingImageBase64 = '';
  loadListings();
  showToast('‚úÖ –û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!', 'success');
}

// ============= –£–î–ê–õ–ï–ù–ò–ï –û–ë–™–Ø–í–õ–ï–ù–ò–Ø =============
async function deleteListing(id) {
  if (!confirm('‚ùì –£–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?')) return;

  await supabase.from('rustex_listings').delete().eq('id', id);
  loadMyProfile();
  showToast('‚úÖ –û–±—ä—è–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
}

// ============= –ß–ê–¢–´ =============
async function loadChats() {
  const { data: sent } = await supabase
    .from('rustex_messages')
    .select('receiver_id')
    .eq('sender_id', currentUser.id);

  const { data: received } = await supabase
    .from('rustex_messages')
    .select('sender_id')
    .eq('receiver_id', currentUser.id);

  const userIds = new Set();
  (sent || []).forEach(m => userIds.add(m.receiver_id));
  (received || []).forEach(m => userIds.add(m.sender_id));

  if (userIds.size === 0) {
    document.getElementById('chatsList').innerHTML = '<p class="text-gray-500 text-sm">–ù–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤</p>';
    return;
  }

  const { data: profiles } = await supabase
    .from('rustex_profiles')
    .select('*')
    .in('user_id', Array.from(userIds));

  const { data: unread } = await supabase
    .from('rustex_messages')
    .select('sender_id')
    .eq('receiver_id', currentUser.id)
    .eq('is_read', false);

  const unreadMap = {};
  (unread || []).forEach(m => {
    unreadMap[m.sender_id] = (unreadMap[m.sender_id] || 0) + 1;
  });

  document.getElementById('chatsList').innerHTML = (profiles || []).map(p => `
    <div class="flex items-center gap-3 p-3 rounded-lg cursor-pointer hover:bg-white/5 transition ${currentChatUserId === p.user_id ? 'bg-white/10' : ''}" onclick="openChat('${p.user_id}')">
      <img src="${p.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.username)}&background=cd412b&color=fff`}" class="w-10 h-10 rounded-full">
      <div class="flex-1 min-w-0">
        <div class="font-medium truncate">${escapeHtml(p.username)}</div>
        <div class="text-xs text-gray-400 truncate">üéÆ ${escapeHtml(p.game_nick || '-')}</div>
      </div>
      ${unreadMap[p.user_id] ? `<span class="bg-orange-600 text-white text-xs px-2 py-1 rounded-full">${unreadMap[p.user_id]}</span>` : ''}
    </div>
  `).join('');
}

async function openChat(userId) {
  currentChatUserId = userId;
  loadChats();

  const { data: p } = await supabase
    .from('rustex_profiles')
    .select('*')
    .eq('user_id', userId)
    .single();

  document.getElementById('chatHeader').style.display = 'flex';
  document.getElementById('chatInput').style.display = 'block';
  document.getElementById('chatEmpty').style.display = 'none';

  document.getElementById('chatAvatar').src = p?.avatar_url || 'https://ui-avatars.com/api/?name=U&background=cd412b&color=fff';
  document.getElementById('chatName').textContent = p?.username || 'Unknown';
  document.getElementById('chatNick').textContent = 'üéÆ ' + (p?.game_nick || '-');

  await supabase
    .from('rustex_messages')
    .update({ is_read: true })
    .eq('sender_id', userId)
    .eq('receiver_id', currentUser.id);

  loadMessages();
  checkUnreadMessages();
}

async function loadMessages() {
  if (!currentChatUserId) return;

  const { data } = await supabase
    .from('rustex_messages')
    .select('*')
    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${currentChatUserId}),and(sender_id.eq.${currentChatUserId},receiver_id.eq.${currentUser.id})`)
    .order('created_at');

  const container = document.getElementById('chatMessages');
  container.innerHTML = (data || []).map(m => `
    <div class="chat-message ${m.sender_id === currentUser.id ? 'sent' : 'received'}">
      ${escapeHtml(m.content)}
      <div class="text-xs opacity-60 mt-1">${new Date(m.created_at).toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' })}</div>
    </div>
  `).join('');

  container.scrollTop = container.scrollHeight;
}

async function sendMessage() {
  const input = document.getElementById('messageInput');
  const content = input.value.trim();

  if (!content || !currentChatUserId) return;

  await supabase.from('rustex_messages').insert({
    sender_id: currentUser.id,
    receiver_id: currentChatUserId,
    content
  });

  input.value = '';
  loadMessages();
}

async function startChatWith(userId) {
  if (!currentUser) {
    showModal('loginModal');
    return;
  }

  if (userId === currentUser.id) {
    showToast('‚ùå –ù–µ–ª—å–∑—è –Ω–∞–ø–∏—Å–∞—Ç—å —Å–µ–±–µ', 'error');
    return;
  }

  showPage('messages');
  setTimeout(() => openChat(userId), 100);
}

async function checkUnreadMessages() {
  if (!currentUser) return;

  const { data } = await supabase
    .from('rustex_messages')
    .select('id')
    .eq('receiver_id', currentUser.id)
    .eq('is_read', false);

  const badge = document.getElementById('unreadBadge');
  if (data && data.length > 0) {
    badge.style.display = 'flex';
    badge.textContent = data.length;
  } else {
    badge.style.display = 'none';
  }
}

// ============= –£–¢–ò–õ–ò–¢–´ =============
function showModal(id) {
  hideAllModals();
  document.getElementById(id).classList.add('show');
}

function hideModal(id) {
  document.getElementById(id).classList.remove('show');
}

function hideAllModals() {
  document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
}

function switchModal(id) {
  hideAllModals();
  setTimeout(() => showModal(id), 100);
}

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + type + ' show';
  setTimeout(() => t.classList.remove('show'), 3000);
}

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function formatSocialLink(value, type) {
  if (!value || value === '-') return null;

  if (type === 'telegram') {
    if (value.startsWith('@')) return 'https://t.me/' + value.slice(1);
    if (value.startsWith('http')) return value;
    if (value.startsWith('t.me/')) return 'https://' + value;
    return 'https://t.me/' + value;
  }

  if (type === 'vk') {
    if (value.startsWith('http')) return value;
    if (value.startsWith('@')) return 'https://vk.com/' + value.slice(1);
    if (value.startsWith('vk.com/')) return 'https://' + value;
    return 'https://vk.com/' + value;
  }

  return null;
}

const telegramIcon = '<svg class="w-5 h-5" fill="white" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>';

const vkIcon = '<svg class="w-5 h-5" fill="white" viewBox="0 0 24 24"><path d="M15.684 0H8.316C1.592 0 0 1.592 0 8.316v7.368C0 22.408 1.592 24 8.316 24h7.368C22.408 24 24 22.408 24 15.684V8.316C24 1.592 22.408 0 15.684 0zm3.692 17.123h-1.744c-.66 0-.864-.525-2.05-1.727-1.033-1-1.49-1.135-1.744-1.135-.356 0-.458.102-.458.593v1.575c0 .424-.135.678-1.253.678-1.846 0-3.896-1.118-5.335-3.202C4.624 10.857 4 8.57 4 8.096c0-.254.102-.491.593-.491h1.744c.44 0 .61.203.78.678.863 2.49 2.303 4.675 2.896 4.675.22 0 .322-.102.322-.66V9.721c-.068-1.186-.695-1.287-.695-1.71 0-.203.17-.407.44-.407h2.743c.373 0 .508.203.508.643v3.473c0 .372.17.508.271.508.22 0 .407-.136.814-.542 1.27-1.422 2.18-3.61 2.18-3.61.119-.254.322-.491.763-.491h1.744c.525 0 .644.27.525.643-.22 1.017-2.354 4.031-2.354 4.031-.186.305-.254.44 0 .78.186.254.796.779 1.203 1.253.745.847 1.32 1.558 1.473 2.05.17.49-.085.744-.576.744z"/></svg>';

// ============= –°–û–ë–´–¢–ò–Ø =============
document.querySelectorAll('.modal').forEach(m => {
  m.addEventListener('click', e => {
    if (e.target === m) hideModal(m.id);
  });
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
setInterval(() => {
  if (currentUser) checkUnreadMessages();
}, 10000);

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
setInterval(() => {
  if (currentChatUserId) loadMessages();
}, 5000);

// ============= –°–¢–ê–†–¢ =============
init();
</script>
</body>
</html>

